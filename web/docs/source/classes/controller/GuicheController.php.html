<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/** 
 * @author Alan Cleber Morais Gomes 
 * @version 1.0
 * @copyright UNILAB - Universidade da Integracao Internacional da Lusofonia Afro-Brasileira.
 * @package Controle
 */

/**
 * Classe respons&aacute;vel pela realiza&ccedil;&atilde;o de venda e estorno de cr&eacute;ditos dos usu&aacute;rios.
 */
class GuicheController {
	
	/**
	 * Vari&aacute;vel utilizada para instaciar a classe View.
	 * 
	 * @var GuicheView
	 */
	private $view;
	
	/**
	 * Vari&aacute;vel utilizada para instaciar a classe DAO.
	 * 
	 * @var DAO;
	 */
	private $dao;
	
	/**
	 * Metodo principal utilizada para controlar o acesso a classe atrav&eacute;s do n&iacute;vel de acesso do usuario.
	 *
	 * @param Sessao $nivel
	 *        	Recebe uma Sess&atilde;o que cont&eacute;m o n&iacute;vel de acesso do usuario,
	 *        	esta Sess&atilde;o &eacute; iniciada na p&aacute;gina principal, durante o login do usuario.
	 */
	public static function main($nivel) {
		switch ($nivel) {
			case Sessao::NIVEL_SUPER :
				$controller = new GuicheController ();
				$controller-&gt;telaGuiche ();
				break;
			case Sessao::NIVEL_ADMIN :
				$controller = new GuicheController ();
				$controller-&gt;telaGuiche ();
				break;
			
			case Sessao::NIVEL_POLIVALENTE :
				$controller = new GuicheController ();
				$controller-&gt;telaGuiche ();
				break;
			case Sessao::NIVEL_GUICHE :
				$controller = new GuicheController ();
				$controller-&gt;telaGuiche ();
				break;
			case Sessao::NIVEL_CATRACA_VIRTUAL :
				$controller = new GuicheController ();
				$controller-&gt;telaGuiche ();
				break;
			default :
				UsuarioController::main ( $nivel );
				break;
		}
	}
	
	/**
	 * Nesta fun&ccedil;&atilde;o &eacute; gera a tela Guich&ecirc;,
	 * nela &eacute; realizada a consulta atrav&eacute;s do n&uacute;mero do cart&atilde;o do usu&aacute;rio,
	 * onde s&atilde;o consultados v&iacute;nculo, tipo, cr&eacute;ditos...
	 * O valor do caixa est&aacute; atrelado ao operador, ou seja, cada operador ter&aacute; seu caixa,
	 * n&atilde;o compartilhando valores.
	 *
	 * 1 - A inser&ccedil;&atilde;o dos cr&eacute;ditos se d&aacute; por um segunda valida&ccedil;&atilde;o com o cart&atilde;o do usu&aacute;rio,
	 * para evitar erros provenientes de cookies do navegador.
	 *
	 * 2 - O estorno s&oacute; &eacute; possivel com a autentica&ccedil;&atilde;o do usu&aacute;rio titular do cart&atilde;o,
	 * ou de um operador autorizado a realizar esta opera&ccedil;&atilde;o.
	 *
	 * Nesta classe &eacute; criada vari&aacute;veis de Sess&atilde;o utilizadas na Classe ResumoCompraController.
	 */
	public function telaGuiche() {
		$controller = new GuicheController ();
		$this-&gt;view = new GuicheView ();
		$unidade = new Unidade ();
		$dao = new DAO ();
		$sessao = new Sessao ();
		$idDoUsuario = $sessao-&gt;getIdUsuario ();
		
		// Vari&aacute;veis de sess&atilde;o utilizadas na Classe ResumoCompraController
		$_SESSION ['nome_usuario'] = null;
		$_SESSION ['tipo_usuario'] = null;
		$_SESSION ['valor_inserido'] = null;
		$_SESSION ['novo_saldo'] = null;
		$_SESSION ['transacao'] = null;
		$_SESSION ['cartao'] = null;
		$_SESSION ['saldo_anterior'] = null;
		$_SESSION ['autorizado'] = false;
		
		/*
		 * Preenche a tabela 'Descri&ccedil;&atilde;o da Opera&ccedil;&atilde;o'
		 * apenas com dados das opera&ccedil;&otilde;es realizadas no dia
		 * corrente do operador logado. *
		 */
		
		$dataInicio = date ( 'Y-m-d' );
		$dataFim = date ( 'Y-m-d' );
		
		$data1 = $dataInicio . ' 00:00:00';
		$data2 = $dataFim . ' 23:59:59';
		
		$sqlTransacao = &quot;SELECT cliente.usua_nome cliente,* FROM transacao
		INNER JOIN usuario
		on transacao.usua_id = usuario.usua_id
		INNER JOIN usuario as cliente
		ON cliente.usua_id = transacao.usua_id1
		WHERE (tran_data BETWEEN '$data1' AND '$data2') 
		AND usuario.usua_id = $idDoUsuario ORDER BY tran_id DESC &quot;;
		
		$listaDescricao = $dao-&gt;getConexao ()-&gt;query ( $sqlTransacao );
		$this-&gt;view-&gt;formDescricao ( $listaDescricao );
		
		/*
		 * Soma os campos de valores.
		 */
		$valorTotal = 0;
		$result = $dao-&gt;getConexao ()-&gt;query ( $sqlTransacao );
		foreach ( $result as $linha ) {
			
			$valor = $linha ['tran_valor'];
			floatval ( $valor );
			if ($linha) {
				$valorTotal = $valorTotal + $valor;
			}
		}
		echo '					&lt;h2&gt;Saldo em Caixa: R$ ' . number_format ( $valorTotal, 2, ',', '.' ) . ' &lt;/h1&gt;
							&lt;div class=&quot;sete borda&quot;&gt;';
		
		$sqlUsuario = &quot;SELECT * FROM usuario WHERE usua_id = '$idDoUsuario'&quot;;
		$result = $dao-&gt;getConexao ()-&gt;query ( $sqlUsuario );
		foreach ( $result as $linha ) {
			echo '	&lt;span class=&quot;icone-user&quot;&gt; Operador: ' . ucwords ( strtolower ( htmlentities ( $linha ['usua_nome'] ) ) ) . '&lt;/span&gt;';
		}
		echo '	&lt;/div&gt;
		&lt;/div&gt;';
		
		$this-&gt;view-&gt;formBuscarCartao ();
		
		/*
		 * Realiza a pesquisa pelo numero do cart&atilde;o identificando se existe vinculo ativo.
		 */
		
		if (isset ( $_GET ['cartao'] )) {
			if (strlen ( $_GET ['cartao'] ) &gt; 3) {
				$cartao = new Cartao ();
				$cartao-&gt;setNumero ( $_GET ['cartao'] );
				$numeroCartao = $cartao-&gt;getNumero ();
				@$_SESSION ['cartao'] = $_GET ['cartao'];
				$sqlVerificaNumero = &quot;SELECT * FROM usuario
				INNER JOIN vinculo ON vinculo.usua_id = usuario.usua_id
				LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
				LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id
				WHERE cartao.cart_numero = '$numeroCartao'&quot;;
				$result = $dao-&gt;getConexao ()-&gt;query ( $sqlVerificaNumero );
				$usuario = new Usuario ();
				$idCartao = 0;
				$tipo = new Tipo ();
				$vinculoDao = new VinculoDAO ( $dao-&gt;getConexao () );
				$vinculo = new Vinculo ();
				foreach ( $result as $linha ) {
					$idDoVinculo = $linha ['vinc_id'];
					$tipo-&gt;setNome ( $linha ['tipo_nome'] );
					$tipo-&gt;setValorCobrado ( $linha ['tipo_valor'] );
					$cartao-&gt;setId ( $linha ['cart_id'] );
					$cartao-&gt;setCreditos ( $linha ['cart_creditos'] );
					$usuario-&gt;setNome ( $linha ['usua_nome'] );
					$usuario-&gt;setId ( $linha ['usua_id'] );
					$usuario-&gt;setLogin ( $linha ['usua_login'] );
					$usuario-&gt;setIdBaseExterna ( $linha ['id_base_externa'] );
					$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
					$idCartao = $linha ['cart_id'];
					$avulso = $linha ['vinc_avulso'];
					if ($avulso) {
						$usuario-&gt;setNome ( 'Avulso' );
					}
					break;
				}
				
				if ($idCartao &amp;&amp; $_GET ['cartao'] != '') {
					$idBeneficiado = $usuario-&gt;getId ();
					$vinculo-&gt;setId ( $idDoVinculo );
					$cartao-&gt;setId ( $idCartao );
					$vinculoDao-&gt;vinculoPorId ( $vinculo );
					
					if (! $vinculo-&gt;isActive ()) {
						
						$this-&gt;view-&gt;mensagem ( 'erro', 'O vinculo n&amp;atildeo est&amp;aacute ativo.' );
					} else {
						
						$this-&gt;view-&gt;formConsulta ( $usuario, $tipo, $cartao );
						$this-&gt;view-&gt;formInserirValor ();
						
						$_SESSION ['nome_usuario'] = ucwords ( strtolower ( htmlentities ( $usuario-&gt;getNome () ) ) );
						$_SESSION ['tipo_usuario'] = $tipo-&gt;getNome ();
						$_SESSION ['saldo_anterior'] = $vinculo-&gt;getCartao ()-&gt;getCreditos ();
						
						// $_SESSION['confirmado'] = &quot;aguarde&quot;;
						// $_SESSION['refeicoes_restante'] = &quot;&quot;;
						
						/*
						 * Insere ou estorna os creditos do usuario pesquisado com vinculo ativo.
						 */
						
						if (isset ( $_GET ['valor'] )) {
							
							$cartao-&gt;setCreditos ( $_GET ['valor'] );
							$valorVendido = $cartao-&gt;getCreditos ();
							$login = $usuario-&gt;getLogin ();
							$valorAnt = $vinculo-&gt;getCartao ()-&gt;getCreditos ();
							$valorVendido = $cartao-&gt;getCreditos ();
							$novoValor = $valorAnt + $valorVendido;
							$valor = number_format ( $valorVendido, 2, ',', '.' );
							
							$_SESSION ['valor_inserido'] = $valorVendido;
							$_SESSION ['novo_saldo'] = $novoValor;
							
							if ($valorVendido == 0) {
								$this-&gt;view-&gt;mensagem ( &quot;erro&quot;, &quot;Valor Inv&aacute;lido! Digite novamente.&quot; );
								return;
							}
							
							if ($valorVendido &lt; 0) {
								if ($valorAnt &lt;= 0) {
									echo '&lt;div id=&quot;msgconfirmado&quot;&gt;';
									$this-&gt;view-&gt;mensagem ( &quot;erro&quot;, &quot;Saldo Insuficiente para realizar estorno!&quot; );
									echo '&lt;/div&gt;';
									echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;3; url=.\?pagina=guiche&quot;&gt;';
									return;
								} else if ($novoValor &lt; 0) {
									echo '&lt;div id=&quot;msgconfirmado&quot;&gt;';
									$this-&gt;view-&gt;mensagem ( &quot;erro&quot;, &quot;Saldo Insuficiente para realizar estorno!&quot; );
									echo '&lt;/div&gt;';
									echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;3; url=.\?pagina=guiche&quot;&gt;';
									return;
								}
								$estorno = true;
							} else {
								$this-&gt;view-&gt;mensagem ( &quot;ajuda&quot;, &quot;Deseja inserir R\$ $valor?&quot; );
								$tipoTransacao = 'Venda de Cr&eacute;ditos';
								$tipo = &quot;sucesso&quot;;
								$mensagem = &quot;Valor inserido com sucesso.&quot;;
								$estorno = false;
							}
							
							if ($estorno) {
								echo '	&lt;div id=&quot;mascara&quot;&gt;&lt;/div&gt;
								&lt;div class=&quot;window borda&quot; id=&quot;janela1&quot;&gt;
									&lt;a href=&quot;#&quot; class=&quot;fechar&quot;&gt;X Fechar&lt;/a&gt;
									&lt;h2 class=&quot;titulo&quot;&gt;Por Favor digite sua Senha para confirmar.&lt;/h2&gt;
									&lt;hr class=&quot;um&quot;&gt;
									&lt;form class=&quot;formulario sequencial &quot; method=&quot;post&quot; id=&quot;formIndentificacao&quot;&gt;
										&lt;label&gt;
											Login&lt;input type=&quot;text&quot;  name=&quot;login&quot; value=&quot;' . $login . '&quot; class=&quot;doze&quot;/&gt;
										&lt;/label&gt;
										&lt;label&gt;
											Senha&lt;input type=&quot;password&quot; placeholder=&quot;Senha Sig&quot; name=&quot;senha&quot; class=&quot;doze&quot; autofocus /&gt;
										&lt;/label&gt;
										&lt;input type=&quot;submit&quot; value=&quot;Confirmar&quot; name=&quot;estornar&quot; class=&quot;doze&quot; /&gt;
									&lt;/form&gt;';
								$this-&gt;view-&gt;mensagem ( &quot;erro&quot;, &quot;Deseja estornar R\$ $valor?&quot; );
								echo '	&lt;/div&gt;';
							} else {
								echo ' 	
										&lt;form method=&quot;post&quot; class=&quot;formulario&quot;&gt;
											&lt;input type=&quot;number&quot; name=&quot;confirmar&quot; id=&quot;confirmar&quot;&gt;										
									    &lt;/form&gt;';
								
								if (isset ( $_POST ['confirmar'] ) &amp;&amp; $_POST ['confirmar'] != &quot;&quot;) {
									
									$cartaoConfirma = $_POST ['confirmar'];
									if ($cartaoConfirma == $cartao-&gt;getNumero ()) {
										$autorizado = true;
									} else {
										$this-&gt;view-&gt;mensagem ( &quot;erro&quot;, &quot;N&uacute;mero do cart&atilde;o diferente.&quot; );
										echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;3; url=.\?pagina=guiche&quot;&gt;';
									}
								}
							}
							
							if (isset ( $_POST ['estornar'] )) {
								$usuarioDao = new UsuarioDAO ();
								$usuario2 = new Usuario ();
								$usuario2-&gt;setLogin ( $login = $_POST ['login'] );
								$usuario2-&gt;setSenha ( $senha = $_POST ['senha'] );
								if ($usuarioDao-&gt;autentica ( $usuario2 )) {
									$idUsuario1 = $usuario-&gt;getId ();
									$idUsuario2 = $usuario2-&gt;getId ();
									if ($idUsuario1 == $idUsuario2 || $usuario2-&gt;getNivelAcesso () &gt;= 2) {
										$tipo = &quot;ajuda&quot;;
										$mensagem = &quot;Valor estornado com sucesso!&quot;;
										$tipoTransacao = 'Estorno de valores';
										$autorizado = true;
									} else {
										echo '&lt;div id=&quot;msgconfirmado&quot;&gt;';
										$this-&gt;view-&gt;mensagem ( &quot;erro&quot;, &quot;Este cart&atilde;o n&atilde;o pertence a este usuario!&quot; );
										echo '&lt;/div&gt;';
										echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;3; url=.\?pagina=guiche&quot;&gt;';
									}
								} else {
									echo '&lt;div id=&quot;msgconfirmado&quot;&gt;';
									$this-&gt;view-&gt;mensagem ( &quot;erro&quot;, &quot;Usuario ou Senha Inv&aacute;lidos!&quot; );
									echo '&lt;/div&gt;';
									echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;3; url=.\?pagina=guiche&quot;&gt;';
									return;
								}
							}
							
							if (isset ( $autorizado )) {
								
								$idCartao = $vinculo-&gt;getCartao ()-&gt;getId ();
								$idUsuario = $usuario-&gt;getId ();
								$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
								
								$dao-&gt;getConexao ()-&gt;beginTransaction ();
								
								$sql = &quot;UPDATE cartao set cart_creditos = $novoValor WHERE cart_id = $idCartao&quot;;
								
								$sql2 = &quot;INSERT into transacao(tran_valor, tran_descricao, tran_data, usua_id,usua_id1)
								VALUES($valorVendido, '$tipoTransacao' ,'$dataTimeAtual', $idDoUsuario, $idBeneficiado)&quot;;
								
								// echo $sql;
								if (! $dao-&gt;getConexao ()-&gt;exec ( $sql )) {
									$dao-&gt;getConexao ()-&gt;rollBack ();
									$this-&gt;view-&gt;mensagem ( 'erro', 'Erro ao inserir os creditos.' );
									return false;
								}
								if (! $dao-&gt;getConexao ()-&gt;exec ( $sql2 )) {
									$dao-&gt;getConexao ()-&gt;rollBack ();
									$this-&gt;view-&gt;mensagem ( 'erro', 'Erro ao inserir os creditos.' );
									return false;
								}
								
								$dao-&gt;getConexao ()-&gt;commit ();
								echo '&lt;div id=&quot;msgconfirmado&quot;&gt;';
								$this-&gt;view-&gt;mensagem ( $tipo, $mensagem );
								$_SESSION ['autorizado'] = $autorizado;
								echo '&lt;/div&gt;';
								echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;3; url=.\?pagina=guiche&quot;&gt;';
							}
						}
					}
				} else {
					$_SESSION ['cartao'] = null;
					$this-&gt;view-&gt;mensagem ( 'erro', 'Cart&amp;atildeo sem vinculo v&amp;aacutelido.' );
					echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;3; url=.\?pagina=guiche&quot;&gt;';
				}
			}
		}
	}
}

?&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>