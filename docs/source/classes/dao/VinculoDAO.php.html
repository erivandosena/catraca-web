<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Classe utilizada para conx&atilde;o com o Bando de Dados.
 * @author Jefferson Uchoa Ponte
 * @version 1.0
 * @copyright UNILAB - Universidade da Integracao Internacional da Lusofonia Afro-Brasileira.
 * @package DAO
 */

/**
 * Cadastro de vinculo ser&aacute; feito por dois usuarios diferetnes.
 * Administra&ccedil;&atilde;o ou Guiche. Com suas particularidades.
 *
 * A seguir o cadastro de vinculo pelo usuario administrador.
 *
 * 1- Verifica&ccedil;&atilde;o de Id de usuario de base externa.
 * Esse usuario existe na base local? Captura-se o Id da base local para: $idUsuarioBaseLocal;
 * N&atilde;o existe na base local: Cadastra-se e captura-se o id da base local para: $idUsuarioBaseLocal;
 *
 *
 * 2- Verifica&ccedil;&atilde;o de cart&atilde;o.
 * O cart&atilde;o existe. Verifica se o Tipo cooresponde. Faz UPDATE no tipo. Retorne o seu ID.
 * O cart&atilde;o n&atilde;o existe. Cadastre e Retorne o seu ID.
 *
 *
 *
 * 3 - Verific&atilde;o de vinculos do usuario.
 * - N&atilde;o permitir cadastro de vinculo no usuario se ele tiver vinculo valido.
 * Ter&aacute; que cancelar o vinculo atual. Isto far&aacute; um update na data.
 *
 *
 * 4 - Verifica&ccedil;&atilde;o de vinculos do Cart&atilde;o.
 * - N&atilde;o permitir cadastro de vinculo se o cart&atilde;o tiver vinculo v&aacute;lido.
 *
 *
 * 5 - Adicionar vinculo novo vinculo.
 */
class VinculoDAO extends DAO {
	
	/**
	 * Realiza uma pesquisa atrav&eacute;s do IdBaseExterna do usu&aacute;rio, na base de dados local,
	 * na tabela de usu&aacute;rios, retornando os vinculos v&aacute;lidos do usu&aacute;rio.
	 *
	 * Para que um v&iacute;nculo seja v&aacute;lido, &eacute; preciso que a Data de Validade do Vinculo seja maior que a Data e Hora Corrente,
	 * caso contr&aacute;rio ser&aacute; necess&aacute;rio renovar, se for poss&iacute;vel.
	 *
	 * @param Usuario $usuario
	 *        	Objeto Usuario contendo IdBaseExterna.
	 * @return Vinculo[] Array com os Vinculos v&aacute;lidos do Usuario pesuisado.
	 */
	public function retornaVinculosValidosDeUsuario(Usuario $usuario) {
		$lista = array ();
		$idUsuario = $usuario-&gt;getIdBaseExterna ();
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		$sql = &quot;SELECT * FROM usuario INNER JOIN vinculo
				ON vinculo.usua_id = usuario.usua_id
				LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
				LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id WHERE (usuario.id_base_externa = $idUsuario)
				AND ('$dataTimeAtual' BETWEEN vinc_inicio AND vinc_fim)&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		foreach ( $result as $linha ) {
			$vinculo = new Vinculo ();
			$vinculo-&gt;setResponsavel ( $usuario );
			
			$vinculo-&gt;setCartao ( new Cartao () );
			$vinculo-&gt;setId ( $linha ['vinc_id'] );
			$vinculo-&gt;getCartao ()-&gt;setTipo ( new Tipo () );
			$vinculo-&gt;getCartao ()-&gt;setId ( $linha ['cart_id'] );
			$vinculo-&gt;getCartao ()-&gt;setCreditos ( $linha ['cart_creditos'] );
			$vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;setNome ( $linha ['tipo_nome'] );
			$vinculo-&gt;getCartao ()-&gt;setNumero ( $linha ['cart_numero'] );
			$vinculo-&gt;setInicioValidade ( $linha ['vinc_inicio'] );
			$vinculo-&gt;setFinalValidade ( $linha ['vinc_fim'] );
			$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
			$vinculo-&gt;setDescricao ( $linha ['vinc_descricao'] );
			
			$lista [] = $vinculo;
		}
		return $lista;
	}
	
	/**
	 * Lista todos os V&iacute;nculos Vencidos do Usu&aacute;rio pesquisado.
	 * O V&iacute;nculo estar&aacute; vencido quando a Data e Hora Corrente for maior que a Data de Vencimento.
	 *
	 * @param Usuario $usuario
	 *        	Objeto Usuario contendo IdBaseExterna.
	 * @return Vinculo[]
	 */
	public function retornaVinculosVencidos(Usuario $usuario) {
		$lista = array ();
		$idUsuario = $usuario-&gt;getIdBaseExterna ();
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		$sql = &quot;SELECT * FROM usuario INNER JOIN vinculo
		ON vinculo.usua_id = usuario.usua_id
		LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
		LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id WHERE (usuario.id_base_externa = $idUsuario)
		AND ('$dataTimeAtual' &gt; vinc_fim)&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		
		foreach ( $result as $linha ) {
			$vinculo = new Vinculo ();
			$vinculo-&gt;setResponsavel ( $usuario );
			$vinculo-&gt;setCartao ( new Cartao () );
			$vinculo-&gt;setId ( $linha ['vinc_id'] );
			$vinculo-&gt;getCartao ()-&gt;setCreditos ( $linha ['cart_creditos'] );
			$vinculo-&gt;getCartao ()-&gt;setTipo ( new Tipo () );
			$vinculo-&gt;getCartao ()-&gt;setId ( $linha ['cart_id'] );
			$vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;setNome ( $linha ['tipo_nome'] );
			$vinculo-&gt;getCartao ()-&gt;setNumero ( $linha ['cart_numero'] );
			$vinculo-&gt;setInicioValidade ( $linha ['vinc_inicio'] );
			$vinculo-&gt;setFinalValidade ( $linha ['vinc_fim'] );
			$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
			$lista [] = $vinculo;
		}
		return $lista;
	}
	
	/**
	 * 
	 * @param Usuario $usuario
	 *        	Objeto Usuario contendo IdBaseExterna.
	 */
	public function retornaVinculosFuturos(Usuario $usuario) {
		$lista = array ();
		$idUsuario = $usuario-&gt;getIdBaseExterna ();
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		$sql = &quot;SELECT * FROM usuario INNER JOIN vinculo
		ON vinculo.usua_id = usuario.usua_id
		LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
		LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id WHERE (usuario.id_base_externa = $idUsuario)
		AND ('$dataTimeAtual' &lt; vinc_fim AND '$dataTimeAtual' &lt; vinc_inicio)&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		
		foreach ( $result as $linha ) {
			$vinculo = new Vinculo ();
			$vinculo-&gt;setResponsavel ( $usuario );
			$vinculo-&gt;setCartao ( new Cartao () );
			$vinculo-&gt;setId ( $linha ['vinc_id'] );
			$vinculo-&gt;getCartao ()-&gt;setTipo ( new Tipo () );
			$vinculo-&gt;getCartao ()-&gt;setId ( $linha ['cart_id'] );
			$vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;setNome ( $linha ['tipo_nome'] );
			$vinculo-&gt;getCartao ()-&gt;setNumero ( $linha ['cart_numero'] );
			$vinculo-&gt;setInicioValidade ( $linha ['vinc_inicio'] );
			$vinculo-&gt;setFinalValidade ( $linha ['vinc_fim'] );
			$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
			$lista [] = $vinculo;
		}
		return $lista;
	}
	
	/**
	 * Torna inv&aacute;lido o vinculo do Cart&atilde;o.
	 *
	 * Neste caso o campo vinc_fim ou isen_fim(no caso de isen&ccedil;&atilde;o) ser&aacute; atualizado com a Data e Hora Corrente,
	 * tornando o v&iacute;nculo inv&aacute;lido, pois o Vencimento ser&aacute; menor que a Data e Hora atuais.
	 *
	 * @param Vinculo $vinculo        	
	 * @return boolean
	 */
	public function invalidarVinculo(Vinculo $vinculo) {
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		
		if ($vinculo-&gt;getId ()) {
			$idVinculo = $vinculo-&gt;getId ();
			$idIsencao = $vinculo-&gt;getIsencao ()-&gt;getId ();
			$sql = &quot;UPDATE isencao set isen_fim = '$dataTimeAtual' WHERE isen_id = $idIsencao&quot;;
			$this-&gt;getConexao ()-&gt;exec ( $sql );
		}
		
		$sql = &quot;UPDATE vinculo set vinc_fim = '$dataTimeAtual' WHERE vinc_id = $idVinculo&quot;;
		if ($this-&gt;getConexao ()-&gt;exec ( $sql ))
			return true;
		return false;
	}
	
	/**
	 * Torna um vinculo insento inv&aacute;lido.
	 *
	 * Neste caso o campo isen_fim ser&aacute; atualizado com a Data e Hora Corrente,
	 * tornando o v&iacute;nculo inv&aacute;lido, pois o Vencimento ser&aacute; menor que a Data e Hora atuais.
	 *
	 * @param Vinculo $vinculo        	
	 * @return boolean
	 */
	public function invalidarIsencaoVinculo(Vinculo $vinculo) {
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		$idIsencao = $vinculo-&gt;getIsencao ()-&gt;getId ();
		$sql = &quot;UPDATE isencao set isen_fim = '$dataTimeAtual' WHERE isen_id = $idIsencao&quot;;
		if ($this-&gt;getConexao ()-&gt;exec ( $sql ))
			return true;
		else
			return false;
	}
	
	/**
	 * Adiciona um vinculo isento ao cart&atilde;o,
	 * &Eacute; verificado se o cart&atilde;o j&aacute; possui um vinculo v&aacute;lido.
	 *
	 * @param Vinculo $vinculo        	
	 */
	public function adicionarIsencaoNoVinculo(Vinculo $vinculo) {
		$idCartao = $vinculo-&gt;getCartao ()-&gt;getId ();
		$inicio = $vinculo-&gt;getIsencao ()-&gt;getDataDeInicio ();
		$fim = $vinculo-&gt;getIsencao ()-&gt;getDataFinal ();
		if (! $vinculo-&gt;isActive ()) {
			return false;
		}
		$tempoA = strtotime ( $vinculo-&gt;getIsencao ()-&gt;getDataDeInicio () );
		$tempoB = strtotime ( $vinculo-&gt;getIsencao ()-&gt;getDataFinal () );
		$tempoAgora = time ();
		// N&atilde;o adicionar isen&ccedil;&atilde;o para o passado.
		if ($tempoA &lt; strtotime ( &quot;-1 days&quot; )) {
			echo '&lt;p&gt;N&atilde;o &eacute; poss&iacute;vel adicionar isen&ccedil;&atilde;o para o passado&lt;/p&gt;';
			return false;
		}
		// N&atilde;o adicionar caso o usu&aacute;rio inverta as datas.
		if ($tempoB &lt;= $tempoA) {
			echo '&lt;p&gt;Talvez voc&ecirc; tenha trocado as datas. &lt;/p&gt;';
			return false;
		}
		$sql = &quot;INSERT into isencao(isen_inicio,isen_fim,cart_id) VALUES('$inicio', '$fim', $idCartao)&quot;;
		if ($this-&gt;getConexao ()-&gt;exec ( $sql ))
			return true;
		return false;
	}
	
	/**
	 * 	
	 * @ignore
	 *
	 * @param Vinculo $vinculo        	
	 * @param unknown $valorVendido        	
	 * @param unknown $idUsuario        	
	 */
	public function adicionarCreditos(Vinculo $vinculo, $valorVendido, $idUsuario) {
		$novoValor = $vinculo-&gt;getCartao ()-&gt;getCreditos ();
		$idCartao = $vinculo-&gt;getCartao ()-&gt;getId ();
		$valorVendido = floatval ( $valorVendido );
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		
		$sql = &quot;UPDATE cartao set cart_creditos = $novoValor WHERE cart_id = $idCartao&quot;;
		
		$sql2 = &quot;INSERT into transacao(tran_valor, tran_descricao, tran_data, usua_id) 
				VALUES($valorVendido, 'Venda de Cr&eacute;ditos','$dataTimeAtual', $idUsuario)&quot;;
		$this-&gt;getConexao ()-&gt;beginTransaction ();
		
		// echo $sql;
		if (! $this-&gt;getConexao ()-&gt;exec ( $sql )) {
			$this-&gt;getConexao ()-&gt;rollBack ();
			return false;
		}
		if (! $this-&gt;getConexao ()-&gt;exec ( $sql2 )) {
			$this-&gt;getConexao ()-&gt;rollBack ();
			return false;
		}
		$this-&gt;getConexao ()-&gt;commit ();
		return true;
	}
	
	/**
	 * Consulta um vinculo atrav&eacute;s do Id do vinculo.
	 *
	 * @param Vinculo $vinculo
	 *        	Objeto Vinculo contendo Id do Vinculo.
	 * @return Vinculo
	 */
	public function vinculoPorId(Vinculo $vinculo) {
		$idVinculo = $vinculo-&gt;getId ();
		$sql = &quot;SELECT * FROM vinculo
		INNER JOIN usuario ON vinculo.usua_id = usuario.usua_id
		LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
		LEFT JOIN vinculo_tipo ON vinculo.vinc_id = vinculo_tipo.vinc_id
		LEFT JOIN tipo ON vinculo_tipo.tipo_id = tipo.tipo_id
		WHERE vinculo.vinc_id = $idVinculo&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		foreach ( $result as $linha ) {
			$vinculo-&gt;getResponsavel ()-&gt;setNome ( $linha ['usua_nome'] );
			$vinculo-&gt;getResponsavel ()-&gt;setId ( $linha ['usua_id'] );
			$vinculo-&gt;getResponsavel ()-&gt;setIdBaseExterna ( $linha ['id_base_externa'] );
			$vinculo-&gt;getCartao ()-&gt;setId ( $linha ['cart_id'] );
			$vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;setNome ( $linha ['tipo_nome'] );
			$vinculo-&gt;getCartao ()-&gt;setNumero ( $linha ['cart_numero'] );
			$vinculo-&gt;getCartao ()-&gt;setCreditos ( $linha ['cart_creditos'] );
			$vinculo-&gt;setInicioValidade ( $linha ['vinc_inicio'] );
			$vinculo-&gt;setFinalValidade ( $linha ['vinc_fim'] );
			$vinculo-&gt;getResponsavel ()-&gt;setNivelAcesso ( $linha ['usua_nivel'] );
			$vinculo-&gt;setQuantidadeDeAlimentosPorTurno ( $linha ['vinc_refeicoes'] );
			$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
			return $vinculo;
		}
	}
	
	/**
	 * Consulta Vinculo Insento V&aacute;lido.
	 *
	 * @param Vinculo $vinculo        	
	 */
	public function isencaoValidaDoVinculo(Vinculo $vinculo) {
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		$idVinculo = $vinculo-&gt;getId ();
		$sql = &quot;SELECT * FROM vinculo
		LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
		INNER JOIN isencao ON cartao.cart_id = isencao.cart_id
		WHERE (vinculo.vinc_id = $idVinculo) AND  ('$dataTimeAtual' &lt; isencao.isen_fim);&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		foreach ( $result as $linha ) {
			if (isset ( $linha ['isen_id'] )) {
				$vinculo-&gt;setIsencao ( new Isencao () );
				$vinculo-&gt;setIsento ( true );
				$vinculo-&gt;getIsencao ()-&gt;setId ( $linha ['isen_id'] );
				$vinculo-&gt;getIsencao ()-&gt;setDataDeInicio ( $linha ['isen_inicio'] );
				$vinculo-&gt;getIsencao ()-&gt;setDataFinal ( $linha ['isen_fim'] );
			}
			return $vinculo;
		}
	}
	
	/**
	 * Consulta o vinculo v&aacute;lido do cart&atilde;o.
	 *
	 * @param Cartao $cartao        	
	 */
	public function retornaVinculosValidosDeCartao(Cartao $cartao) {
		$lista = array ();
		$idCartao = $cartao-&gt;getId ();
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		$sql = &quot;SELECT * FROM usuario INNER JOIN vinculo
		ON vinculo.usua_id = usuario.usua_id
		LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
		LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id
		WHERE (cartao.cart_id = $idCartao)
		AND ('$dataTimeAtual' BETWEEN vinc_inicio AND vinc_fim)&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		
		foreach ( $result as $linha ) {
			$vinculo = new Vinculo ();
			$vinculo-&gt;setId ( $linha ['vinc_id'] );
			$vinculo-&gt;getResponsavel ()-&gt;setNome ( $linha ['usua_nome'] );
			$vinculo-&gt;getResponsavel ()-&gt;setIdBaseExterna ( $linha ['id_base_externa'] );
			$vinculo-&gt;getCartao ()-&gt;setId ( $linha ['cart_id'] );
			$vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;setNome ( $linha ['tipo_nome'] );
			$vinculo-&gt;getCartao ()-&gt;setNumero ( $linha ['cart_numero'] );
			$vinculo-&gt;setInicioValidade ( $linha ['vinc_inicio'] );
			$vinculo-&gt;setFinalValidade ( $linha ['vinc_fim'] );
			$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
			$lista [] = $vinculo;
		}
		return $lista;
	}
	
	/**
	 * 
	 * @param Cartao $cartao        	
	 */
	public function retornaVinculoValidoDeCartao(Cartao $cartao) {
		$idCartao = $cartao-&gt;getId ();
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		$sql = &quot;SELECT * FROM usuario INNER JOIN vinculo
		ON vinculo.usua_id = usuario.usua_id
		LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
		LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id
		WHERE (cartao.cart_id = $idCartao)
		AND ('$dataTimeAtual' BETWEEN vinc_inicio AND vinc_fim)&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		$vinculo = NULL;
		foreach ( $result as $linha ) {
			$vinculo = new Vinculo ();
			$vinculo-&gt;setId ( $linha ['vinc_id'] );
			$vinculo-&gt;setQuantidadeDeAlimentosPorTurno ( $linha ['vinc_refeicoes'] );
			$vinculo-&gt;getResponsavel ()-&gt;setNome ( $linha ['usua_nome'] );
			$vinculo-&gt;getResponsavel ()-&gt;setIdBaseExterna ( $linha ['id_base_externa'] );
			$vinculo-&gt;getCartao ()-&gt;setId ( $linha ['cart_id'] );
			$vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;setNome ( $linha ['tipo_nome'] );
			$vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;setValorCobrado ( $linha ['tipo_valor'] );
			$vinculo-&gt;getCartao ()-&gt;setNumero ( $linha ['cart_numero'] );
			$vinculo-&gt;setInicioValidade ( $linha ['vinc_inicio'] );
			$vinculo-&gt;setFinalValidade ( $linha ['vinc_fim'] );
			$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
		}
		return $vinculo;
	}
	
	/**
	 * Consulta os vinculos do Cart&atilde;o.
	 *
	 * @param Cartao $cartao        	
	 * @return Vinculo[]
	 */
	public function retornaVinculosVencidosDeCartao(Cartao $cartao) {
		$lista = array ();
		$idCartao = $cartao-&gt;getId ();
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		$sql = &quot;SELECT * FROM usuario INNER JOIN vinculo
		ON vinculo.usua_id = usuario.usua_id
		LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
		LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id
		WHERE (cartao.cart_id = $idCartao)
		AND ('$dataTimeAtual' &gt; vinc_fim)&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		
		foreach ( $result as $linha ) {
			$vinculo = new Vinculo ();
			$vinculo-&gt;setId ( $linha ['vinc_id'] );
			$vinculo-&gt;getResponsavel ()-&gt;setNome ( $linha ['usua_nome'] );
			$vinculo-&gt;getResponsavel ()-&gt;setIdBaseExterna ( $linha ['id_base_externa'] );
			$vinculo-&gt;getCartao ()-&gt;setId ( $linha ['cart_id'] );
			$vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;setNome ( $linha ['tipo_nome'] );
			$vinculo-&gt;getCartao ()-&gt;setNumero ( $linha ['cart_numero'] );
			$vinculo-&gt;setInicioValidade ( $linha ['vinc_inicio'] );
			$vinculo-&gt;setFinalValidade ( $linha ['vinc_fim'] );
			$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
			$lista [] = $vinculo;
		}
		return $lista;
	}
	
	/**
	 * 
	 * @param Cartao $cartao        	
	 */
	public function retornaVinculosFuturosDeCartao(Cartao $cartao) {
		$lista = array ();
		$idCartao = $cartao-&gt;getId ();
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		$sql = &quot;SELECT * FROM usuario INNER JOIN vinculo
		ON vinculo.usua_id = usuario.usua_id
		LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
		LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id
		WHERE (cartao.cart_id = $idCartao)
		AND ('$dataTimeAtual' &lt; vinc_inicio AND '$dataTimeAtual' &lt; vinc_fim)&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		
		foreach ( $result as $linha ) {
			$vinculo = new Vinculo ();
			$vinculo-&gt;setId ( $linha ['vinc_id'] );
			$vinculo-&gt;getResponsavel ()-&gt;setNome ( $linha ['usua_nome'] );
			$vinculo-&gt;getResponsavel ()-&gt;setIdBaseExterna ( $linha ['id_base_externa'] );
			$vinculo-&gt;getCartao ()-&gt;setId ( $linha ['cart_id'] );
			$vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;setNome ( $linha ['tipo_nome'] );
			$vinculo-&gt;getCartao ()-&gt;setNumero ( $linha ['cart_numero'] );
			$vinculo-&gt;setInicioValidade ( $linha ['vinc_inicio'] );
			$vinculo-&gt;setFinalValidade ( $linha ['vinc_fim'] );
			$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
			$lista [] = $vinculo;
		}
		return $lista;
	}
	
	/**
	 * Realiza a atualiza&ccedil;&atilde;o da validade do vinculo,
	 * Aqui &eacute; realizado a atualiza&ccedil;&atilde;o do campo vinc_fim com a Data e Hora atual acrescida de 3 meses.
	 *
	 * @param Vinculo $vinculo        	
	 */
	public function atualizaValidade(Vinculo $vinculo) {
		$data = $vinculo-&gt;getFinalValidade ();
		$idVinculo = $vinculo-&gt;getId ();
		
		if (! $idVinculo)
			return false;
		
		$sqlUpdate = &quot;UPDATE vinculo set vinc_fim = '$data' WHERE vinc_id = $idVinculo&quot;;
		if ($this-&gt;getConexao ()-&gt;exec ( $sqlUpdate ))
			return true;
		return false;
	}
	
	/**
	 * Consulta se o Usu&aacute;rio pesuisado j&aacute; possui vinculo v&aacute;lido.
	 * Caso possua v&iacute;nculo, ser&aacute; retornado True.
	 * 
	 * @param Usuario $usuario
	 * @return boolean    	
	 */
	public function usuarioJaTemVinculo(Usuario $usuario) {
		$idBaseExterna = $usuario-&gt;getIdBaseExterna ();
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		$sql = &quot;SELECT * FROM usuario INNER JOIN vinculo
		ON vinculo.usua_id = usuario.usua_id
		LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
		LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id WHERE (usuario.id_base_externa = $idBaseExterna)
		AND ('$dataTimeAtual' BETWEEN vinc_inicio AND vinc_fim) AND vinc_avulso = FALSE&quot;;
		// echo $sql;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		foreach ( $result as $linha ) {			
			return true;
		}
		return false;
	}
	
	/**
	 * Est&aacute; fun&ccedil;&atilde;o cria um vinculo v&aacute;lido para o usu&aacute;rio.
	 * 
	 * @param Vinculo $vinculo        	
	 */
	public function adicionaVinculo(Vinculo $vinculo) {
		$inicio = $vinculo-&gt;getInicioValidade ();
		$usuarioBaseExterna = $vinculo-&gt;getResponsavel ()-&gt;getIdBaseExterna ();
		$numeroCartao = $vinculo-&gt;getCartao ()-&gt;getNumero ();
		$dataDeValidade = $vinculo-&gt;getFinalValidade ();
		$tipoCartao = $vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;getId ();
		$this-&gt;verificarUsuario ( $vinculo-&gt;getResponsavel () );
		if ($vinculo-&gt;invalidoParaAdicionar ()) {
			return false;
		}
		if (! $vinculo-&gt;getResponsavel ()-&gt;getId ()) {
			// echo 'Veio daqui oh';
			return false;
		}
		
		$idBaseLocal = $vinculo-&gt;getResponsavel ()-&gt;getId ();
		$this-&gt;verificaCartao ( $vinculo-&gt;getCartao () );
		if (! $vinculo-&gt;getCartao ()-&gt;getId ())
			return false;
		$idCartao = $vinculo-&gt;getCartao ()-&gt;getId ();
		$refeicoes = $vinculo-&gt;getQuantidadeDeAlimentosPorTurno ();
		$descricao = $vinculo-&gt;getDescricao ();
		$this-&gt;getConexao ()-&gt;beginTransaction ();
		
		if ($vinculo-&gt;isAvulso ())
			$sqlInsertVinculo = &quot;INSERT INTO vinculo(usua_id, cart_id, vinc_refeicoes, vinc_avulso, vinc_inicio, vinc_fim, vinc_descricao) VALUES($idBaseLocal, $idCartao, $refeicoes,TRUE,'$inicio', '$dataDeValidade', '$descricao')&quot;;
		else
			$sqlInsertVinculo = &quot;INSERT INTO vinculo(usua_id, cart_id, vinc_refeicoes, vinc_avulso, vinc_inicio, vinc_fim, vinc_descricao) VALUES($idBaseLocal, $idCartao, 1,FALSE,'$inicio', '$dataDeValidade', 'Padr&atilde;o')&quot;;
		if (! $this-&gt;getConexao ()-&gt;exec ( $sqlInsertVinculo )) {
			$this-&gt;getConexao ()-&gt;rollBack ();
			return 0;
		}
		$idVinculo = $this-&gt;getConexao ()-&gt;lastInsertId ( 'vinculo_vinc_id_seq' );
		if (! $this-&gt;getConexao ()-&gt;exec ( &quot;INSERT INTO vinculo_tipo(vinc_id, tipo_id) VALUES($idVinculo, $tipoCartao)&quot; )) {
			$this-&gt;getConexao ()-&gt;rollBack ();
			return 0;
		}
		$this-&gt;getConexao ()-&gt;commit ();
		return true;
	}
	
	/**
	 * Retorna true se o cart&atilde;o possuir vinculo v&aacute;lido.
	 *
	 * Retorna false se o cart&atilde;o n&atilde;o possui um vinculo v&aacute;lido.
	 *
	 * @param Cartao $cartao        	
	 * @return boolean
	 */
	public function cartaoTemVinculo(Cartao $cartao) {
		$numero = $cartao-&gt;getNumero ();
		
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		$sql = &quot;SELECT * FROM vinculo
		LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
		WHERE (cartao.cart_numero = '$numero') LIMIT 1&quot;;
		$resultSet = $this-&gt;getConexao ()-&gt;query ( $sql );
		foreach ( $resultSet as $linha ) {
			$cartao-&gt;setId ( $linha ['cart_id'] );
			return true;
		}
		return false;
	}
	
	/**
	 * Atrav&eacute;s de um numero de cart&atilde;o iremos retornar seu verdadeiro ID.
	 *
	 * Mas antes iremos alterar seu tipo.
	 *
	 * Caso ele nem exista a gente cadastra com o tipo oferecido aqui.
	 *
	 * @param Cartao $cartao
	 */
	public function verificaCartao(Cartao $cartao) {
		$numeroCartao = $cartao-&gt;getNumero ();
		$idTipo = $cartao-&gt;getTipo ()-&gt;getId ();
		
		$result = $this-&gt;getConexao ()-&gt;query ( &quot;SELECT * FROM cartao WHERE cart_numero = '$numeroCartao'&quot; );
		foreach ( $result as $linha ) {
			// if($linha['cart_creditos'] &gt; 0)
			// return false;
			if ($linha ['tipo_id'] != $idTipo) {
				if (! $this-&gt;getConexao ()-&gt;exec ( &quot;UPDATE cartao set tipo_id = $idTipo WHERE cart_numero = '$numeroCartao'&quot; ))
					return false;
			}
			$cartao-&gt;getTipo ()-&gt;setId ( $linha ['tipo_id'] );
			$cartao-&gt;setId ( $linha ['cart_id'] );
			return $linha ['cart_id'];
		}
		if ($this-&gt;getConexao ()-&gt;query ( &quot;INSERT INTO cartao(cart_numero, cart_creditos, tipo_id) VALUES('$numeroCartao', 0, $idTipo)&quot; )) {
			foreach ( $this-&gt;getConexao ()-&gt;query ( &quot;SELECT * FROM cartao WHERE cart_numero = '$numeroCartao'&quot; ) as $otraLinha ) {
				$cartao-&gt;setId ( $otraLinha ['cart_id'] );
				return $otraLinha ['cart_id'];
			}
		}
		return false;
	}
	
	/**
	 * Vamos pegar da base exter a ecopiar para a base local.
	 * Se Nem existir na base externa, &Eacute; o usuario frescando. Preciso dar nem resposta pra ele. Aborto tudo logo.
	 * Fa�amos um insert aqui.
	 * Apos esse insert iremos pegar o id inserido na base e retornalo.
	 * Retorna 0, deu nada certo. Essa parada acaba aqui.
	 *
	 * @param Usuario $usuario        	
	 * @return int
	 */
	public function verificarUsuario(Usuario $usuario) {
		$idBaseExterna = $usuario-&gt;getIdBaseExterna ();
		
		$result = $this-&gt;getConexao ()-&gt;query ( &quot;SELECT id_base_externa, usua_id FROM usuario WHERE id_base_externa = $idBaseExterna&quot; );
		foreach ( $result as $linha ) {
			$usuario-&gt;setId ( $linha ['usua_id'] );
			
			return $linha ['usua_id'];
		}
		$result2 = $this-&gt;getConexao ()-&gt;query ( &quot;SELECT * FROM vw_usuarios_autenticacao_catraca WHERE id_usuario = $idBaseExterna&quot; );
		foreach ( $result2 as $linha ) {
			
			$nivel = Sessao::NIVEL_COMUM;
			$nome = $linha ['nome'];
			$nome = preg_replace ( '/[^a-zA-Z0-9\s]/', '', $nome );
			$nome = strtoupper ( $nome );
			$email = $linha ['email'];
			$login = $linha ['login'];
			$senha = $linha ['senha'];
			$idBaseExterna = $linha ['id_usuario'];
			$sqlInserir = &quot;INSERT into usuario(usua_login,usua_senha, usua_nome,usua_email, usua_nivel, id_base_externa)
					VALUES	('$login', '$senha', '$nome','$email', $nivel, $idBaseExterna)&quot;;
			
			// echo $sqlInserir;
			if ($this-&gt;getConexao ()-&gt;exec ( $sqlInserir )) {
				
				foreach ( $this-&gt;getConexao ()-&gt;query ( &quot;SELECT * FROM usuario WHERE id_base_externa = $idBaseExterna&quot; ) as $linha3 ) {
					$usuario-&gt;setId ( $linha3 ['usua_id'] );
					
					return $linha3 ['usua_id'];
				}
			}
		}
		return 0;
	}
	
	/**
	 * @param DateTime $dataReferencia        	
	 * @param string $nomeUsuario        	
	 */
	public function isencoesValidas($dataReferencia = null, $nomeUsuario = null) {
		$lista = array ();
		
		if ($dataReferencia == null)
			$dataReferencia = date ( &quot;Y-m-d G:i:s&quot; );
		$outroFiltro = &quot;&quot;;
		if ($nomeUsuario != null) {
			$nomeUsuario = preg_replace ( '/[^a-zA-Z0-9\s]/', '', $nomeUsuario );
			$nomeUsuario = strtoupper ( $nomeUsuario );
			$outroFiltro = &quot;AND usua_nome LIKE '%$nomeUsuario%'&quot;;
		}
		
		$sql = &quot;SELECT * FROM usuario INNER JOIN vinculo
		ON vinculo.usua_id = usuario.usua_id
		LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
		LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id
		INNER JOIN isencao ON cartao.cart_id = isencao.cart_id
		WHERE ('$dataReferencia' BETWEEN vinc_inicio AND vinc_fim) AND ('$dataReferencia' BETWEEN isen_inicio AND isen_fim) $outroFiltro LIMIT 100&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		foreach ( $result as $linha ) {
			
			$vinculo = new Vinculo ();
			$vinculo-&gt;setId ( $linha ['vinc_id'] );
			$vinculo-&gt;getCartao ()-&gt;setTipo ( new Tipo () );
			$vinculo-&gt;getResponsavel ()-&gt;setId ( $linha ['usua_id'] );
			$vinculo-&gt;getResponsavel ()-&gt;setNome ( $linha ['usua_nome'] );
			
			$vinculo-&gt;getResponsavel ()-&gt;setIdBaseExterna ( $linha ['id_base_externa'] );
			$vinculo-&gt;getCartao ()-&gt;setId ( $linha ['cart_id'] );
			$vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;setNome ( $linha ['tipo_nome'] );
			$vinculo-&gt;getCartao ()-&gt;setNumero ( $linha ['cart_numero'] );
			$vinculo-&gt;setInicioValidade ( $linha ['vinc_inicio'] );
			$vinculo-&gt;setFinalValidade ( $linha ['vinc_fim'] );
			$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
			$lista [] = $vinculo;
		}
		return $lista;
	}
	
	/**
	 *
	 * @param DateTime $dataReferencia        	
	 * @param string $nomeUsuario        	
	 */
	public function buscaVinculos($dataReferencia = null, $nomeUsuario = null) {
		$lista = array ();
		
		if ($dataReferencia == null)
			$dataReferencia = date ( &quot;Y-m-d G:i:s&quot; );
		$outroFiltro = &quot;&quot;;
		if ($nomeUsuario != null) {
			$nomeUsuario = preg_replace ( '/[^a-zA-Z0-9\s]/', '', $nomeUsuario );
			$nomeUsuario = strtoupper ( $nomeUsuario );
			$outroFiltro = &quot;AND usua_nome LIKE '%$nomeUsuario%'&quot;;
		}
		
		$sql = &quot;SELECT * FROM usuario INNER JOIN vinculo
		ON vinculo.usua_id = usuario.usua_id
		LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
		LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id
		
		WHERE '$dataReferencia' BETWEEN vinc_inicio AND vinc_fim  $outroFiltro LIMIT 100&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		foreach ( $result as $linha ) {
			
			$vinculo = new Vinculo ();
			$vinculo-&gt;setId ( $linha ['vinc_id'] );
			$vinculo-&gt;getCartao ()-&gt;setTipo ( new Tipo () );
			$vinculo-&gt;getResponsavel ()-&gt;setId ( $linha ['usua_id'] );
			$vinculo-&gt;getResponsavel ()-&gt;setNome ( $linha ['usua_nome'] );
			$vinculo-&gt;getResponsavel ()-&gt;setIdBaseExterna ( $linha ['id_base_externa'] );
			$vinculo-&gt;getCartao ()-&gt;setId ( $linha ['cart_id'] );
			$vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;setNome ( $linha ['tipo_nome'] );
			$vinculo-&gt;getCartao ()-&gt;setNumero ( $linha ['cart_numero'] );
			$vinculo-&gt;setInicioValidade ( $linha ['vinc_inicio'] );
			$vinculo-&gt;setFinalValidade ( $linha ['vinc_fim'] );
			$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
			$lista [] = $vinculo;
		}
		return $lista;
	}
}

?&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>