<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Classe utilizada para conx&atilde;o com o Bando de Dados.
 * @author Jefferson Uchoa Ponte
 * @version 1.0
 * @copyright UNILAB - Universidade da Integracao Internacional da Lusofonia Afro-Brasileira.
 * @package DAO
 */
/**
 * 
 * UnidadeDAO altera&ccedil;&otilde;es do banco de dados referentes &agrave; entidade Usu&aacute;rio.
 * Gera pesistencia da classe Usu&aacute;rio.
 *
 */
class UsuarioDAO extends DAO {
		
	/**
	 * Vamos verificar dois bancos. 
	 * Primeiro no Banco Local. Se ele n&atilde;o existir olhamos no SIG. 
	 * Se existir no SIG copiamos para o local com n&iacute;vel Default. 
	 * @param Usuario $usuario
	 * @return boolean
	 */
	public function autentica(Usuario $usuario) {
		
		/*
		 * Primeiro vou verificar no banco local . 
		 * Deu certo?
		 * Define nivel na session e deixa o cara logado. 
		 * 
		 */		
		$login = $usuario-&gt;getLogin ();
		$senha = md5 ( $usuario-&gt;getSenha () );
		$sql = &quot;SELECT * FROM usuario WHERE usua_login ='$login' AND usua_senha = '$senha' LIMIT 1&quot;;
		
		foreach ( $this-&gt;getConexao ()-&gt;query ( $sql ) as $linha ) {
			$usuario-&gt;setLogin ( $linha ['usua_login'] );
			$usuario-&gt;setId ( $linha ['usua_id'] );
			$usuario-&gt;setNivelAcesso ( $linha ['usua_nivel'] );
			return true;
		}
		//N&atilde;o deu. 
		//Vou verificar na base do SIG. 
		$result2 = 	$this-&gt;getConexao()-&gt;query(&quot;SELECT * FROM vw_usuarios_autenticacao_catraca WHERE login ='$login' AND senha = '$senha' LIMIT 1&quot;);
		foreach($result2 as $linha){
			
			//Se eu to procurando aqui &eacute; pq houve algo errado no banco local. 
			//2 n&atilde;o tinha. -- nesse caso fazemos um insert. 
			//Vamos verificar isso agora. 
			//Existe esse login?
			
			//1 Minha senha est&aacute; desatualizada no local. -- Nesse caso fazemos update na senha e tentamos autenticar de novo com o Nivel que tenho.
			$result3 = $this-&gt;getConexao()-&gt;query(&quot;SELECT * FROM usuario WHERE usua_login = '$login' LIMIT 1&quot;);
			foreach($result3 as $outraLinha){
				//Vamos atualizar sua senha, meu filho. 
				$this-&gt;getConexao()-&gt;query(&quot;UPDATE usuario set usua_senha = '$senha' WHERE usua_login = '$login'&quot;);
				//Caso isso aconteceu, podemos logar de novo. Mesmo augoritimo de antes.  Faï¿½amos recursividade? N&atilde;o, &eacute; meio arriscado, Vamos repetir mesmo. 
				foreach ( $this-&gt;getConexao ()-&gt;query ( $sql ) as $linha2 ) {
					$usuario-&gt;setLogin ( $linha2 ['usua_login'] );
					$usuario-&gt;setId ( $linha2 ['usua_id'] );
					$usuario-&gt;setNivelAcesso ( $linha2 ['usua_nivel'] );
					return true;
				}
				
			}
			//Vish, o cara n&atilde;o existia na base local. O que faremos? 
			//Num tem pobrema! Nois adiciona! Nois rai farre um incerte. 		
			$nivel = Sessao::NIVEL_COMUM;
			$nome = $linha['nome'];
			$email = $linha['email'];
			$idBaseExterna = $linha['id_usuario'];
			$this-&gt;getConexao()-&gt;query(&quot;INSERT into usuario(usua_login,usua_senha, usua_nome,usua_email, usua_nivel, id_base_externa) 
										VALUES ('$login', '$senha', '$nome','$email', $nivel, $idBaseExterna)&quot;);
			$usuario-&gt;setNivelAcesso ( $nivel);
			return true;
			
		}		
		return false;
	}

	/**
	 * Realiza uma pesuisa no banco de dados do Sigaa,
	 * retornando um ou v&aacute;rios usu&aacute;rios, dependendo da pesuisa realizada.
	 * @param string $pesquisa
	 * @return Usuario[] Array contendo a lista com o usu&aacute;rio pesuisado.
	 */	
	public function pesquisaNoSigaa($pesquisa){
		$lista = array();
		$pesquisa = strtoupper ( $pesquisa );
		$pesquisa = &quot;%&quot;.$pesquisa.&quot;%&quot;;
		
		$sql = &quot;SELECT * FROM vw_usuarios_catraca WHERE 
				TRANSLATE(UPPER(nome), '&aacute;&eacute;&iacute;&oacute;&uacute;&agrave;&egrave;&igrave;&ograve;&ugrave;&atilde;&otilde;&acirc;&ecirc;&icirc;&ocirc;&ocirc;&auml;&euml;&iuml;&ouml;&uuml;&ccedil;&Aacute;&Eacute;&Iacute;&Oacute;&Uacute;&Agrave;&Egrave;&Igrave;&Ograve;&Ugrave;&Atilde;&Otilde;&Acirc;&Ecirc;&Icirc;&Ocirc;&Ucirc;&Auml;&Euml;&Iuml;&Ouml;&Uuml;&Ccedil;','aeiouaeiouaoaeiooaeioucAEIOUAEIOUAOAEIOOAEIOUC')
				LIKE TRANSLATE(:pesquisa, '&aacute;&eacute;&iacute;&oacute;&uacute;&agrave;&egrave;&igrave;&ograve;&ugrave;&atilde;&otilde;&acirc;&ecirc;&icirc;&ocirc;&ocirc;&auml;&euml;&iuml;&ouml;&uuml;&ccedil;&Aacute;&Eacute;&Iacute;&Oacute;&Uacute;&Agrave;&Egrave;&Igrave;&Ograve;&Ugrave;&Atilde;&Otilde;&Acirc;&Ecirc;&Icirc;&Ocirc;&Ucirc;&Auml;&Euml;&Iuml;&Ouml;&Uuml;&Ccedil;','aeiouaeiouaoaeiooaeioucAEIOUAEIOUAOAEIOOAEIOUC') LIMIT 150&quot;;

		try{
			$stmt = $this-&gt;getConexao()-&gt;prepare($sql);
			$stmt-&gt;bindParam(&quot;:pesquisa&quot;, $pesquisa, PDO::PARAM_STR);
			$stmt-&gt;execute();
			$result = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC);
			
		}catch (PDOException $e){
			echo '{&quot;erro&quot;:{&quot;text&quot;:'. $e-&gt;getMessage() .'}}';
		}
		foreach($result as $linha){
			$usuario = new Usuario();
			$usuario-&gt;setNome($linha['nome']);
			$usuario-&gt;setEmail($linha['email']);
			$usuario-&gt;setLogin($linha['login']);
			$usuario-&gt;setIdBaseExterna($linha['id_usuario']);
			$usuario-&gt;setCpf($linha['cpf_cnpj']);
			$usuario-&gt;setIdentidade($linha['identidade']);
			$usuario-&gt;setPassaporte($linha['passaporte']);
			$usuario-&gt;setSiape($linha['siape']);
			$usuario-&gt;setTipoDeUsuario($linha['tipo_usuario']);
			$usuario-&gt;setMatricula($linha['matricula_disc']);
			$usuario-&gt;setStatusDiscente($linha['status_discente']);
			$usuario-&gt;setNivelDiscente($linha['nivel_discente']);
			$usuario-&gt;setCategoria($linha['categoria']);
			$usuario-&gt;setStatusServidor($linha['status_servidor']);
			$lista[] = $usuario;
		}		
		return $lista;		
	}
	
	/**
	 * @ignore
	 * @param string $pesquisa
	 * @return Usuario[]
	 */
	public function pesquisaTesteNoSigaa($pesquisa){
		$lista = array();
		$pesquisa = strtoupper ( $pesquisa );
		$pesquisa = &quot;%&quot;.$pesquisa.&quot;%&quot;;
		
		$sql = &quot;SELECT * FROM vw_usuarios_catraca WHERE 
				TRANSLATE(UPPER(nome), '&aacute;&eacute;&iacute;&oacute;&uacute;&agrave;&egrave;&igrave;&ograve;&ugrave;&atilde;&otilde;&acirc;&ecirc;&icirc;&ocirc;&ocirc;&auml;&euml;&iuml;&ouml;&uuml;&ccedil;&Aacute;&Eacute;&Iacute;&Oacute;&Uacute;&Agrave;&Egrave;&Igrave;&Ograve;&Ugrave;&Atilde;&Otilde;&Acirc;&Ecirc;&Icirc;&Ocirc;&Ucirc;&Auml;&Euml;&Iuml;&Ouml;&Uuml;&Ccedil;','aeiouaeiouaoaeiooaeioucAEIOUAEIOUAOAEIOOAEIOUC')
				LIKE TRANSLATE(:pesquisa, '&aacute;&eacute;&iacute;&oacute;&uacute;&agrave;&egrave;&igrave;&ograve;&ugrave;&atilde;&otilde;&acirc;&ecirc;&icirc;&ocirc;&ocirc;&auml;&euml;&iuml;&ouml;&uuml;&ccedil;&Aacute;&Eacute;&Iacute;&Oacute;&Uacute;&Agrave;&Egrave;&Igrave;&Ograve;&Ugrave;&Atilde;&Otilde;&Acirc;&Ecirc;&Icirc;&Ocirc;&Ucirc;&Auml;&Euml;&Iuml;&Ouml;&Uuml;&Ccedil;','aeiouaeiouaoaeiooaeioucAEIOUAEIOUAOAEIOOAEIOUC') LIMIT 150&quot;;

		try{
			$stmt = $this-&gt;getConexao()-&gt;prepare($sql);
			$stmt-&gt;bindParam(&quot;:pesquisa&quot;, $pesquisa, PDO::PARAM_STR);
			$stmt-&gt;execute();
			$result = $stmt-&gt;fetchAll(PDO::FETCH_ASSOC);
			
		}catch (PDOException $e){
			echo '{&quot;erro&quot;:{&quot;text&quot;:'. $e-&gt;getMessage() .'}}';
		}
		foreach($result as $linha){
			$usuario = new Usuario();
			$usuario-&gt;setNome($linha['nome']);
			$usuario-&gt;setEmail($linha['email']);
			$usuario-&gt;setLogin($linha['login']);
			$usuario-&gt;setIdBaseExterna($linha['id_usuario']);
			$usuario-&gt;setCpf($linha['cpf_cnpj']);
			$usuario-&gt;setIdentidade($linha['identidade']);
			$usuario-&gt;setPassaporte($linha['passaporte']);
			$usuario-&gt;setSiape($linha['siape']);
			$usuario-&gt;setTipoDeUsuario($linha['tipo_usuario']);
			$usuario-&gt;setMatricula($linha['matricula_disc']);
			$usuario-&gt;setStatusDiscente($linha['status_discente']);
			$usuario-&gt;setNivelDiscente($linha['nivel_discente']);
			$usuario-&gt;setCategoria($linha['categoria']);
			$usuario-&gt;setStatusServidor($linha['status_servidor']);
			$lista[] = $usuario;
		}	
		return $lista;	
	}
	
	/**
	 * Realiza uma busca no banco, pelo IdBaseExterna(Id do Sigaa), no bando do Sigaa.
	 * @param Usuario $usuario
	 * @return Usuario
	 */
	public function retornaPorIdBaseExterna(Usuario $usuario){
		$id = $usuario-&gt;getIdBaseExterna();
		$sql = &quot;SELECT * FROM vw_usuarios_catraca WHERE id_usuario = $id ORDER BY status_discente, status_servidor ASC LIMIT 1&quot;;
		
		foreach ($this-&gt;getConexao ()-&gt;query ( $sql ) as $linha){
			$usuario-&gt;setNome($linha['nome']);
			$usuario-&gt;setEmail($linha['email']);
			$usuario-&gt;setLogin($linha['login']);
			$usuario-&gt;setCpf($linha['cpf_cnpj']);
			$usuario-&gt;setIdBaseExterna($linha['id_usuario']);
			$usuario-&gt;setIdentidade($linha['identidade']);
			$usuario-&gt;setPassaporte($linha['passaporte']);
			$usuario-&gt;setTipoDeUsuario($linha['tipo_usuario']);
			$usuario-&gt;setMatricula($linha['matricula_disc']);
			$usuario-&gt;setStatusDiscente($linha['status_discente']);
			$usuario-&gt;setNivelDiscente($linha['nivel_discente']);
			$usuario-&gt;setCategoria($linha['categoria']);
			$usuario-&gt;setIDCategoria($linha['id_categoria']);
			$usuario-&gt;setSiape($linha['siape']);
			$usuario-&gt;setStatusServidor($linha['status_servidor']);
			return $usuario;
			
		}
		
	}
	
	/**
	 * Pesquisaremos primeiro o Login do usuario e depois o nome do laboratorio.
	 * Apos isso pegaremos o Id de cada um e usaremos numa operacao de insert.
	 * Mas essa operacao so pode funcionar se ela ainda nao existir com esse usuario e laboratorio.
	 * Terminando tudo iremos atualizar o nivel do usuario
	 * @ignore
	 * @param Usuario $usuario        	
	 * @param Laboratorio $laboratorio        	
	 */
	public function tornarAdministrador(Usuario $usuario, Laboratorio $laboratorio) {
		$login = $usuario-&gt;getLogin();
		$nomeLaboratorio = $laboratorio-&gt;getNome();
		
		$sqlLaboratorio = &quot;SELECT * FROM laboratorio WHERE nome_laboratorio = $nomeLaboratorio&quot;;		
	}
	
	/**
	 * Pesquisa na Base local o usu&aacute;rio atrav&eacute;s do seu login.
	 * @param Usuario $usuario
	 * @return boolean
	 */
	public function preenchePorLogin(Usuario $usuario){
		
		$login = $usuario-&gt;getLogin();
		$login = preg_replace ('/[^a-zA-Z0-9\s]/', '', $login);
		$sql = &quot;SELECT * FROM usuario WHERE usua_login = '$login'&quot;;
		foreach($this-&gt;getConexao()-&gt;query($sql) as $linha){
			$usuario-&gt;setId($linha['usua_id']);
			$usuario-&gt;setNome($linha['usua_nome']);
			return true;
		}
		return false;		
	}
	
	/**
	 * Pesquisa na Base local o usu&aacute;rio atrav&eacute;s do seu Id.
	 * @param Usuario $usuario
	 */
	public function preenchePorId(Usuario $usuario){
	
		$id = intval($usuario-&gt;getId());
		
		$sql = &quot;SELECT * FROM usuario WHERE usua_id = $id&quot;;
		foreach($this-&gt;getConexao()-&gt;query($sql) as $linha){
			$usuario-&gt;setNome($linha['usua_nome']);
			$usuario-&gt;setIdBaseExterna($linha['id_base_externa']);
			return true;
		}
		return false;
	
	
	}
	/**
	 * Diferente do outro este est&aacute; preparado para olhar na base pr&oacute;pria,
	 * pesuisa na base local atraves do IdBaseExterna.
	 * @param Usuario $usuario
	 */
	public function preenchePorIdBaseExterna(Usuario $usuario){	
		$id = $usuario-&gt;getIdBaseExterna();
		$sql = &quot;SELECT * FROM usuario WHERE id_base_externa  = $id&quot;;
		foreach($this-&gt;getConexao()-&gt;query($sql) as $linha){
			$usuario-&gt;setId($linha['usua_id']);
			$usuario-&gt;setNome($linha['usua_nome']);
			$usuario-&gt;setNivelAcesso($linha['usua_nivel']);
			return true;
		}
		return false;
	
	
	}
	
	/**
	 * @ignore
	 * @param Laboratorio $laboratorio
	 */
	public function preenchePorNome(Laboratorio $laboratorio){
		$nome = $laboratorio-&gt;getNome();
		$sql = &quot;SELECT * FROM laboratorio WHERE nome_laboratorio = '$nome'&quot;;
		foreach($this-&gt;getConexao()-&gt;query($sql) as $linha){
			$laboratorio-&gt;setId($linha['id_laboratorio']);
			return true;
		}
		return false;
	}
	
	/**
	 * @ignore
	 * @param Usuario $usuario
	 * @param Laboratorio $laboratorio
	 */
	public function ehAdministrador(Usuario $usuario, Laboratorio $laboratorio){
		$idUsuario = $usuario-&gt;getId();
		$idLaboratorio = $laboratorio-&gt;getId();
		$sql= &quot;SELECT * FROM administrador WHERE id_usuario = $idUsuario AND id_laboratorio = $idLaboratorio&quot;;
		$result =$this-&gt;getConexao()-&gt;query($sql);
		foreach($result as $linha){
			return true;
		}
		return false;
	}
	
	/**
	 * Altera o n&iacute;vel do usu&aacute;rio, atr&aacute;ves do IdBaseExterna. 
	 * @param Usuario $usuario
	 */
	public function alteraNivelDeAcesso(Usuario $usuario){
		
		$idBaseExterna = $usuario-&gt;getIdBaseExterna();
		$novoNivel = $usuario-&gt;getNivelAcesso();
		$update = &quot;UPDATE usuario set usua_nivel = $novoNivel WHERE id_base_externa = $idBaseExterna&quot;;
		return $this-&gt;getConexao()-&gt;exec($update);		
		
	}
	
	
}

?&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>