<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php

/**
 * Dao Referente a Entidade Unidade.
 * 
 * @author Jefferson Uchoa Ponte
 * @version 1.0
 * @copyright UNILAB - Universidade da Integracao Internacional da Lusofonia Afro-Brasileira.
 * @package DAO
 */

/**
 * UnidadeDAO altera&ccedil;&otilde;es do banco de dados referentes &agrave; entidade unidade. 
 * Gera pesistencia da classe unidade. 
 *
 */
class UnidadeDAO extends DAO {
	
	/**
	 * Retorna Um vetor de unidades.
	 *
	 * @return multitype:Unidade
	 */
	public function retornaLista() {
		$lista = array ();
		$sql = &quot;SELECT * FROM unidade LIMIT 100&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		
		foreach ( $result as $linha ) {
			$unidade = new Unidade ();
			$unidade-&gt;setId ( $linha ['unid_id'] );
			$unidade-&gt;setNome ( $linha ['unid_nome'] );
			$lista [] = $unidade;
		}
		return $lista;
	}
	
	/**
	 * Fun&ccedil;&atilde;o utilidada para Inserir uma Unidade.
	 * @param Unidade $unidade
	 */
	public function inserirUnidade(Unidade $unidade) {
		$nome = $unidade-&gt;getNome ();
		if ($this-&gt;getConexao ()-&gt;query ( &quot;INSERT INTO unidade (unid_nome) VALUES('$nome')&quot; ))
			return true;
		return false;
	}
	
	/**
	 * Fun&ccedil;&atilde;o utilizada para Deletar uma Unidade.
	 * @param Unidade $unidade
	 */
	public function deletarUnidade(Unidade $unidade) {
		$id = $unidade-&gt;getId ();
		$sql = &quot;DELETE FROM unidade WHERE unid_id = $id&quot;;
		if ($this-&gt;getConexao ()-&gt;query ( $sql ))
			return true;
		return false;
	}
	
	/**
	 * Fun&ccedil;&atilde;o utilizada para realizar uma constulta,retornando uma array de catracas da unidade consultada. 
	 * @param Unidade $unidade
	 */
	public function retornaCatracasPorUnidade(Unidade $unidade = null) {
		$lista = array ();
		if ($unidade != null) {
			$id = $unidade-&gt;getId ();
			$sql = &quot;SELECT 
			
					*, catraca.catr_id as catraca_id
					 
					FROM catraca 
					INNER JOIN catraca_unidade
					ON catraca.catr_id = catraca_unidade.catr_id
					INNER JOIN unidade
					ON unidade.unid_id = catraca_unidade.unid_id
					WHERE unidade.unid_id = $id&quot;;
		} else {
			$sql = &quot;SELECT *, catraca.catr_id as 
					catraca_id
					 FROM catraca
					LEFT JOIN catraca_unidade
					ON catraca.catr_id = catraca_unidade.catr_id
					LEFT JOIN unidade
					ON unidade.unid_id = catraca_unidade.unid_id
					ORDER BY catraca.catr_id ASC
					&quot;;
		}
		
		foreach ( $this-&gt;getConexao ()-&gt;query ( $sql ) as $linha ) {
			$catraca = new Catraca ();
			$catraca-&gt;setNome ( $linha ['catr_nome'] );
			$catraca-&gt;setOperacao($linha['catr_operacao']);
			$catraca-&gt;setTempoDeGiro($linha['catr_tempo_giro']);
			$catraca-&gt;setIp($linha['catr_ip']);
			$catraca-&gt;setId($linha['catraca_id']);
			$catraca-&gt;setMacLan($linha['catr_mac_lan']);
			$catraca-&gt;setMacWlan($linha['catr_mac_wlan']);
			$catraca-&gt;setInterfaceRede($linha['catr_interface_rede']);
			$catraca-&gt;setUnidade(new Unidade());
			$catraca-&gt;getUnidade()-&gt;setNome($linha['unid_nome']);
			$catraca-&gt;setFinanceiro($linha['catr_financeiro']);
			
			
			$lista [] = $catraca;
		}
		return $lista;
	}
	
	/**
	 * Retona a quantidade de giros efetuados pela catraca consultada.
	 * @param Catraca $catraca
	 * @return number|PDOStatement
	 */
	public function totalDeGirosDaCatraca(Catraca $catraca){
		$idCatraca = $catraca-&gt;getId();
		$filtro = &quot;&quot;;
		
		$sql = &quot;SELECT sum(1) as resultado 
				FROM registro INNER JOIN catraca ON registro.catr_id = catraca.catr_id
				WHERE catraca.catr_id = $idCatraca $filtro&quot;;
		
		$resultado = 0;
		foreach ($this-&gt;getConexao()-&gt;query($sql) as $linha){
			$resultado = $linha['resultado'];
			
		}
		return $resultado;
	}
	
	/**
	 * Retorna a total de giro da catraca por turno em andamento,
	 * separando-os elo tipo de usuario que utilizou a catraca.
	 * @param Catraca $catraca
	 * @param Tipo $tipo
	 */
	public function totalDeGirosDaCatracaTurnoAtual(Catraca $catraca, Tipo $tipo = null){
		$resultado = 0;
		$idCatraca = $catraca-&gt;getId();
		$turno = $this-&gt;pegaTurnoAtualSeExistir();
		if($turno){
			$horaInicial = date(&quot;Y-m-d &quot;).$turno-&gt;getHoraInicial();
			$horaFinal = date(&quot;Y-m-d &quot;).$turno-&gt;getHoraFinal();
			if($tipo == null){
				
				$sql = &quot;SELECT sum(1) as resultado FROM registro INNER JOIN catraca ON registro.catr_id = catraca.catr_id
			WHERE catraca.catr_id = $idCatraca AND registro.regi_data BETWEEN '$horaInicial' AND '$horaFinal' &quot;;
				
			
			}
			else{
				$idTipo = $tipo-&gt;getId();
				$sql = &quot;SELECT sum(1) as resultado FROM registro INNER JOIN catraca ON registro.catr_id = catraca.catr_id
				INNER JOIN cartao ON cartao.cart_id = registro.cart_id
				WHERE catraca.catr_id = $idCatraca AND registro.regi_data BETWEEN '$horaInicial' AND '$horaFinal' AND cartao.tipo_id = $idTipo&quot;;
				
			}

			foreach ($this-&gt;getConexao()-&gt;query($sql) as $linha){
				$resultado = $linha['resultado'];
			}			
		}		
		return $resultado;
	}

	/**
	 * Retorna a total de giro da catraca por turno em andamento,
	 * filtrando pelos registros de usuario pagantes.
	 * @param Catraca $catraca
	 * @param Tipo $tipo
	 */
	public function totalGiroTurnoAtualNaoIsento(Catraca $catraca, Tipo $tipo = null){
		$resultado = 0;
		$idCatraca = $catraca-&gt;getId();
		$turno = $this-&gt;pegaTurnoAtualSeExistir();
		if($turno){
			$horaInicial = date(&quot;Y-m-d &quot;).$turno-&gt;getHoraInicial();
			$horaFinal = date(&quot;Y-m-d &quot;).$turno-&gt;getHoraFinal();
			if($tipo == null){
	
				$sql = &quot;SELECT sum(1) as resultado FROM registro INNER JOIN catraca ON registro.catr_id = catraca.catr_id
				WHERE (catraca.catr_id = $idCatraca) AND (registro.regi_data BETWEEN '$horaInicial' AND '$horaFinal') AND 
				(regi_valor_pago &gt; 0)
				&quot;;
	
					
			}
			else{
				$idTipo = $tipo-&gt;getId();
				$sql = &quot;SELECT sum(1) as resultado FROM registro INNER JOIN catraca ON registro.catr_id = catraca.catr_id
				INNER JOIN cartao ON cartao.cart_id = registro.cart_id
				WHERE (catraca.catr_id = $idCatraca) AND (registro.regi_data BETWEEN '$horaInicial' AND '$horaFinal') AND (cartao.tipo_id = $idTipo) AND 
				(regi_valor_pago &gt; 0)
				&quot;;
	
			}
	
			foreach ($this-&gt;getConexao()-&gt;query($sql) as $linha){
				$resultado = $linha['resultado'];
			}
		}
		return $resultado;
	}
	
	/**
	 * Retorna a total de giro da catraca por turno em andamento,
	 * filtrando pelos registros de usuario isentos.
	 * @param Catraca $catraca
	 * @param Tipo $tipo
	 */
	public function totalGiroTurnoAtualIsento(Catraca $catraca, Tipo $tipo = null){
		$resultado = 0;
		$idCatraca = $catraca-&gt;getId();
		$turno = $this-&gt;pegaTurnoAtualSeExistir();
		if($turno){
			$horaInicial = date(&quot;Y-m-d &quot;).$turno-&gt;getHoraInicial();
			$horaFinal = date(&quot;Y-m-d &quot;).$turno-&gt;getHoraFinal();
	
			$sql = &quot;SELECT sum(1) as resultado FROM registro INNER JOIN catraca ON registro.catr_id = catraca.catr_id
			WHERE catraca.catr_id = $idCatraca AND registro.regi_data BETWEEN '$horaInicial' AND '$horaFinal'
			AND (regi_valor_pago = 0)
			&quot;;
	
					
	
			foreach ($this-&gt;getConexao()-&gt;query($sql) as $linha){
				$resultado = $linha['resultado'];
			}
		}
		return $resultado;
	}
	
	/**
	 * Retorna um array de turnos no periodo corrente.
	 * @return NULL|Turno
	 */
	public function pegaTurnoAtualSeExistir(){
		$dataTimeAtual = date ( &quot;G:i:s&quot; );
		$sql = &quot;Select * FROM turno WHERE '$dataTimeAtual' BETWEEN turno.turn_hora_inicio AND turno.turn_hora_fim&quot;;
		$result = $this-&gt;conexao-&gt;query($sql);
		$turno = null;
		foreach ($result as $linha){
			$turno = new Turno();
			$turno-&gt;setHoraInicial($linha['turn_hora_inicio']);
			$turno-&gt;setHoraFinal($linha['turn_hora_fim']);
			
		}
		return $turno;
	}
	
	/**
	 * Consulta a Catraca pelo seu Id
	 * @param Catraca $catraca
	 */
	public function preencheCatracaPorId(Catraca $catraca){
		$idCatraca = $catraca-&gt;getId();
		$sql = &quot;
				SELECT *, catraca.catr_id as catraca_id FROM catraca
		LEFT JOIN catraca_unidade
		ON catraca.catr_id = catraca_unidade.catr_id
		LEFT JOIN unidade
		ON unidade.unid_id = catraca_unidade.unid_id
		WHERE catraca.catr_id = $idCatraca&quot;;
		foreach ( $this-&gt;getConexao ()-&gt;query ( $sql ) as $linha ) {
			$catraca-&gt;setNome ( $linha ['catr_nome'] );
			$catraca-&gt;setId ( $linha ['catraca_id'] );
			$catraca-&gt;setOperacao($linha['catr_operacao']);
			$catraca-&gt;setTempoDeGiro($linha['catr_tempo_giro']);
			$catraca-&gt;setIp($linha['catr_ip']);
			$catraca-&gt;setInterfaceRede($linha['catr_interface_rede']);
			$catraca-&gt;setFinanceiro($linha['catr_financeiro']);
			
			$catraca-&gt;setUnidade(new Unidade());
			$catraca-&gt;getUnidade()-&gt;setNome($linha['unid_nome']);
			$catraca-&gt;getUnidade()-&gt;setId($linha['unid_id']);
				
		}
		
	}
	/**
	 * Realiza o Update dos dados Catraca selecionada.
	 * @param Catraca $catraca
	 */
	public function atualizarCatraca(Catraca $catraca){
		$giro = $catraca-&gt;getTempodeGiro();
		$id = $catraca-&gt;getId();
		$nomeCatraca = $catraca-&gt;getNome();
		$operacao = $catraca-&gt;getOperacao();
		$idUnidade= $catraca-&gt;getUnidade()-&gt;getId();
		$interface = $catraca-&gt;getInterfaceRede();
		
		if($catraca-&gt;financeiroAtivo()){
			$financeiro = 'TRUE';
		}else{
			$financeiro = 'FALSE';
		}		
		
		$this-&gt;getConexao()-&gt;beginTransaction();
		$sqlUpdate = &quot;UPDATE catraca SET catr_tempo_giro = $giro,						
						catr_operacao = $operacao,
						catr_nome = '$nomeCatraca',
						catr_interface_rede = '$interface',
						catr_financeiro = '$financeiro'
						WHERE catr_id = $id&quot;;
		
		if(!$this-&gt;getConexao()-&gt;exec($sqlUpdate))
		{
			$this-&gt;getConexao()-&gt;rollBack();
			echo $sqlUpdate;
			echo 'Foi aqui Nao consegui Atualizar';
			return false;
		}
 		$this-&gt;getConexao()-&gt;exec(&quot;DELETE FROM catraca_unidade WHERE catr_id = $id&quot;);
		
		if(!$this-&gt;getConexao()-&gt;exec(&quot;INSERT into catraca_unidade(catr_id, unid_id) VALUES($id, $idUnidade)&quot;))
		{
			$this-&gt;getConexao()-&gt;rollBack();
			return false;
		}
		
		$this-&gt;getConexao()-&gt;commit();
		return true;
		
		
		
	}
	
	/**
	 * ??????
	 */
	function inserirRegistro() {
		$request = \Slim\Slim::getInstance()-&gt;request();
		$body = $request-&gt;getBody();
		$dados = json_decode($body);
	
		$sql = &quot;INSERT INTO registro(regi_data, regi_valor_pago, regi_valor_custo, cart_id, catr_id, vinc_id)
	VALUES (:data, :pago, :custo, :cartao, :catraca, :vinculo);&quot;;
	
		try {
			$db = getDB();
			$stmt = $db-&gt;prepare($sql);
			$stmt-&gt;bindParam(&quot;data&quot;, ($dados-&gt;regi_data == '') ? NULL : $dados-&gt;regi_data ); //NULL if $dados-&gt;regi_data == NULL else $dados-&gt;regi_data );
			$stmt-&gt;bindParam(&quot;pago&quot;, $dados-&gt;regi_valor_pago);
			$stmt-&gt;bindParam(&quot;custo&quot;, $dados-&gt;regi_valor_custo);
			$stmt-&gt;bindParam(&quot;cartao&quot;, $dados-&gt;cart_id);
			$stmt-&gt;bindParam(&quot;catraca&quot;, $dados-&gt;catr_id);
			$stmt-&gt;bindParam(&quot;vinculo&quot;, $dados-&gt;vinc_id);
			$stmt-&gt;execute();
			$db = null;
		} catch(PDOException $e) {
			echo '{&quot;erro&quot;:{&quot;text&quot;:'. $e-&gt;getMessage() .'}}';
		}
	}
	
	/**
	 * Consulta a Unidade pos Id.
	 * @param Unidade $unidade
	 */
	public function preenchePorId(Unidade $unidade) {
		$idUnidade = $unidade-&gt;getId ();
		if (! is_int ( $idUnidade ) &amp;&amp; $idUnidade &lt;= 0)
			return;
		$sql = &quot;SELECT * FROM unidade WHERE unid_id = $idUnidade&quot;;
		foreach ( $this-&gt;getConexao ()-&gt;query ( $sql ) as $linha )
			$unidade-&gt;setNome ( $linha ['unid_nome'] );
		return;
	}
	
	/**
	 * Retorna os turnos contidos na unidade.
	 * @param Turno $turno
	 * @param Unidade $unidade
	 */
	public function turnoNaUnidade(Turno $turno, Unidade $unidade) {
		$idTurno = $turno-&gt;getId ();
		$idUnidade = $unidade-&gt;getId ();
		if ($idUnidade &lt;= 0 || $idTurno &lt;= 0 || ! is_int ( $idUnidade ) || ! is_int ( $idTurno ))
			return;
			// Primeiro vamos ver se esse turno existe nessa unidade.
		
		$sqlExiste = &quot;SELECT * FROM unidade_turno WHERE turn_id = $idTurno AND unid_id = $idUnidade&quot;;
		foreach ( $this-&gt;getConexao ()-&gt;query ( $sqlExiste ) as $linha )
			return false;
		
		$sqlInsert = &quot;INSERT INTO unidade_turno(turn_id, unid_id) VALUES($idTurno, $idUnidade)&quot;;
		if ($this-&gt;getConexao ()-&gt;exec ( $sqlInsert ))
			return true;
		return false;
		
		// Caso contr&aacute;rio a gente insere.
	}
	
	/**
	 * Exclui um turno da unidade.
	 * @param Turno $turno
	 * @param Unidade $unidade
	 */
	public function excluirTurnoDaUnidade(Turno $turno, Unidade $unidade) {
		$idTurno = $turno-&gt;getId ();
		$idUnidade = $unidade-&gt;getId ();
		if ($idUnidade &lt;= 0 || $idTurno &lt;= 0 || ! is_int ( $idUnidade ) || ! is_int ( $idTurno ))
			return;
		$sqlInsert = &quot;DELETE FROM unidade_turno WHERE unid_id = $idUnidade AND  turn_id = $idTurno&quot;;
		if ($this-&gt;getConexao ()-&gt;exec ( $sqlInsert ))
			return true;
		return false;
	
		// Caso contr&Atilde;&iexcl;rio a gente insere.
	}
	
	/**
	 * Retorna os turnos da unidade.
	 * @param Unidade $unidade
	 */
	public function turnosDaUnidade(Unidade $unidade) {
		$idUnidade = $unidade-&gt;getId ();
		$sql = &quot;SELECT * FROM unidade 
				INNER JOIN 
				unidade_turno ON unidade.unid_id = unidade_turno.unid_id 
				INNER JOIN turno 
				ON turno.turn_id = unidade_turno.turn_id
				WHERE unidade.unid_id = $idUnidade&quot;;
		foreach ( $this-&gt;getConexao ()-&gt;query ( $sql ) as $linha ) {
			
			$turno = new Turno ();
			$turno-&gt;setId ( $linha ['turn_id'] );
			$turno-&gt;setDescricao ( $linha ['turn_descricao'] );
			$turno-&gt;setHoraFinal ( $linha ['turn_hora_fim'] );
			$turno-&gt;setHoraInicial ( $linha ['turn_hora_inicio'] );
			$unidade-&gt;adicionaTurno ( $turno );
		}
	}
	
	/**
	 * retorna um array contendo os custos das Unidades.
	 */
	public function custosDaUnidade(){
	
		$lista = array ();
		$sql = &quot;SELECT * FROM unidade
				LEFT JOIN custo_unidade ON custo_unidade.unid_id = unidade.unid_id
				LEFT JOIN custo_refeicao ON custo_refeicao.cure_id = custo_unidade.cure_id&quot;;
		$result = $this-&gt;getConexao()-&gt;query($sql);
		foreach ($result as $linha){
			$unidade = new Unidade();
			$unidade-&gt;setId($linha['unid_id']);
			$unidade-&gt;setNome($linha['unid_nome']);
			$unidade-&gt;setCustoUnidade($linha['cure_valor']);
			$lista[] = $unidade;
		}
		return $lista;
	}
}

?&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>