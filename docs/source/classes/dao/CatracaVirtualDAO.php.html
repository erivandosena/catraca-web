<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Classe utilizada para conx&atilde;o com o Bando de Dados.
 * 
 * @author Jefferson Uchoa Ponte
 * @version 1.0
 * @copyright UNILAB - Universidade da Integracao Internacional da Lusofonia Afro-Brasileira.
 * @package DAO
 */

/**
 * Classe para conex&atilde;o com o Banco de Dados e
 * tratamento das informa&ccedil;&otilde;es referente a Catraca Virtual,
 */
class CatracaVirtualDAO extends DAO {
	
	/**
	 *
	 * Temos que saber se esse usuario possui um cart&atilde;o v&aacute;lido. Para isso &eacute; necess&aacute;rio que esteja
	 * cadastrado e que n&atilde;o tenha comido neste turno. Ou que tenha comido de acordo com a quantidade
	 * permitida para este cart&atilde;o.
	 *
	 * @param Vinculo $vinculo        	
	 * @return boolean
	 */
	public function verificaVinculo(Vinculo $vinculo) {
		$numero = $vinculo-&gt;getCartao ()-&gt;getNumero ();
		$data = date ( &quot;Y-m-d G:i:s&quot; );
		
		$sql = &quot;SELECT * FROM cartao 
				INNER JOIN vinculo
				ON cartao.cart_id = vinculo.cart_id
				INNER JOIN vinculo_tipo ON vinculo_tipo.vinc_id = vinculo.vinc_id
				INNER JOIN tipo ON tipo.tipo_id = vinculo_tipo.tipo_id
				INNER JOIN usuario on vinculo.usua_id = usuario.usua_id
				WHERE ('$data' BETWEEN vinculo.vinc_inicio AND vinculo.vinc_fim)
				AND (cartao.cart_numero =:numero)&quot;;
		try {
			$stmt = $this-&gt;getConexao ()-&gt;prepare ( $sql );
			$stmt-&gt;bindParam ( &quot;:numero&quot;, $numero, PDO::PARAM_STR );
			$stmt-&gt;execute ();
			$result = $stmt-&gt;fetchAll ( PDO::FETCH_ASSOC );
		} catch ( PDOException $e ) {
			echo '{&quot;erro&quot;:{&quot;text&quot;:' . $e-&gt;getMessage () . '}}';
		}
		foreach ( $result as $linha ) {
			$usuario = new Usuario ();
			$vinculo-&gt;setResponsavel ( $usuario );
			$vinculo-&gt;getResponsavel ()-&gt;setNome ( $linha ['usua_nome'] );
			$vinculo-&gt;setFinalValidade ( $linha ['vinc_fim'] );
			$vinculo-&gt;getResponsavel ()-&gt;setIdBaseExterna ( $linha ['id_base_externa'] );
			$vinculo-&gt;getCartao ()-&gt;setCreditos ( $linha ['cart_creditos'] );
			$vinculo-&gt;getCartao ()-&gt;setId ( $linha ['cart_id'] );
			$vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;setNome ( $linha ['tipo_nome'] );
			$vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;setValorCobrado ( $linha ['tipo_valor'] );
			$vinculo-&gt;getCartao ()-&gt;setNumero ( $linha ['cart_numero'] );
			$vinculo-&gt;getCartao ()-&gt;setId ( $linha ['cart_id'] );
			$vinculo-&gt;setQuantidadeDeAlimentosPorTurno ( $linha ['vinc_refeicoes'] );
			$vinculo-&gt;setId ( $linha ['vinc_id'] );
			$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
			$vinculo-&gt;setDescricao ( $linha ['vinc_descricao'] );
			return true;
		}
		return false;
	}
	
	/**
	 * Retorna todos os turnos da cadastrados para inicar na hora corrente.
	 */
	public function retornaTurnoAtual() {
		$data = date ( &quot;Y-m-d G:i:s&quot; );
		$selectTurno = &quot;Select * FROM turno WHERE '$data' BETWEEN
		turno.turn_hora_inicio AND turno.turn_hora_fim&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $selectTurno );
		foreach ( $result as $linha ) {
			$turno = new Turno ();
			$turno-&gt;setHoraFinal ( $linha ['turn_hora_fim'] );
			$turno-&gt;setHoraInicial ( $linha ['turn_hora_inicio'] );
			return $turno;
		}
		return false;
	}
	
	/**
	 * Verifica se foi inserido um registro j&aacute; foi inserido no n&uacute;mero do cart&atilde;o do usu&aacute;rio no turno,
	 * e verifica tabem a quantidade de refei&ccedil;&otilde;es &eacute; permitida por cart&atilde;o
	 * 
	 * @param Vinculo $vinculo        	
	 * @param Turno $turnoAtual        	
	 * @return boolean
	 */
	public function podeContinuarComendo(Vinculo $vinculo, Turno $turnoAtual) {
		$horaInicial = date ( 'Y-m-d' ) . ' ' . $turnoAtual-&gt;getHoraInicial ();
		$horaFinal = date ( 'Y-m-d' ) . ' ' . $turnoAtual-&gt;getHoraFinal ();
		$idCartao = $vinculo-&gt;getCartao ()-&gt;getId ();
		$quantidadePermitida = $vinculo-&gt;getQuantidadeDeAlimentosPorTurno ();
		
		$numero = $vinculo-&gt;getCartao ()-&gt;getNumero ();
		$data = date ( &quot;Y-m-d G:i:s&quot; );
		
		$sql = &quot;SELECT * FROM registro
				WHERE(registro.regi_data BETWEEN '$horaInicial' AND '$horaFinal')
				AND (registro.cart_id = $idCartao)
				ORDER BY registro.regi_id DESC
				LIMIT $quantidadePermitida;&quot;;
		
		try {
			$stmt = $this-&gt;getConexao ()-&gt;prepare ( $sql );
			$stmt-&gt;execute ();
			$result = $stmt-&gt;fetchAll ( PDO::FETCH_ASSOC );
		} catch ( PDOException $e ) {
			echo '{&quot;erro&quot;:{&quot;text&quot;:' . $e-&gt;getMessage () . '}}';
		}
		$i = 0;
		foreach ( $result as $linha ) {
			$i ++;
		}
		$vinculo-&gt;setRefeicoesRestantes ( $quantidadePermitida - $i );
		if ($i &lt; $quantidadePermitida) {
			return true;
		}
		return false;
	}
	
	/**
	 * Fun&ccedil;&atilde;o prara verificar se o vinculo do usuario &eacute; isento,
	 * caso seja verdadeiro &eacute; retornado True.
	 * 
	 * @param Vinculo $vinculo
	 *        	Objeto contendo os dados do vinculo.
	 * @return boolean
	 */
	public function vinculoEhIsento(Vinculo $vinculo) {
		$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
		$idVinculo = $vinculo-&gt;getId ();
		$sql = &quot;SELECT * FROM vinculo
		LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
		INNER JOIN isencao ON cartao.cart_id = isencao.cart_id
		WHERE (vinculo.vinc_id = $idVinculo) AND  ('$dataTimeAtual' &lt; isencao.isen_fim);&quot;;
		$result = $this-&gt;getConexao ()-&gt;query ( $sql );
		foreach ( $result as $linha ) {
			if (isset ( $linha ['isen_id'] )) {
				$vinculo-&gt;setIsencao ( new Isencao () );
				$vinculo-&gt;setIsento ( true );
				$vinculo-&gt;getIsencao ()-&gt;setId ( $linha ['isen_id'] );
				$vinculo-&gt;getIsencao ()-&gt;setDataDeInicio ( $linha ['isen_inicio'] );
				$vinculo-&gt;getIsencao ()-&gt;setDataFinal ( $linha ['isen_fim'] );
				return true;
			}
		}
		return false;
	}
	
	/**
	 * Func&ccedil;&atilde;o que recebe uma catraca e atrav&eacute;s do ID e retorna qual o custo da
	 * refei&ccedil;&atilde;o est&aacute; cadastro para ela
	 * 
	 * @param Catraca $catraca
	 *        	Objeto contendo os dados da Catraca.
	 */
	public function custoDaRefeicao(Catraca $catraca) {
		$custo = 0;
		$idCatraca = $catraca-&gt;getId ();
		$sql = &quot;SELECT cure_valor FROM custo_refeicao
		INNER JOIN custo_unidade ON custo_unidade.cure_id = custo_refeicao.cure_id
		INNER JOIN unidade ON unidade.unid_id = custo_unidade.unid_id
		INNER JOIN catraca_unidade ON catraca_unidade.unid_id = unidade.unid_id
		WHERE catraca_unidade.catr_id = $idCatraca
		ORDER BY custo_unidade.cure_id DESC LIMIT 1&quot;;
		
		foreach ( $this-&gt;getConexao ()-&gt;query ( $sql ) as $linha ) {
			$custo = $linha ['cure_valor'];
		}
		return $custo;
	}
}

?&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>