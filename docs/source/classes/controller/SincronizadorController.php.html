<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Classe utilizada para centralizar as demais Classes(DAO, Model, View, Util).
 * Esta classe ser&aacute; instaciada no index.php.
 * 
 * @author Jefferson Uchoa Ponte
 * @version 1.0
 * @copyright UNILAB - Universidade da Integracao Internacional da Lusofonia Afro-Brasileira.
 * @package Controle
 */
class SincronizadorController {
	
	/**
	 *
	 * @var array
	 */
	private $dadosSigaa;
	
	/**
	 *
	 * @var array
	 */
	private $dadosComum;
	
	/**
	 *
	 * @var DAO
	 */
	private $daoSigaa;
	
	/**
	 *
	 * @var DAO
	 */
	private $daoComum;
	
	/**
	 *
	 * @var DAO
	 */
	private $daoLocal;
	
	/**
	 * Relazina um aconsulta consulta a uma tabela com os dados do Sigaa,
	 * carraga todos os dados em uma matriz.
	 */
	public function carregarDados() {
		$this-&gt;daoSigaa = new DAO ( null, DAO::TIPO_PG_SIGAAA );
		$sqlSigaa = &quot;SELECT * FROM vw_usuarios_catraca&quot;;
		$result = $this-&gt;daoSigaa-&gt;getConexao ()-&gt;query ( $sqlSigaa );
		$matriz = array ();
		foreach ( $result as $linha ) {
			foreach ( $linha as $chave =&gt; $valor ) {
				$linha [$chave] = str_replace ( &quot;'&quot;, &quot;''&quot;, $valor );
			}
			$linha ['nome'] = &quot;'&quot; . $linha ['nome'] . &quot;'&quot;;
			$linha ['identidade'] = &quot;'&quot; . $linha ['identidade'] . &quot;'&quot;;
			$linha ['passaporte'] = &quot;'&quot; . $linha ['passaporte'] . &quot;'&quot;;
			$linha ['email'] = &quot;'&quot; . $linha ['email'] . &quot;'&quot;;
			$linha ['login'] = &quot;'&quot; . $linha ['login'] . &quot;'&quot;;
			$linha ['senha'] = &quot;'&quot; . $linha ['senha'] . &quot;'&quot;;
			$linha ['nivel_discente'] = &quot;'&quot; . $linha ['nivel_discente'] . &quot;'&quot;;
			$linha ['status_discente'] = &quot;'&quot; . $linha ['status_discente'] . &quot;'&quot;;
			$linha ['status_servidor'] = &quot;'&quot; . $linha ['status_servidor'] . &quot;'&quot;;
			$linha ['tipo_usuario'] = &quot;'&quot; . $linha ['tipo_usuario'] . &quot;'&quot;;
			$linha ['categoria'] = &quot;'&quot; . $linha ['categoria'] . &quot;'&quot;;
			foreach ( $linha as $chave =&gt; $valor ) {
				if (! $valor || $valor == &quot;''&quot;) {
					$linha [$chave] = &quot;null&quot;;
				}
			}
			$matriz [] = $linha;
		}
		$this-&gt;dadosSigaa = $matriz;
		$this-&gt;daoComum = new DAO ( null, DAO::TIPO_PG_SISTEMAS_COMUM );
		$sqlComum = &quot;SELECT * FROM vw_usuarios_autenticacao_catraca&quot;;
		$result = $this-&gt;daoComum-&gt;getConexao ()-&gt;query ( $sqlComum );
		$matriz = array ();
		foreach ( $result as $linha ) {
			foreach ( $linha as $chave =&gt; $valor ) {
				$linha [$chave] = str_replace ( &quot;'&quot;, &quot;''&quot;, $valor );
			}
			$linha ['nome'] = &quot;'&quot; . $linha ['nome'] . &quot;'&quot;;
			$linha ['passaporte'] = &quot;'&quot; . $linha ['passaporte'] . &quot;'&quot;;
			$linha ['email'] = &quot;'&quot; . $linha ['email'] . &quot;'&quot;;
			$linha ['login'] = &quot;'&quot; . $linha ['login'] . &quot;'&quot;;
			$linha ['senha'] = &quot;'&quot; . $linha ['senha'] . &quot;'&quot;;
			$linha ['status_servidor'] = &quot;'&quot; . $linha ['status_servidor'] . &quot;'&quot;;
			$linha ['tipo_usuario'] = &quot;'&quot; . $linha ['tipo_usuario'] . &quot;'&quot;;
			$linha ['categoria'] = &quot;'&quot; . $linha ['categoria'] . &quot;'&quot;;
			foreach ( $linha as $chave =&gt; $valor ) {
				if (! $valor || $valor == &quot;''&quot;) {
					$linha [$chave] = &quot;null&quot;;
				}
			}
			$matriz [$linha ['id_usuario']] = $linha;
		}
		$this-&gt;dadosComum = $matriz;
	}
	
	/**
	 */
	public function deletarDadosLocais() {
		$this-&gt;daoLocal = new DAO ();
		$this-&gt;daoLocal-&gt;getConexao ()-&gt;exec ( &quot;DELETE FROM vw_usuarios_catraca&quot; );
		$this-&gt;daoLocal-&gt;getConexao ()-&gt;exec ( &quot;DELETE FROM vw_usuarios_autenticacao_catraca&quot; );
	}
	
	/**
	 */
	public function inserirOsDoSigaa() {
		foreach ( $this-&gt;dadosSigaa as $idUsuario =&gt; $linha ) {
			$sqlInserir = &quot;INSERT into vw_usuarios_catraca
			(
			id_usuario,
			nome,identidade,
			cpf_cnpj,
			passaporte,
			email,
			login,
			senha,
			matricula_disc,
			nivel_discente,
			id_status_discente,
			status_discente,
			siape,
			id_status_servidor,
			status_servidor,
			id_tipo_usuario,
			tipo_usuario,
			id_categoria,
			status_sistema,
			categoria
			)
			VALUES(
			&quot; . $linha ['id_usuario'] . &quot;,
			&quot; . $linha ['nome'] . &quot;,
			&quot; . $linha ['identidade'] . &quot;,
			&quot; . $linha ['cpf_cnpj'] . &quot;,
			&quot; . $linha ['passaporte'] . &quot;,
			&quot; . $linha ['email'] . &quot;,
			&quot; . $linha ['login'] . &quot;,
			&quot; . $linha ['senha'] . &quot;,
			&quot; . $linha ['matricula_disc'] . &quot;,
			&quot; . $linha ['nivel_discente'] . &quot;,
			&quot; . $linha ['id_status_discente'] . &quot;,
			&quot; . $linha ['status_discente'] . &quot;,
			&quot; . $linha ['siape'] . &quot;,
			&quot; . $linha ['id_status_servidor'] . &quot;,
			&quot; . $linha ['status_servidor'] . &quot;,
			&quot; . $linha ['id_tipo_usuario'] . &quot;,
			&quot; . $linha ['tipo_usuario'] . &quot;,
			&quot; . $linha ['id_categoria'] . &quot;,
			&quot; . $linha ['status_sistema'] . &quot;,
			&quot; . $linha ['categoria'] . &quot;
			);&quot;;
			
			if (! $this-&gt;daoLocal-&gt;getConexao ()-&gt;exec ( $sqlInserir )) {
				echo &quot;Errei aqui: &quot; . $sqlInserir . &quot;&lt;br&gt;&quot;;
				return false;
			}
		}
		$this-&gt;dadosSigaa = null;
		return true;
	}
	
	/**
	 */
	public function inserirOsDoComum() {
		foreach ( $this-&gt;dadosComum as $idUsuario =&gt; $linha ) {
			$sqlInserir = &quot;INSERT into vw_usuarios_autenticacao_catraca
			(
			id_usuario,
			nome,
			cpf_cnpj,
			passaporte,
			email,
			login,
			senha,
			siape,
			id_status_servidor,
			status_servidor,
			id_tipo_usuario,
			id_categoria,
			categoria
			)
			VALUES(
			&quot; . $linha ['id_usuario'] . &quot;,
			&quot; . $linha ['nome'] . &quot;,
			&quot; . $linha ['cpf_cnpj'] . &quot;,
			&quot; . $linha ['passaporte'] . &quot;,
			&quot; . $linha ['email'] . &quot;,
			&quot; . $linha ['login'] . &quot;,
			&quot; . $linha ['senha'] . &quot;,
			&quot; . $linha ['siape'] . &quot;,
			&quot; . $linha ['id_status_servidor'] . &quot;,
			&quot; . $linha ['status_servidor'] . &quot;,
			&quot; . $linha ['id_tipo_usuario'] . &quot;,
			&quot; . $linha ['id_categoria'] . &quot;,
			&quot; . $linha ['categoria'] . &quot;
			
		
			);&quot;;
			
			if (! $this-&gt;daoLocal-&gt;getConexao ()-&gt;exec ( $sqlInserir )) {
				echo &quot;Errei aqui no Comum: &quot; . $sqlInserir;
				return false;
			}
		}
		return true;
	}
	
	/**
	 */
	public function sincronizar() {
		$tempoA = round ( microtime ( true ) * 1000 );
		// echo 'Vou carregar os dados.&lt;br&gt;';
		
		$this-&gt;carregarDados ();
		$tempoB = round ( microtime ( true ) * 1000 );
		// echo &quot;Carreguei! Levei: &lt;br&gt;&quot;;
		// echo $tempoB-$tempoA;
		// echo &quot; Mili segundos.&lt;br&gt;&quot;;
		// echo '&lt;br&gt;Agora vou deletar os dados da tabela local&lt;br&gt;';
		
		$this-&gt;deletarDadosLocais ();
		// echo '&lt;br&gt;Pronto! Levei: ';
		
		$tempoC = round ( microtime ( true ) * 1000 );
		// echo $tempoC-$tempoB;
		// echo &quot; Milisegundos&lt;br&gt;&quot;;
		// echo &quot;Vou inserir os dados do SIGAA na base local&quot;;
		
		if ($this-&gt;inserirOsDoSigaa ()) {
			echo &quot;&quot;;
			// echo '&lt;h1&gt;Deu tudo certo INSERINDO SIGAA&lt;/h1&gt;';
			// $tempoD = round(microtime(true) * 1000);
			// echo 'Inseri tudo em: ';
			// echo $tempoD-$tempoC;
			// echo ' Milisegundos';
		} else {
			echo &quot;&quot;;
			// echo 'Retornou Um falso';
		}
		if ($this-&gt;inserirOsDoComum ()) {
			echo &quot;&quot;;
			// echo '&lt;h1&gt;Deu tudo certo INSERINDO COMUM&lt;/h1&gt;';
			// $tempoE = round(microtime(true) * 1000);
			// echo 'Inseri tudo em: ';
			// echo $tempoE-$tempoD;
			// echo ' Milisegundos';
		} else {
			echo &quot;&quot;;
			// echo 'Retornou Um falso no COmum';
		}
	}
}
</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>