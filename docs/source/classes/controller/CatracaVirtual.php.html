<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * @ignore
 * @author Jefferson Uchoa Ponte
 * @version 1.0
 * @copyright UNILAB - Universidade da Integracao Internacional da Lusofonia Afro-Brasileira.
 * @package Controle
 */

class CatracaVirtual{
	
	/**
	 * 
	 * @var DAO
	 */
	private $dao;
	
	/**
	 * 
	 * @var CatracaVirtualView
	 */
	private $view;
	
	/**
	 * 
	 */
	public function CatracaVirtual(){
		$this-&gt;view = new CatracaVirtualView();
	}
	
	/**
	 * Metodo principal utilizada para controlar o acesso a classe atrav&eacute;s do n&iacute;vel de acesso do usuario.
	 *
	 * @param Sessao $nivelDeAcesso
	 *        	Recebe uma Sess&atilde;o que cont&eacute;m o n&iacute;vel de acesso do usuario,
	 *        	esta Sess&atilde;o &eacute; iniciada na p&aacute;gina principal, durante o login do usuario.
	 */
	public static function main($nivel){
		
		if($nivel == Sessao::NIVEL_SUPER){

			$gerador = new CatracaVirtual();
			$gerador-&gt;verificarSelecaoRU();
		}
		
		
	}
	
	/**
	 * Esta fun&ccedil;&atilde;o chama o formul&aacute;rio para sele&ccedil;&atilde;o de RU,
	 * 
	 */	
	 public function verificarSelecaoRU(){
		$this-&gt;dao = new DAO();
		
		if(isset($_SESSION['catraca_id'])){
			$this-&gt;paginaRegistroManual();
		}
		else{
			if(isset($_POST['catraca_id'])){
				$_SESSION['catraca_id'] = intval($_POST['catraca_id']);
				echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;0; url=?pagina=gerador&quot;&gt;';
			}
			$this-&gt;selecionarRU();
		} 
			
		
	}
	
	/**
	 * 
	 */
	public function selecionarRU(){
		$unidadeDao = new UnidadeDAO($this-&gt;dao-&gt;getConexao());
		$listaDeCatracas = $unidadeDao-&gt;retornaCatracasPorUnidade();
		
		
		echo '&lt;div class=&quot;navegacao&quot;&gt;
				&lt;div class = &quot;simpleTabs&quot;&gt;
			        &lt;ul class = &quot;simpleTabsNavigation&quot;&gt;
						&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Cadastro&lt;/a&gt;&lt;/li&gt;
			        &lt;/ul&gt;
			        &lt;div class = &quot;simpleTabsContent&quot;&gt;		
						&lt;div class=&quot;doze colunas borda&quot;&gt;';
		
		echo '&lt;form action=&quot;&quot; method=&quot;post&quot;&gt;
				&lt;label for=&quot;catraca_id&quot;&gt;Selecione o Restaurante:&lt;/label&gt;&lt;br&gt;
			        &lt;select name=&quot;catraca_id&quot; id=&quot;catraca_id&quot;&gt;';
		
		foreach ($listaDeCatracas as $catraca){
			
			echo '&lt;option value=&quot;'.$catraca-&gt;getId().'&quot;&gt;'.$catraca-&gt;getNome().'&lt;/option&gt;';
						
		}
		
		                
			            
		echo '       &lt;/select&gt;&lt;br&gt;
					&lt;input type=&quot;submit&quot; class=&quot;botao&quot; VALUE=&quot;Selecionar&quot; /&gt;
				&lt;/form&gt;	
				&lt;/div&gt;
				&lt;/div&gt;
				&lt;/div&gt;
				&lt;/div&gt;';
		
	}

	/**
	 * 
	 */
	public function paginaRegistroManual(){
		
		$tipoDao = new TipoDAO($this-&gt;dao-&gt;getConexao());
		$listaDeTipos = $tipoDao-&gt;retornaLista();
		
		$unidadeDao = new UnidadeDAO($this-&gt;dao-&gt;getConexao());
		$catraca = new Catraca();
		$catraca-&gt;setId($_SESSION['catraca_id']);
		$unidadeDao-&gt;preencheCatracaPorId($catraca);
		
		echo '&lt;div class=&quot;navegacao&quot;&gt; 
				&lt;div class = &quot;simpleTabs&quot;&gt;
			        &lt;ul class = &quot;simpleTabsNavigation&quot;&gt;					
						&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Cadastro&lt;/a&gt;&lt;/li&gt;	
			        &lt;/ul&gt;
				
			        &lt;div class = &quot;simpleTabsContent&quot;&gt;				
						&lt;div class=&quot;doze colunas borda&quot;&gt;
							&lt;table class=&quot;tabela borda-vertical zebrada no-centro centralizado&quot;&gt;							    
							    &lt;thead&gt;
							        &lt;tr&gt;
												&lt;th&gt;Unidade&lt;/th&gt;';
		foreach($listaDeTipos as $tipo){
				echo '&lt;th&gt;'.$tipo-&gt;getNome().'&lt;/th&gt;';				
		}
		
		echo '&lt;th&gt;Total&lt;/th&gt;
						        &lt;/tr&gt;
							    &lt;/thead&gt;
							    &lt;tbody&gt;		
							        &lt;tr&gt;
										&lt;th&gt;'.$catraca-&gt;getNome().'&lt;/th&gt;';
		$somatorio = 0;
		foreach ($listaDeTipos as $tipo){
			$j = $unidadeDao-&gt;totalDeGirosDaCatracaTurnoAtual($catraca, $tipo);
			$somatorio += $j;
			echo '&lt;td&gt;'.$j.'&lt;/td&gt;';	
			
		}
		echo '&lt;td&gt;'.$somatorio.'&lt;/td&gt;
		
		
							        &lt;/tr&gt;
									&lt;tr&gt;	
									&lt;tr&gt;
										&lt;th&gt;Selecionar&lt;/th&gt;';
		$listaDeCores = array('aviso', 'primario', 'sucesso', 'secundario', 'erro', 'erro','primario', 'sucesso', 'secundario', 'aviso', 'erro');
		$i = 0;
		foreach($listaDeTipos as $tipo){
			
			echo '&lt;td&gt;&lt;a href=&quot;?pagina=gerador&amp;tipo_id='.$tipo-&gt;getId().'&quot; class=&quot;botao b-'.$listaDeCores[$i].' icone-checkmar&quot;&gt;+1&lt;/a&gt;&lt;/td&gt;';
			$i++;
		}
		
		echo '&lt;td&gt;-&lt;/td&gt;		
							            
							        &lt;/tr&gt;
							    &lt;/tbody&gt;
							&lt;/table&gt;';
		
		$this-&gt;view-&gt;formBuscaCartao();
		
		echo '
				
						&lt;/div&gt;';
		$data = date ( &quot;Y-m-d G:i:s&quot; );
		if(isset($_GET['numero_cartao'])){
			if($_GET['numero_cartao'] == NULL || $_GET['numero_cartao'] == &quot;&quot;)
				return;
			$i = 0;
			$turnoAtual = new Turno();
			$selectTurno = &quot;Select * FROM turno 
				WHERE '$data' BETWEEN turno.turn_hora_inicio AND turno.turn_hora_fim&quot;;
			$result = $this-&gt;dao-&gt;getConexao()-&gt;query($selectTurno);
			foreach($result as $linha){
				$turnoAtual-&gt;setHoraInicial($linha['turn_hora_inicio']);
				$turnoAtual-&gt;setHoraFinal($linha['turn_hora_fim']);
				$i++;
				break;
			}
			if($i == 0){
				$this-&gt;mensagemErro(&quot;Fora do hor&amp;aacute;rio de refei&amp;ccedil;&amp;atilde;o&quot;);
				echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1; url=?pagina=gerador&quot;&gt;';
				return;
			}
			
			
			$cartao = new Cartao();
			$cartao-&gt;setNumero($_GET['numero_cartao']);
			$cartaoDao = new CartaoDAO($tipoDao-&gt;getConexao());
			$verifica = $cartaoDao-&gt;preenchePorNumero($cartao);
			$idCartao = $cartao-&gt;getId();
			
			if($verifica == NULL){
				$this-&gt;mensagemErro(&quot;Cart&atilde;o n&atilde;o cadastrado!&quot;);
				echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1; url=?pagina=gerador&quot;&gt;';
				return;
			}
			
			
			
			
			$vinculoDao = new VinculoDAO($cartaoDao-&gt;getConexao());
			$vinculo = $vinculoDao-&gt;retornaVinculoValidoDeCartao($cartao);
			if($vinculo == NULL)
			{
				$this-&gt;mensagemErro(&quot;Verifique o v&iacute;nculo deste cart&atilde;o!&quot;);
				echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1; url=?pagina=gerador&quot;&gt;';
				return;
				
			}
			//Vamos ver se ele pode mesmo comer. Coloque o c&oacute;digo aqui.
			$data1 = date(&quot;Y-m-d&quot;).' '.$turnoAtual-&gt;getHoraInicial();
			$data2 = date(&quot;Y-m-d&quot;).' '.$turnoAtual-&gt;getHoraFinal();
			
			$sqlVerRegistros = &quot;SELECT * FROM registro WHERE (registro.regi_data  BETWEEN '$data1' AND '$data2')
			AND (registro.cart_id = $idCartao) ORDER BY registro.regi_id DESC&quot;;
			$i = 0;
			foreach($this-&gt;dao-&gt;getConexao()-&gt;query($sqlVerRegistros) as $linha){
				$i++;
				if($vinculo-&gt;isAvulso())
					break;
				if($i &gt;= $vinculo-&gt;getQuantidadeDeAlimentosPorTurno()){
					$this-&gt;mensagemErro(&quot;Usu&aacute;rio j&aacute; passou neste turno!&quot;);
					echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;3; url=?pagina=gerador&quot;&gt;';
					return;
				}
			}
			
			
			if(isset($_GET['confirmado'])){
				
				$custo = 0;
				$sql = &quot;SELECT cure_valor FROM custo_refeicao ORDER BY cure_id DESC LIMIT 1&quot;;
				foreach($tipoDao-&gt;getConexao()-&gt;query($sql) as $linha){
					$custo = $linha['cure_valor'];
				}
				
				$idVinculo= $vinculo-&gt;getId();
				$valorPago = $vinculo-&gt;getCartao()-&gt;getTipo()-&gt;getValorCobrado();
				$idCatraca = $_SESSION['catraca_id'];
				$sql = &quot;INSERT into registro(regi_data, regi_valor_pago, regi_valor_custo, catr_id, cart_id, vinc_id)
				VALUES('$data', $valorPago, $custo, $idCatraca, $idCartao, $idVinculo)&quot;;
				//echo $sql;
				if($this-&gt;dao-&gt;getConexao()-&gt;exec($sql))
						$this-&gt;mensagemSucesso();
					else
						$this-&gt;mensagemErro();
				echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1; url=?pagina=gerador&quot;&gt;';
				
			}
			
			else{
				
				$strNome = $vinculo-&gt;getResponsavel()-&gt;getNome();
				if($vinculo-&gt;isAvulso()){
					$strNome = &quot; Avulso &quot;;
				}
				echo '&lt;div class=&quot;doze colunas borda centralizado&quot;&gt;';
				echo '&lt;p&gt;Confirmar Cadastro de refei&ccedil;&atilde;o para '.$strNome.' - '.$cartao-&gt;getTipo()-&gt;getNome().'?&lt;/p&gt;';
				echo '&lt;a href=&quot;?pagina=gerador&amp;numero_cartao='.$_GET['numero_cartao'].'&amp;confirmado=1&quot; class=&quot;botao b-sucesso&quot;&gt;Confimar&lt;/a&gt;';
				echo '&lt;/div&gt;';
			}
		}else if(isset($_GET['tipo_id'])){
			
			$i = 0;
			$selectTurno = &quot;Select * FROM turno WHERE '$data' BETWEEN turno.turn_hora_inicio AND turno.turn_hora_fim&quot;;
			$result = $this-&gt;dao-&gt;getConexao()-&gt;query($selectTurno);
			foreach($result as $linha){
				$i++;
				break;
			}
			if($i == 0){
				$this-&gt;mensagemErro(&quot;Fora do hor&amp;aacute;rio de refei&amp;ccedil;&amp;atilde;o&quot;);
				echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1; url=?pagina=gerador&quot;&gt;';
				return;
			}
			
			if(isset($_GET['confirmado']))
			{
				
				$idTipo = intval($_GET['tipo_id']);
				$tipo = new Tipo();
				$tipo-&gt;setId($idTipo);
				
				$sql = &quot;SELECT * FROM tipo WHERE tipo_id = $idTipo&quot;;
				
				foreach($tipoDao-&gt;getConexao()-&gt;query($sql) as $linha){
					$tipo-&gt;setValorCobrado($linha['tipo_valor']);
					
				}
				$custo = 0;
				$sql = &quot;SELECT cure_valor FROM custo_refeicao ORDER BY cure_id DESC LIMIT 1&quot;;
				foreach($tipoDao-&gt;getConexao()-&gt;query($sql) as $linha){
					$custo = $linha['cure_valor'];
				}
				
					
				
				$idCartao = 0;
				$idVinculo = 0;
				$numero = &quot;&quot;;
			
				$sql = &quot;SELECT * FROM cartao
				INNER JOIN vinculo ON cartao.cart_id = vinculo.cart_id
				WHERE tipo_id = $idTipo LIMIT 1&quot;;
				foreach($tipoDao-&gt;getConexao()-&gt;query($sql) as $linha){
					$idCartao = $linha['cart_id'];
					$idVinculo = $linha['vinc_id'];
					$numero = $linha['cart_numero'];
					
					break;
					
				}
				
				$idCatraca = $_SESSION['catraca_id'];
				$valorPago = $tipo-&gt;getValorCobrado();
				
				$sql = &quot;INSERT into registro(regi_data, regi_valor_pago, regi_valor_custo, catr_id, cart_id, vinc_id) 
						VALUES('$data', $valorPago, $custo, $idCatraca, $idCartao, $idVinculo)&quot;;
				
				
				if($this-&gt;dao-&gt;getConexao()-&gt;exec($sql))
					$this-&gt;mensagemSucesso();
				else
					$this-&gt;mensagemErro();
				echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1; url=?pagina=gerador&quot;&gt;';
			}
			else
			{
				echo '&lt;div class=&quot;doze colunas borda centralizado&quot;&gt;&lt;p&gt;Confirmar Envio de Dados?&lt;/p&gt;
						&lt;a href=&quot;?pagina=gerador&amp;tipo_id='.$_GET['tipo_id'].'&amp;confirmado=1&quot; class=&quot;botao b-sucesso&quot;&gt;Confimar&lt;/a&gt;&lt;/div&gt;';
			}	
			
		}
		
		
		
				
		echo '&lt;/div&gt;
				&lt;/div&gt;';
		        
		
		
	}
	
	/**
	 * 
	 */
	public function mensagemSucesso(){
		echo '&lt;div class=&quot;doze colunas borda centralizado&quot;&gt;
		
										&lt;div class=&quot;alerta-sucesso&quot;&gt;
										    &lt;div class=&quot;icone icone-download ix24&quot;&gt;&lt;/div&gt;
										    &lt;div class=&quot;titulo-alerta&quot;&gt;Ok&lt;/div&gt;
										    &lt;div class=&quot;subtitulo-alerta&quot;&gt;Dados enviados com sucesso!&lt;/div&gt;
										&lt;/div&gt;
		
									&lt;/div&gt;';
		
	}
	
	/**
	 * 
	 * @param string $strMensagem
	 */
	public function mensagemErro($strMensagem = null){
		if($strMensagem == null)
			$strMensagem = &quot;Erro na tentativa de inserir os dados!&quot;;
		echo '&lt;div class=&quot;doze colunas borda centralizado&quot;&gt;
	
										&lt;div class=&quot;alerta-erro&quot;&gt;
										    &lt;div class=&quot;icone icone-fire ix24&quot;&gt;&lt;/div&gt;
										    &lt;div class=&quot;titulo-alerta&quot;&gt;'.$strMensagem.'&lt;/div&gt;
										    &lt;div class=&quot;subtitulo-alerta&quot;&gt;Erro!&lt;/div&gt;
										&lt;/div&gt;
	
									&lt;/div&gt;';
	
	}

}

?&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>