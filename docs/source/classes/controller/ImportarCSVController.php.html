<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/** 
 * Classe utilizada para centralizar as demais Classes(DAO, Model, View, Util).
 * Esta classe ser&aacute; instaciada no index.php.
 * 
 * @author Jefferson Uchoa Ponte
 * @version 1.0
 * @copyright UNILAB - Universidade da Integracao Internacional da Lusofonia Afro-Brasileira.
 * @package Controle
 */
/**
 * Esta classe &eacute; utilizada para a importa&ccedil;&atilde;o dos quandos
 * quando ocorrer a falta de conex&atilde;o com o servidor.
 * 
 * Atrav&eacute;s do Bloco de Notas criado o arquivo .csv contendo
 * os n&uacute;meros dos cart&otilde;es que utilizaram o RU.
 * 
 * O valor da refei&ccedil;&atilde;o ser&aacute; creditado de cada cart&atilde;o.
 */
class ImportarCSVController {
	
	/**
	 * Metodo principal utilizada para controlar o acesso a classe atrav&eacute;s do n&iacute;vel de acesso do usuario.
	 *
	 * @param Sessao $nivelDeAcesso
	 *        	Recebe uma Sess&atilde;o que cont&eacute;m o n&iacute;vel de acesso do usuario,
	 *        	esta Sess&atilde;o &eacute; iniciada na p&aacute;gina principal, durante o login do usuario.
	 */
	public static function main($nivelDeAcesso) {
		switch ($nivelDeAcesso) {
			case Sessao::NIVEL_ADMIN :
				$controller = new ImportarCSVController ();
				$controller-&gt;importar ();
				break;
			
			default :
				UsuarioController::main ( $nivelDeAcesso );
				break;
		}
	}
	
	/**
	 * Importa o arquivo para processar os dados e debitar os valores de cada
	 * cart&atilde;o.
	 */
	public function importar() {
		echo '&lt;h1&gt;Importar&lt;/h1&gt;';
		$row = 1;
		$cartoes = array ();
		if (($handle = fopen ( &quot;almoco2.csv&quot;, &quot;r&quot; )) !== FALSE) {
			while ( ($data = fgetcsv ( $handle, 1000, &quot;,&quot; )) !== FALSE ) {
				$num = count ( $data );
				$row ++;
				for($c = 0; $c &lt; $num; $c ++) {
					$cartao = new Cartao ();
					$cartao-&gt;setNumero ( $data [$c] );
					$cartoes [] = $cartao;
				}
			}
			fclose ( $handle );
		}
		$dao = new CatracaVirtualDAO ();
		$dao-&gt;getConexao ()-&gt;beginTransaction ();
		
		$i = 0;
		echo '&lt;table border=1&gt;';
		echo '&lt;tr&gt;&lt;th&gt;Cartao&lt;/th&gt;&lt;th&gt;Usuario&lt;/th&gt;&lt;th&gt;Creditos&lt;/th&gt;&lt;th&gt;Tipo&lt;/th&gt;&lt;/tr&gt;';
		foreach ( $cartoes as $cartao ) {
			$vinculo = new Vinculo ();
			$vinculo-&gt;setCartao ( $cartao );
			
			$dao-&gt;verificaVinculo ( $vinculo );
			if ($cartao-&gt;getCreditos () == 0) {
				$i ++;
			}
			$isento = false;
			$valorPago = $vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;getValorCobrado ();
			if ($dao-&gt;vinculoEhIsento ( $vinculo )) {
				$valorPago = 0;
				$isento = true;
			}
			
			echo '&lt;tr&gt;';
			echo '&lt;td&gt;' . $cartao-&gt;getNumero () . '&lt;/td&gt;&lt;td&gt;' . $vinculo-&gt;getResponsavel ()-&gt;getNome () . ' &lt;/td&gt;&lt;td&gt;' . $cartao-&gt;getCreditos () . ' &lt;/td&gt;&lt;td&gt;' . $vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;getNome () . ' ' . $valorPago . '&lt;/td&gt;';
			echo '&lt;/tr&gt;';
			
			$data = '2016-12-02 12:00:00';
			
			$custo = 9.5;
			$idCatraca = 3;
			$idCartao = $cartao-&gt;getId ();
			$idVinculo = $vinculo-&gt;getId ();
			
			$sql = &quot;INSERT into registro(regi_data, regi_valor_pago, regi_valor_custo, catr_id, cart_id, vinc_id)
			VALUES('$data', $valorPago, $custo, $idCatraca, $idCartao, $idVinculo)&quot;;
			
			$novoValor = floatval ( $vinculo-&gt;getCartao ()-&gt;getCreditos () ) - floatval ( $valorPago );
			$sqlUpdate = &quot;UPDATE cartao set cart_creditos = $novoValor WHERE cart_id = $idCartao&quot;;
			
			// echo '&lt;tr&gt;';
			// echo '&lt;td colspan=3&gt;';
			
			// echo $sql;
			// echo '&lt;/td&gt;';
			// if($dao-&gt;getConexao()-&gt;exec($sql)){
			// echo '&lt;td&gt;Foi&lt;/td&gt;';
			
			// }else{
			// echo '&lt;td&gt;Erro&lt;/td&gt;';
			// $dao-&gt;getConexao()-&gt;rollBack();
			// return;
			
			// }
			
			// echo '&lt;/tr&gt;';
			
			// echo '&lt;tr&gt;';
			// echo '&lt;td colspan=3&gt;';
			// echo $sqlUpdate;
			// echo '&lt;/td&gt;';
			// if($dao-&gt;getConexao()-&gt;exec($sqlUpdate)){
			// echo '&lt;td&gt;Foi Update&lt;/td&gt;';
			// }else{
			// echo '&lt;td&gt;Erro UPDATE&lt;/td&gt;';
			// $dao-&gt;getConexao()-&gt;rollBack();
			// return;
			// }
			
			// echo '&lt;/tr&gt;';
		}
		$dao-&gt;getConexao ()-&gt;commit ();
		echo '&lt;/table&gt;';
		
		// echo 'Sucesso!';
	}
}</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>