<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Classe utilizada para centralizar as demais Classes(DAO, Model, View, Util).
 * Esta classe ser&aacute; instaciada no index.php.
 * 
 * @author Jefferson Uchoa Ponte
 * @version 1.0
 * @copyright UNILAB - Universidade da Integracao Internacional da Lusofonia Afro-Brasileira.
 * @package Controle
 */

class CartaoIsentoController{
	private $view;
	public static function main($nivelDeAcesso){
		
		switch ($nivelDeAcesso){
			case Sessao::NIVEL_SUPER:
				$controller = new CartaoIsentoController();
				$controller-&gt;telaCartao();
				break;
			case Sessao::NIVEL_ADMIN:
				$controller = new CartaoIsentoController();
				$controller-&gt;telaCartao();
				break;
			default:
				UsuarioController::main ( $nivelDeAcesso );
				break;
		}
	}
	
	
	public function telaCartao(){
		$this-&gt;view = new CartaoIsentoView();
		echo '&lt;div class=&quot;conteudo&quot;&gt; &lt;div class = &quot;simpleTabs&quot;&gt;
		        &lt;ul class = &quot;simpleTabsNavigation&quot;&gt;
				
					&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Identifica&amp;ccedil;&amp;atilde;o&lt;/a&gt;&lt;/li&gt;';
		
// 		echo '		&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Cadastro de Isen&ccedil;&atilde;o&lt;/a&gt;&lt;/li&gt;
					
		echo '     &lt;/ul&gt;
		        &lt;div class = &quot;simpleTabsContent&quot;&gt;';
		
		$this-&gt;telaIdentificacao();
		echo '	&lt;/div&gt;';
						
						
// 		echo '	&lt;div class = &quot;simpleTabsContent&quot;&gt;';
// 		$this-&gt;telaCadastro();
// 		echo '	&lt;/div&gt;';		
						
		echo '&lt;/div&gt;&lt;/div&gt;';
		
		
		
	}
	public function telaIdentificacao(){
		
		$this-&gt;view-&gt;formBuscaCartao();
		
		if(isset($_GET['numero_cartao'])){
			$cartao = new Cartao();
			$cartao-&gt;setNumero($_GET['numero_cartao']);
			$numeroCartao = $cartao-&gt;getNumero();
			$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
			$sqlVerificaNumero = &quot;SELECT * FROM usuario 
				INNER JOIN vinculo
				ON vinculo.usua_id = usuario.usua_id
				LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
				LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id
				WHERE cartao.cart_numero = '$numeroCartao'
					&quot;;
			$dao = new DAO();
			$result = $dao-&gt;getConexao()-&gt;query($sqlVerificaNumero);
			$idCartao = 0;
			$usuario = new Usuario();
			$tipo = new Tipo();
			$vinculoDao = new VinculoDAO($dao-&gt;getConexao());
			$vinculo = new Vinculo();
			foreach($result as $linha){
				$idDoVinculo = $linha['vinc_id'];
				$tipo-&gt;setNome($linha['tipo_nome']);
				$usuario-&gt;setNome($linha['usua_nome']);
				$usuario-&gt;setIdBaseExterna($linha['id_base_externa']);
				$idCartao = $linha['cart_id'];
				$vinculo-&gt;setAvulso($linha['vinc_avulso']);
				$avulso = $linha['vinc_avulso'];
				if($avulso){
					$usuario-&gt;setNome(&quot;Avulso&quot;);
				}
				break;
				
			}
			if($idCartao){
				
				$vinculo-&gt;setId($idDoVinculo);
				$cartao-&gt;setId($idCartao);
				$vinculoDao-&gt;vinculoPorId($vinculo);
				
				echo '&lt;div class=&quot;borda&quot;&gt;&lt;h1&gt;'.ucwords(strtolower(htmlentities($usuario-&gt;getNome()))).'. Tipo: '.$tipo-&gt;getNome();
				
				echo '&lt;/h1&gt;';
				
				if(file_exists('fotos/'.$usuario-&gt;getIdBaseExterna().'.png')){
						
					echo '&lt;img width=&quot;300&quot; src=&quot;fotos/'.$usuario-&gt;getIdBaseExterna().'.png&quot; /&gt;';
						
				}
				
				if(!$vinculo-&gt;isActive()){
					echo '&lt;p&gt;O vinculo n&atilde;o est&aacute; ativo &lt;/p&gt;&lt;br&gt;
							&lt;a href=&quot;?pagina=cartao&amp;numero_cartao='.$_GET['numero_cartao'].'&amp;cartao_renovar=1&quot; class=&quot;botao&quot;&gt;Renovar&lt;/a&gt; ';
				
					
				}else{
					
					//Aqui a gente da a op&ccedil;&atilde;o de adicionar a isen&ccedil;&atilde;o. 
					$vinculoDao-&gt;isencaoValidaDoVinculo($vinculo);
					if($vinculo-&gt;ehIsento()){
						echo '&lt;p&gt;Usu&aacute;rio Isento&lt;/p&gt;';
						//descomente esta linha para come&ccedil;ar. 
// 						echo '&lt;br&gt;&lt;a href=&quot;?pagina=isento&amp;numero_cartao='.$_GET['numero_cartao'].'&amp;cancelar_isencao=1&quot; class=&quot;botao&quot;&gt;Cancelar Isen&ccedil;&atilde;o&lt;/a&gt;';
						if(isset($_GET['cancelar_isencao']) &amp;&amp; isset($_GET['numero_cartao'])){
							
							echo 'A funcionalidade de cancelar est&aacute; em constru&ccedil;&atilde;o. ';
							
						}
					
					}
					else{
						if(!isset($_GET['add_isencao'])){
							echo '&lt;a href=&quot;?pagina=isento&amp;numero_cartao='.$_GET['numero_cartao'].'&amp;add_isencao=1&quot; class=&quot;botao&quot;&gt;Adicionar Isen&ccedil;&atilde;o&lt;/a&gt;';
						}else{
							if(isset($_POST['isen_inicio']) &amp;&amp; isset($_POST['isen_fim']) &amp;&amp; isset($_POST['id_card'])){
								$vinculo-&gt;setIsencao(new Isencao());
								$vinculo-&gt;getIsencao()-&gt;setDataDeInicio($_POST['isen_inicio']);
								$vinculo-&gt;getIsencao()-&gt;setDataFinal($_POST['isen_fim']);
								if($vinculoDao-&gt;adicionarIsencaoNoVinculo($vinculo)){
									$this-&gt;view-&gt;mostraSucesso(&quot;Isen&ccedil;&atilde;o adicionada Com Sucesso&quot;);
									
								}else{
									$this-&gt;view-&gt;mostraSucesso(&quot;Erro ao tentar adicionar isen&ccedil;&atilde;o. &quot;);
									
								}
								echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=isento&amp;numero_cartao='.$_GET['numero_cartao'].'&quot;&gt;';
								
							}
							$this-&gt;view-&gt;formAdicionarIsencao($_GET['numero_cartao']);
							
							
						}
						
					}
						
					
				}
				echo '
						
						
						&lt;/div&gt;';
			}else
			{

				echo '&lt;div class=&quot;borda&quot;&gt;&lt;h1&gt;Cart&atilde;o N&atilde;o possui V&iacute;nculo V&aacute;lido.&lt;/h1&gt;&lt;/div&gt;';
				
			}
			
			
			
		}
		
		
	}
	public function telaCadastro(){
		$this-&gt;view-&gt;formBuscaUsuarios();
		
		if (isset ( $_GET ['selecionado'] )) {
			
			$idDoSelecionado = $_GET['selecionado'];
			$usuarioDao = new UsuarioDAO();
			$usuario = new Usuario();
			$usuario-&gt;setIdBaseExterna($idDoSelecionado);
			
			$usuarioDao-&gt;retornaPorIdBaseExterna($usuario);
			
			
			$this-&gt;view-&gt;mostraSelecionado($usuario);
			$vinculoDao = new VinculoDAO();
				
			
			
			if(isset($_GET['vinculo_cancelar'])){
				$vinculo = new Vinculo();
				$vinculo-&gt;setId($_GET['vinculo_cancelar']);
				
				if(isset($_POST['certeza'])){
					if($vinculoDao-&gt;invalidarVinculo($vinculo)){
						$this-&gt;view-&gt;mostraSucesso(&quot;V&iacute;nculo Invalidado.  &quot;);
					}else{
						$this-&gt;view-&gt;mostraSucesso(&quot;Erro ao tentar invalidar v&iacute;nculo.  &quot;);
						
					}
					echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=cartao&amp;selecionado=' . $usuario-&gt;getIdBaseExterna() . '&quot;&gt;';
					return;
				}
				
				
				$this-&gt;view-&gt;formConfirmacaoEliminarVinculo($vinculo);
				return;
			}
			
			if(isset($_GET['vinculo_renovar'])){
				$vinculo = new Vinculo();
				$vinculo-&gt;setId($_GET['vinculo_renovar']);
				$vinculoDao-&gt;vinculoPorId($vinculo);
				
				$daqui3Meses = date ( 'Y-m-d', strtotime ( &quot;+60 days&quot; ) ) . 'T' . date ( 'G:00:01' );
				$vinculo-&gt;setFinalValidade($daqui3Meses);
				
				
				if(isset($_POST['certeza'])){
					if($vinculoDao-&gt;usuarioJaTemVinculo($usuario))
					{
						$this-&gt;view-&gt;mostraSucesso(&quot;Esse usu&aacute;rio j&aacute; possui v&iacute;nculo v&aacute;lido.&quot;);
						echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=cartao&amp;selecionado=' . $usuario-&gt;getIdBaseExterna() . '&quot;&gt;';
						return;
					}
					if($vinculo-&gt;isAvulso()){
						
						$this-&gt;view-&gt;mostraSucesso(&quot;N&atilde;o existe renova&ccedil;&atilde;o de v&iacute;nculos avulsos!&quot;);
						echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=cartao&amp;selecionado=' . $usuario-&gt;getIdBaseExterna() . '&quot;&gt;';
						return;
					}
					
					if(!$this-&gt;verificaSeAtivo($usuario)){
						$this-&gt;view-&gt;mostraSucesso(&quot;Esse usu&aacute;rio possui um problema quanto ao status!&quot;);
						echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=cartao&amp;selecionado=' . $usuario-&gt;getIdBaseExterna() . '&quot;&gt;';
						return;
						
					}
					
					
					
					if($vinculoDao-&gt;atualizaValidade($vinculo)){
						$this-&gt;view-&gt;mostraSucesso(&quot;V&iacute;nculo Atualizado com Sucesso!  &quot;);
					}else{
						$this-&gt;view-&gt;mostraSucesso(&quot;Erro ao tentar renovar v&iacute;nculo.  &quot;);

					}
					echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=cartao&amp;selecionado=' . $usuario-&gt;getIdBaseExterna() . '&quot;&gt;';
					return;
				}
			
			
				$this-&gt;view-&gt;formConfirmacaoRenovarVinculo();
				return;
			}
			
			
			
			
			
			$vinculos = $vinculoDao-&gt;retornaVinculosValidosDeUsuario($usuario);
			
			$podeComer = $this-&gt;verificaSeAtivo($usuario);
			
			if(!sizeof($vinculos) &amp;&amp; $podeComer){
				if (!isset ( $_GET ['cartao'] )){
					echo '&lt;a class=&quot;botao&quot; href=&quot;?pagina=cartao&amp;selecionado=' . $idDoSelecionado . '&amp;cartao=add&quot;&gt;Adicionar&lt;/a&gt;';
				}else{
					$tipoDao = new TipoDAO($vinculoDao-&gt;getConexao());
					$listaDeTipos = $tipoDao-&gt;retornaLista();
					foreach ($listaDeTipos as $chave =&gt; $tipo){
						if(strtolower (trim( $tipo-&gt;getNome())) == 'aluno'){
							if(strtolower (trim($usuario-&gt;getStatusDiscente())) == 'ativo' || strtolower (trim($usuario-&gt;getStatusDiscente())) == 'ativo - formando' || strtolower (trim($usuario-&gt;getStatusDiscente())) == 'ativo - graduando'){
								continue;
							}
							unset($listaDeTipos[$chave]);
							continue;
						}
						if(strtolower (trim( $tipo-&gt;getNome())) == 'servidor tae'){
							
							if(strtolower (trim($usuario-&gt;getStatusServidor())) == 'ativo' &amp;&amp; strpos(strtolower (trim($usuario-&gt;getCategoria())), 'administrativo')){
								continue;
							}
							if($usuario-&gt;getIDCategoria() == 3){
								
								continue;
							}
							unset($listaDeTipos[$chave]);
							continue;
						}
						if(strtolower (trim( $tipo-&gt;getNome())) == 'servidor docente'){
							if(strtolower (trim($usuario-&gt;getStatusServidor())) == 'ativo' &amp;&amp; strtolower (trim($usuario-&gt;getCategoria())) == 'docente'){
								continue;
								
							}
							unset($listaDeTipos[$chave]);
							continue;
						}
						if(strtolower (trim( $tipo-&gt;getNome())) == 'terceirizado'){
							if(strtolower (trim($usuario-&gt;getTipodeUsuario())) == 'terceirizado' || strtolower (trim($usuario-&gt;getTipodeUsuario())) == 'outros'){
								continue;
							}
							unset($listaDeTipos[$chave]);
							continue;
						}
						unset($listaDeTipos[$chave]);
							
					}
					if(isset($_GET['salvar'])){
						foreach($listaDeTipos as $tipo){
							if($tipo-&gt;getId() == $_GET['id_tipo'])
								$esseTipo = $tipo;	
						}
						$vinculo = new Vinculo();
						$daqui3Meses = date ( 'Y-m-d', strtotime ( &quot;+60 days&quot; ) ) . 'T' . date ( 'G:00:01' );
						$vinculo-&gt;setFinalValidade($daqui3Meses);
						$vinculo-&gt;getCartao()-&gt;getTipo()-&gt;setId($tipo-&gt;getId());
						$vinculo-&gt;getCartao()-&gt;setNumero($_GET['numero_cartao2']);
						$vinculo-&gt;getResponsavel()-&gt;setIdBaseExterna(intval($usuario-&gt;getIdBaseExterna()));
						$vinculo-&gt;setInicioValidade(date ( &quot;Y-m-d G:i:s&quot; ));
						if($vinculoDao-&gt;usuarioJaTemVinculo($vinculo-&gt;getResponsavel())){
								echo '&lt;div class=&quot;borda&quot;&gt;';
								echo '&lt;p&gt;Esse usu&aacute;rio j&aacute; possui cart&atilde;o. Inative o cart&atilde;o atual para adicionar um novo.&lt;/p&gt;&lt;br&gt;';
								//echo '&lt;a href=&quot;?pagina=cartao&amp;cartaoselecionado=' .$vinculo-&gt;getCartao()-&gt;getId().'&quot;&gt;Clique aqui para ver&lt;/a&gt;';
								echo '&lt;/div&gt;';
								return;
	
						}
						if($vinculoDao-&gt;cartaoTemVinculo($vinculo-&gt;getCartao())){
							echo '&lt;div class=&quot;borda&quot;&gt;';
							echo '&lt;p&gt;O numero do cart&atilde;o digitado j&aacute; possui vinculo, utilize outro cart&atilde;o.&lt;/p&gt;&lt;br&gt;';
							echo '&lt;/div&gt;';
							echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=cartao&amp;selecionado=' . $vinculo-&gt;getResponsavel()-&gt;getIdBaseExterna() . '&amp;cartao=add&quot;&gt;';
							return;
						}
						
						if(isset($_POST['enviar_vinculo'])){
							
							if($vinculoDao-&gt;usuarioJaTemVinculo($vinculo-&gt;getResponsavel())){
								echo '&lt;div class=&quot;borda&quot;&gt;';
								echo '&lt;p&gt;Esse usu&aacute;rio j&aacute; possui cart&atilde;o. Invalide o cart&atilde;o atual para adicionar um novo.&lt;/p&gt;&lt;br&gt;';
								//echo '&lt;a href=&quot;?pagina=cartao&amp;cartaoselecionado=' .$vinculo-&gt;getCartao()-&gt;getId().'&quot;&gt;Clique aqui para ver&lt;/a&gt;';
								echo '&lt;/div&gt;';
								return;
						
							}
							if($vinculoDao-&gt;cartaoTemVinculo($vinculo-&gt;getCartao())){
								echo '&lt;div class=&quot;borda&quot;&gt;';
								echo '&lt;p&gt;O numero do cart&atilde;o digitado j&aacute; possui vinculo, utilize outro cart&atilde;o.&lt;/p&gt;&lt;br&gt;';
								echo '&lt;/div&gt;';
								return;
							}
							if($vinculoDao-&gt;adicionaVinculo ($vinculo)){
								$this-&gt;view-&gt;mostraSucesso(&quot;Vinculo Adicionado Com Sucesso. &quot;);
							}else{
								$this-&gt;view-&gt;mostraSucesso(&quot;Erro na tentativa de Adicionar V&iacute;nculo. &quot;);
								
							}
							echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;10; url=.\?pagina=cartao&amp;selecionado=' . $vinculo-&gt;getResponsavel()-&gt;getIdBaseExterna() . '&quot;&gt;';
							return;
						}
						
						$this-&gt;view-&gt;formConfirmacaoEnvioVinculo($usuario, $_GET['numero_cartao2'], $tipo);
					}else{
						$this-&gt;view-&gt;mostraFormAdicionarVinculo($listaDeTipos, $idDoSelecionado);
					}
					
				
				}
			}
			
			foreach($vinculos as $vinculoComIsencao)
				$vinculoDao-&gt;isencaoValidaDoVinculo($vinculoComIsencao);
			$podeRenovar = true;
			if(sizeof($vinculos)){
				$podeRenovar = false;
			}
			$vinculosVencidos = $vinculoDao-&gt;retornaVinculosVencidos($usuario);
			$vinculosALiberar = $vinculoDao-&gt;retornaVinculosFuturos($usuario);
			
			
			if(sizeof($vinculos)){
				echo '&lt;h2&gt;Vinculos ativos&lt;/h2&gt;';
				$this-&gt;view-&gt;mostraVinculos($vinculos);
			}
			if(sizeof($vinculosVencidos)){

				echo '&lt;h2&gt;Vinculos Vencidos&lt;/h2&gt;';
				$this-&gt;view-&gt;mostraVinculos($vinculosVencidos, $podeRenovar);
			}
			if(sizeof($vinculosALiberar)){
				echo '&lt;h2&gt;Vinculos A Liberar&lt;/h2&gt;';
				$this-&gt;view-&gt;mostraVinculos($vinculosALiberar, false);					
			}
			
		}
		

		if (isset ( $_GET ['nome'] )) {
			$usuarioDao = new UsuarioDAO();
			$listaDeUsuarios = $usuarioDao-&gt;pesquisaNoSigaa( $_GET ['nome']);
			$this-&gt;view-&gt;mostraResultadoBuscaDeUsuarios($listaDeUsuarios);
			$usuarioDao-&gt;fechaConexao();
		}
		
		
	}
	public function verificaSeAtivo(Usuario $usuario){
		if(strtolower (trim($usuario-&gt;getStatusServidor())) == 'ativo'){
			
			return true;
		}
		if(strtolower (trim($usuario-&gt;getStatusDiscente())) == 'ativo' || strtolower (trim($usuario-&gt;getStatusDiscente())) == 'ativo - formando' || strtolower (trim($usuario-&gt;getStatusDiscente())) == 'ativo - graduando'){
			return true;	
		}
		
		if(strtolower (trim($usuario-&gt;getTipodeUsuario())) == 'terceirizado' || strtolower (trim($usuario-&gt;getTipodeUsuario())) == 'outros'){
			return true;
		}

		return false;
	}
	
	
	
	
}



?&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>