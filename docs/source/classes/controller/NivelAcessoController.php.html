<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Classe utilizada para centralizar as demais Classes(DAO, Model, View, Util).
 * Esta classe ser&aacute; instaciada no index.php.
 * 
 * @author Jefferson Uchoa Ponte
 * @version 1.0
 * @copyright UNILAB - Universidade da Integracao Internacional da Lusofonia Afro-Brasileira.
 * @package Controle
 */
class NivelAcessoController {
	private $view;
	public static function main($nivelDeAcesso) {
		switch ($nivelDeAcesso) {
			case Sessao::NIVEL_ADMIN :
				$controller = new NivelAcessoController ();
				$controller-&gt;telaCartao ();
				break;
			case Sessao::NIVEL_POLIVALENTE :
				$controller = new NivelAcessoController ();
				$controller-&gt;telaCartao ();
				break;
			
			case Sessao::NIVEL_SUPER :
				$controller = new NivelAcessoController ();
				$controller-&gt;telaCartao ();
				break;
			default :
				UsuarioController::main ( $nivelDeAcesso );
				break;
		}
	}
	public function telaCartao() {
		$this-&gt;view = new NivelAcessoView ();
		echo '&lt;div class=&quot;conteudo&quot;&gt; &lt;div class = &quot;simpleTabs&quot;&gt;
		        &lt;ul class = &quot;simpleTabsNavigation&quot;&gt;
				
					&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Identifica&amp;ccedil;&amp;atilde;o&lt;/a&gt;&lt;/li&gt;
					&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Cadastro&lt;/a&gt;&lt;/li&gt;
					
		        &lt;/ul&gt;
		        &lt;div class = &quot;simpleTabsContent&quot;&gt;';
		
		$this-&gt;telaIdentificacao ();
		echo '	&lt;/div&gt;
						
						
				&lt;div class = &quot;simpleTabsContent&quot;&gt;';
		$this-&gt;telaCadastro ();
		echo '	&lt;/div&gt;		
						
		    &lt;/div&gt;&lt;/div&gt;';
		
	}
	public function telaIdentificacao() {
		$dao = new DAO ();
		if (isset ( $_GET ['usua_id'] ) &amp;&amp; isset ( $_GET ['novo_nivel'] )) {
			$usuarioDao = new UsuarioDAO ( $dao-&gt;getConexao () );
			$usuario = new Usuario ();
			$usuario-&gt;setIdBaseExterna ( $_GET ['usua_id'] );
			$usuarioDao-&gt;preenchePorIdBaseExterna ( $usuario );
			
			if (! isset ( $_POST ['certeza'] )) {
				$this-&gt;view-&gt;formAlteraNivel ( $usuario );
			} else {
				$usuario-&gt;setNivelAcesso ( $_GET ['novo_nivel'] );
				if ($usuarioDao-&gt;alteraNivelDeAcesso ( $usuario )) {
					$this-&gt;view-&gt;mostraSucesso ( &quot;N&iacute;vel Alterado com Sucesso!&quot; );
				} else {
					$this-&gt;view-&gt;mostraSucesso ( &quot;Erro na tentativa de alterar n&iacute;vel.&quot; );
				}
				echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=nivel_acesso&quot;&gt;';
			}
			return;
		}
		
		$this-&gt;view-&gt;formBuscaCartao ();
		
		if (isset ( $_GET ['numero_cartao'] )) {
			if (strlen ( $_GET ['numero_cartao'] ) &gt; 3) {
				
				$cartao = new Cartao ();
				$cartao-&gt;setNumero ( $_GET ['numero_cartao'] );
				$numeroCartao = $cartao-&gt;getNumero ();
				$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
				$sqlVerificaNumero = &quot;SELECT * FROM usuario 
					INNER JOIN vinculo
					ON vinculo.usua_id = usuario.usua_id
					LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
					LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id
					WHERE cartao.cart_numero = '$numeroCartao'
						&quot;;
				
				$result = $dao-&gt;getConexao ()-&gt;query ( $sqlVerificaNumero );
				$idCartao = 0;
				$usuario = new Usuario ();
				
				$tipo = new Tipo ();
				$vinculoDao = new VinculoDAO ( $dao-&gt;getConexao () );
				$vinculo = new Vinculo ();
				
				foreach ( $result as $linha ) {
					$idDoVinculo = $linha ['vinc_id'];
					$tipo-&gt;setNome ( $linha ['tipo_nome'] );
					$usuario-&gt;setNome ( $linha ['usua_nome'] );
					$usuario-&gt;setIdBaseExterna ( $linha ['id_base_externa'] );
					$idCartao = $linha ['cart_id'];
					$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
					$avulso = $linha ['vinc_avulso'];
					if ($avulso) {
						$usuario-&gt;setNome ( &quot;Avulso&quot; );
					}
					break;
				}
				if ($idCartao) {
					
					$vinculo-&gt;setId ( $idDoVinculo );
					$cartao-&gt;setId ( $idCartao );
					$vinculoDao-&gt;vinculoPorId ( $vinculo );
					
					echo '&lt;div class=&quot;borda&quot;&gt;&lt;h1&gt;' . ucwords ( strtolower ( htmlentities ( $usuario-&gt;getNome () ) ) ) . '. Tipo: ' . $tipo-&gt;getNome ();
					$strNivelAcesso = &quot;Padr&amp;atilde;o&quot;;
					switch ($vinculo-&gt;getResponsavel ()-&gt;getNivelAcesso ()) {
						case Sessao::NIVEL_ADMIN :
							$strNivelAcesso = &quot; Administrador&quot;;
							break;
						case Sessao::NIVEL_SUPER :
							$strNivelAcesso = &quot;Super Usu&amp;aacute;rio&quot;;
							break;
						case Sessao::NIVEL_GUICHE :
							$strNivelAcesso = &quot;Guich&amp;ecirc;&quot;;
							break;
						
						default :
							$strNivelAcesso = &quot;Padr&amp;atilde;o&quot;;
							break;
					}
					echo ' - Nivel de Acesso:  ' . $strNivelAcesso;
					
					echo '&lt;/h1&gt;';
					echo '&lt;a class=&quot;botao b-primario&quot; href=&quot;?pagina=nivel_acesso&amp;usua_id=' . $vinculo-&gt;getResponsavel ()-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_COMUM . '&quot;&gt;Tornar Padr&amp;atilde;o&lt;/a&gt;';
					echo '&lt;a class=&quot;botao b-sucesso&quot; href=&quot;?pagina=nivel_acesso&amp;usua_id=' . $vinculo-&gt;getResponsavel ()-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_GUICHE . '&quot;&gt;Tornar Guich&ecirc;&lt;/a&gt;';
					echo '&lt;a class=&quot;botao b-secundario&quot; href=&quot;?pagina=nivel_acesso&amp;usua_id=' . $vinculo-&gt;getResponsavel ()-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_CADASTRO . '&quot;&gt;Tornar Cadastro&lt;/a&gt;';
					echo '&lt;a class=&quot;botao b-sucesso&quot; href=&quot;?pagina=nivel_acesso&amp;usua_id=' . $vinculo-&gt;getResponsavel ()-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_ADMIN . '&quot;&gt;Tornar Administrador&lt;/a&gt;';
					echo '&lt;a class=&quot;botao b-erro&quot; href=&quot;?pagina=nivel_acesso&amp;usua_id=' . $vinculo-&gt;getResponsavel ()-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_RELATORIO . '&quot;&gt;Somente Relatorios&lt;/a&gt;';
					echo '&lt;a class=&quot;botao b-secundario&quot; href=&quot;?pagina=nivel_acesso&amp;usua_id=' . $vinculo-&gt;getResponsavel ()-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_CATRACA_VIRTUAL . '&quot;&gt;Tornar Catraca Virtual&lt;/a&gt;';
					
					$sessao = new Sessao ();
					if ($sessao-&gt;getNivelAcesso () == Sessao::NIVEL_SUPER)
						echo '&lt;a class=&quot;botao b-erro&quot; href=&quot;?pagina=nivel_acesso&amp;usua_id=' . $vinculo-&gt;getResponsavel ()-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_SUPER . '&quot;&gt;Tornar Super Usu&amp;aacute;rio&lt;/a&gt;';
					
					if (file_exists ( 'fotos/' . $usuario-&gt;getIdBaseExterna () . '.png' )) {
						
						echo '&lt;img width=&quot;300&quot; src=&quot;fotos/' . $usuario-&gt;getIdBaseExterna () . '.png&quot; /&gt;';
					}
					
					if (! $vinculo-&gt;isActive ()) {
						echo '&lt;p&gt;O vinculo n&atilde;o est&aacute; ativo &lt;/p&gt;&lt;br&gt;
								&lt;a href=&quot;?pagina=cartao&amp;numero_cartao=' . $_GET ['numero_cartao'] . '&amp;cartao_renovar=1&quot; class=&quot;botao&quot;&gt;Renovar&lt;/a&gt; ';
						
						if (isset ( $_GET ['cartao_renovar'] )) {
							if (isset ( $_POST ['certeza'] )) {
								$usuarioDao = new UsuarioDAO ();
								
								$usuarioDao-&gt;retornaPorIdBaseExterna ( $usuario );
								
								if ($vinculoDao-&gt;usuarioJaTemVinculo ( $usuario )) {
									$this-&gt;view-&gt;mostraSucesso ( &quot;Esse usu&aacute;rio j&aacute; possui v&iacute;nculo v&aacute;lido.&quot; );
									echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=cartao&amp;selecionado=' . $usuario-&gt;getIdBaseExterna () . '&quot;&gt;';
									return;
								}
								if ($vinculo-&gt;isAvulso ()) {
									
									$this-&gt;view-&gt;mostraSucesso ( &quot;N&atilde;o existe renova&ccedil;&atilde;o de v&iacute;nculos avulsos!&quot; );
									echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=cartao&amp;selecionado=' . $usuario-&gt;getIdBaseExterna () . '&quot;&gt;';
									return;
								}
								
								if (! $this-&gt;verificaSeAtivo ( $usuario )) {
									$this-&gt;view-&gt;mostraSucesso ( &quot;Esse usu&aacute;rio possui um problema quanto ao status!&quot; );
									echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=cartao&amp;selecionado=' . $usuario-&gt;getIdBaseExterna () . '&quot;&gt;';
									return;
								}
								
								$daqui3Meses = date ( 'Y-m-d', strtotime ( &quot;+60 days&quot; ) ) . 'T' . date ( 'G:00:01' );
								$vinculo-&gt;setFinalValidade ( $daqui3Meses );
								
								if ($vinculoDao-&gt;atualizaValidade ( $vinculo )) {
									$this-&gt;view-&gt;mostraSucesso ( &quot;V&iacute;nculo Atualizado com Sucesso!  &quot; );
								} else {
									$this-&gt;view-&gt;mostraSucesso ( &quot;Erro ao tentar renovar v&iacute;nculo.  &quot; );
								}
								echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=cartao&amp;selecionado=' . $usuario-&gt;getIdBaseExterna () . '&quot;&gt;';
								return;
							}
							
							$this-&gt;view-&gt;formConfirmacaoRenovarVinculo ();
						}
					}
					echo '
							
							
							&lt;/div&gt;';
				} else {
					
					echo '&lt;div class=&quot;borda&quot;&gt;&lt;h1&gt;Cart&atilde;o N&atilde;o possui V&iacute;nculo V&aacute;lido.&lt;/h1&gt;&lt;/div&gt;';
				}
			}
		}
	}
	public function telaCadastro() {
		$this-&gt;view-&gt;formBuscaUsuarios ();
		$dao = new DAO ();
		$usuarioDao2 = new UsuarioDAO ( $dao-&gt;getConexao () );
		if (isset ( $_GET ['id_usuario'] ) &amp;&amp; isset ( $_GET ['novo_nivel'] )) {
			
			$usuario = new Usuario ();
			$usuario-&gt;setIdBaseExterna ( $_GET ['id_usuario'] );
			$usuarioDao2-&gt;preenchePorIdBaseExterna ( $usuario );
			
			if (! isset ( $_POST ['certeza'] )) {
				
				$this-&gt;view-&gt;formAlteraNivel ( $usuario );
			} else {
				$usuario-&gt;setNivelAcesso ( $_GET ['novo_nivel'] );
				if ($usuarioDao2-&gt;alteraNivelDeAcesso ( $usuario )) {
					$this-&gt;view-&gt;mostraSucesso ( &quot;N&iacute;vel Alterado com Sucesso!&quot; );
				} else {
					$this-&gt;view-&gt;mostraSucesso ( &quot;Erro na tentativa de alterar n&iacute;vel.&quot; );
				}
				echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=nivel_acesso&amp;selecionado=' . $usuario-&gt;getIdBaseExterna () . '&quot;&gt;';
				return;
			}
			return;
		}
		if (isset ( $_GET ['selecionado'] )) {
			
			$idDoSelecionado = $_GET ['selecionado'];
			$usuarioDao = new UsuarioDAO ();
			$usuario = new Usuario ();
			$usuario-&gt;setIdBaseExterna ( $idDoSelecionado );
			
			$usuarioDao-&gt;retornaPorIdBaseExterna ( $usuario );
			
			$usuarioDao2-&gt;preenchePorIdBaseExterna ( $usuario );
			$this-&gt;view-&gt;mostraSelecionado ( $usuario );
			
			if ($usuario-&gt;getNivelAcesso () == null)
				return;
			echo '&lt;a class=&quot;botao b-primario&quot; href=&quot;?pagina=nivel_acesso&amp;id_usuario=' . $usuario-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_COMUM . '&quot;&gt;Tornar Padr&amp;atilde;o&lt;/a&gt;';
			echo '&lt;a class=&quot;botao b-erro&quot; href=&quot;?pagina=nivel_acesso&amp;id_usuario=' . $usuario-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_GUICHE . '&quot;&gt;Guiche&lt;/a&gt;';
			echo '&lt;a class=&quot;botao b-secundario&quot; href=&quot;?pagina=nivel_acesso&amp;id_usuario=' . $usuario-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_CADASTRO . '&quot;&gt;Somente Cadastro&lt;/a&gt;';
			echo '&lt;a class=&quot;botao b-sucesso&quot; href=&quot;?pagina=nivel_acesso&amp;id_usuario=' . $usuario-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_ADMIN . '&quot;&gt;Tornar Administrador&lt;/a&gt;';
			echo '&lt;a class=&quot;botao b-primario&quot; href=&quot;?pagina=nivel_acesso&amp;id_usuario=' . $usuario-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_POLIVALENTE . '&quot;&gt;Polivalente&lt;/a&gt;';
			echo '&lt;a class=&quot;botao b-erro&quot; href=&quot;?pagina=nivel_acesso&amp;id_usuario=' . $usuario-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_RELATORIO . '&quot;&gt;Somente Relatorios&lt;/a&gt;';
			echo '&lt;a class=&quot;botao b-secundario&quot; href=&quot;?pagina=nivel_acesso&amp;id_usuario=' . $usuario-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_CATRACA_VIRTUAL . '&quot;&gt;Catraca Virtual&lt;/a&gt;';
			$sessao = new Sessao ();
			if ($sessao-&gt;getNivelAcesso () == Sessao::NIVEL_SUPER)
				echo '&lt;a class=&quot;botao b-erro&quot; href=&quot;?pagina=nivel_acesso&amp;id_usuario=' . $usuario-&gt;getIdBaseExterna () . '&amp;novo_nivel=' . Sessao::NIVEL_SUPER . '&quot;&gt;Tornar Super Usu&amp;aacute;rio&lt;/a&gt;';
		}
		
		if (isset ( $_GET ['nome'] )) {
			$usuarioDao = new UsuarioDAO ();
			$listaDeUsuarios = $usuarioDao-&gt;pesquisaNoSigaa ( $_GET ['nome'] );
			$this-&gt;view-&gt;mostraResultadoBuscaDeUsuarios ( $listaDeUsuarios );
			$usuarioDao-&gt;fechaConexao ();
		}
	}
	public function verificaSeAtivo(Usuario $usuario) {
		if (strtolower ( trim ( $usuario-&gt;getStatusServidor () ) ) == 'ativo') {
			
			return true;
		}
		if (strtolower ( trim ( $usuario-&gt;getStatusDiscente () ) ) == 'ativo' || strtolower ( trim ( $usuario-&gt;getStatusDiscente () ) ) == 'ativo - formando' || strtolower ( trim ( $usuario-&gt;getStatusDiscente () ) ) == 'ativo - graduando') {
			return true;
		}
		
		if (strtolower ( trim ( $usuario-&gt;getTipodeUsuario () ) ) == 'terceirizado' || strtolower ( trim ( $usuario-&gt;getTipodeUsuario () ) ) == 'outros') {
			return true;
		}
		
		return false;
	}
}

?&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>