<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Classe utilizada para centralizar as demais Classes(DAO, Model, View, Util).
 * Esta classe ser&aacute; instaciada no index.php.
 * 
 * @author Jefferson Uchoa Ponte
 * @version 1.0
 * @copyright UNILAB - Universidade da Integracao Internacional da Lusofonia Afro-Brasileira.
 * @package Controle
 */
/**
 * Nesta Classe o usu&aacute;rio comum poder&aacute; visualizar suas opera&ccedil;&otilde;esno RU,
 * al&eacute;m do seu saldo.
 *
 * O operador autorizado tambem poder&aacute; realizar uma busca pelo numero do cart&atilde;o
 * e realizar essa consulta.
 */
class PessoalController {
	
	/**
	 * Vari&aacute;vel utilizada para instaciar a classe DAO.
	 *
	 * @var DAO
	 */
	private $dao;
	
	/**
	 * Vari&aacute;vel utilizada para instaciar a classe PessoalView.
	 *
	 * @var PessoalView
	 */
	private $view;
	
	/**
	 * Metodo principal utilizada para controlar o acesso a classe atrav&eacute;s do n&iacute;vel de acesso do usuario.
	 *
	 * @param Sessao $nivelDeAcesso
	 *        	Recebe uma Sess&atilde;o que cont&eacute;m o n&iacute;vel de acesso do usuario,
	 *        	esta Sess&atilde;o &eacute; iniciada na p&aacute;gina principal, durante o login do usuario.
	 */
	public static function main($nivelDeAcesso) {
		switch ($nivelDeAcesso) {
			case Sessao::NIVEL_ADMIN :
				$controller = new PessoalController ();
				$controller-&gt;consultarUsuario ();
				break;
			case Sessao::NIVEL_SUPER :
				$controller = new PessoalController ();
				$controller-&gt;consultarUsuario ();
				break;
			default :
				$controller = new PessoalController ();
				$controller-&gt;telaPessoal ();
				break;
		}
	}
	
	/**
	 * Fun&ccedil;&atilde;o contrutora da classe,
	 * na sua instacia &eacute; instanciado um Objeto DAO.
	 */
	public function PessoalController() {
		$this-&gt;dao = new DAO ();
	}
	
	/**
	 * Gera a tela para que o operador possa realizar uma consulta
	 * com o n&uacute;mero do cart&atilde;o do usu&aacute;rio.
	 */
	public function consultarUsuario() {
		$this-&gt;view = new PessoalView ();
		
		echo '	&lt;div class = &quot;simpleTabs&quot;&gt;
			        &lt;ul class = &quot;simpleTabsNavigation&quot;&gt;
						&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Identifica&amp;ccedil;&amp;atilde;o&lt;/a&gt;&lt;/li&gt;
			        &lt;/ul&gt;		        
				&lt;div class = &quot;simpleTabsContent&quot;&gt;';
		
		$this-&gt;view-&gt;formBuscaCartao ();
		
		if (isset ( $_GET ['numero_cartao'] )) {
			if (strlen ( $_GET ['numero_cartao'] ) &gt; 3) {
				
				$cartao = new Cartao ();
				$cartao-&gt;setNumero ( $_GET ['numero_cartao'] );
				$numeroCartao = $cartao-&gt;getNumero ();
				$dataTimeAtual = date ( &quot;Y-m-d G:i:s&quot; );
				$sqlVerificaNumero = &quot;SELECT * FROM usuario
				INNER JOIN vinculo
				ON vinculo.usua_id = usuario.usua_id
				LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
				LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id
				WHERE cartao.cart_numero = '$numeroCartao'
				&quot;;
				$result = $this-&gt;dao-&gt;getConexao ()-&gt;query ( $sqlVerificaNumero );
				$idCartao = 0;
				$usuario = new Usuario ();
				$tipo = new Tipo ();
				$vinculoDao = new VinculoDAO ( $this-&gt;dao-&gt;getConexao () );
				$vinculo = new Vinculo ();
				foreach ( $result as $linha ) {
					$idDoVinculo = $linha ['vinc_id'];
					$tipo-&gt;setNome ( $linha ['tipo_nome'] );
					$usuario-&gt;setNome ( $linha ['usua_nome'] );
					$usuario-&gt;setId ( $linha ['usua_id'] );
					$usuario-&gt;setIdBaseExterna ( $linha ['id_base_externa'] );
					$idCartao = $linha ['cart_id'];
					
					$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
					$avulso = $linha ['vinc_avulso'];
					if ($avulso) {
						$usuario-&gt;setNome ( &quot;Avulso&quot; );
					}
					break;
				}
				
				if ($idCartao) {
					
					$vinculo-&gt;setId ( $idDoVinculo );
					$cartao-&gt;setId ( $idCartao );
					$vinculoDao-&gt;vinculoPorId ( $vinculo );
					$imagem = null;
					
					if (file_exists ( 'fotos/' . $usuario-&gt;getIdBaseExterna () . '.png' )) {
						$imagem = $usuario-&gt;getIdBaseExterna ();
					} else {
						$imagem = &quot;sem-imagem&quot;;
					}
					
					if (! $vinculo-&gt;isActive ()) {
						echo '&lt;div id=&quot;pergunta&quot;&gt;';
						$this-&gt;view-&gt;formMensagem ( &quot;-erro&quot;, &quot;vinculo n&atilde;o est&aacute; ativo.&quot; );
						echo '	&lt;a href=&quot;?pagina=cartao&amp;numero_cartao=' . $_GET ['numero_cartao'] . '&amp;cartao_renovar=1&quot; class=&quot;botao&quot;&gt;Renovar&lt;/a&gt;
							&lt;/div&gt;';
						if (isset ( $_GET ['cartao_renovar'] )) {
							if (isset ( $_POST ['certeza'] )) {
								$usuarioDao = new UsuarioDAO ( $this-&gt;dao-&gt;getConexao () );
								
								$usuarioDao-&gt;retornaPorIdBaseExterna ( $usuario );
								
								if ($vinculoDao-&gt;usuarioJaTemVinculo ( $usuario )) {
									$this-&gt;view-&gt;formMensagem ( &quot;-ajuda&quot;, &quot;Esse usu&aacute;rio j&aacute; possui v&iacute;nculo v&aacute;lido.&quot; );
									echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=cartao&amp;selecionado=' . $usuario-&gt;getIdBaseExterna () . '&quot;&gt;';
									return;
								}
								if ($vinculo-&gt;isAvulso ()) {
									$this-&gt;view-&gt;formMensagem ( &quot;-ajuda&quot;, &quot;N&atilde;o existe renova&ccedil;&atilde;o de v&iacute;nculos avulsos!&quot; );
									echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=cartao&amp;selecionado=' . $usuario-&gt;getIdBaseExterna () . '&quot;&gt;';
									return;
								}
								
								if (! $this-&gt;verificaSeAtivo ( $usuario )) {
									$this-&gt;view-&gt;formMensagem ( &quot;-erro&quot;, &quot;Esse usu&aacute;rio possui um problema quanto ao status!&quot; );
									echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=.\?pagina=cartao&amp;selecionado=' . $usuario-&gt;getIdBaseExterna () . '&quot;&gt;';
									return;
								}
								
								$daqui3Meses = date ( 'Y-m-d', strtotime ( &quot;+60 days&quot; ) ) . 'T' . date ( 'G:00:01' );
								$vinculo-&gt;setFinalValidade ( $daqui3Meses );
								
								if ($vinculoDao-&gt;atualizaValidade ( $vinculo )) {
									$this-&gt;view-&gt;formMensagem ( &quot;-sucesso&quot;, &quot;V&iacute;nculo Atualizado com Sucesso!&quot; );
								} else {
									$this-&gt;view-&gt;formMensagem ( &quot;-erro&quot;, &quot;Erro ao tentar renovar v&iacute;nculo.&quot; );
								}
								echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;2; url=.\?pagina=cartao&amp;selecionado=' . $usuario-&gt;getIdBaseExterna () . '&quot;&gt;';
								return;
							}
							
							$this-&gt;view-&gt;formConfirmacaoRenovarVinculo ();
						}
					}
				} else {
					$this-&gt;view-&gt;formMensagem ( &quot;-erro&quot;, &quot;Cart&atilde;o N&atilde;o possui V&iacute;nculo V&aacute;lido.&quot; );
				}
			}
			$this-&gt;telaDeCreditos ( $usuario );
			$this-&gt;telaDeTransacoes ( $usuario );
		}
		
		echo '	&lt;/div&gt;
		    &lt;/div&gt;';
	}
	
	/**
	 * Tela que ser&aacute; exibida pelo usu&aacute;rio comum ao efetuar o login
	 * no sistema.
	 *
	 * Exibe um demosntrativo com as refei&ccedil;&otilde;es, os creditos e os d&eacute;bitos
	 * do Usu&aacute;rio.
	 */
	public function telaPessoal() {
		echo '&lt;div class = &quot;simpleTabs&quot;&gt;
			        &lt;ul class = &quot;simpleTabsNavigation&quot;&gt;
						&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Identifica&amp;ccedil;&amp;atilde;o&lt;/a&gt;&lt;/li&gt;
			        &lt;/ul&gt;
		        &lt;div class = &quot;simpleTabsContent&quot;&gt;';
		
		$usuario = new Usuario ();
		$sessao = new Sessao ();
		$usuarioDao = new UsuarioDAO ( $this-&gt;dao-&gt;getConexao () );
		$usuario-&gt;setId ( $sessao-&gt;getIdUsuario () );
		$usuarioDao-&gt;preenchePorId ( $usuario );
		$this-&gt;telaDeCreditos ( $usuario );
		$this-&gt;telaDeTransacoes ( $usuario );
		
		echo '	 &lt;/div&gt;&lt;/div&gt;';
	}
	
	/**
	 * Mostra uma tabela com o demonstrativo de transa&ccedil;&otilde;es do Usu&aacute;rio
	 *
	 * @param Usuario $usuario        	
	 */
	public function telaDeTransacoes(Usuario $usuario) {
		$idUsuario = $usuario-&gt;getId ();
		$result = $this-&gt;dao-&gt;getConexao ()-&gt;query ( &quot;SELECT * FROM transacao 
				INNER JOIN usuario ON usuario.usua_id = transacao.usua_id
				WHERE usua_id1 = $idUsuario
				ORDER BY tran_data
				 DESC LIMIT 200&quot; );
		echo '&lt;p&gt;&amp;Uacute;ltimas 200 transa&amp;ccedil;&amp;otilde;es&lt;/p&gt;';
		echo '&lt;table class=&quot;tabela borda-vertical zebrada texto-preto&quot;&gt;';
		echo '&lt;thead&gt;';
		echo '&lt;tr&gt;&lt;th&gt;Data/Hora&lt;/th&gt;&lt;th&gt;Valor&lt;/th&gt;&lt;th&gt;Descri&ccedil;&atilde;o&lt;/th&gt;&lt;th&gt;Operador&lt;/th&gt;&lt;/tr&gt;';
		echo '&lt;/thead&gt;';
		echo '&lt;tbody&gt;';
		$totalCarregado = 0;
		foreach ( $result as $linha ) {
			$time = strtotime ( $linha ['tran_data'] );
			
			echo '&lt;tr&gt;&lt;td&gt;' . date ( 'd/m/Y H:i:s', $time ) . '&lt;/td&gt;&lt;td&gt;R$' . number_format ( $linha ['tran_valor'], 2, ',', '.' ) . '&lt;/td&gt;&lt;td&gt;' . $linha ['tran_descricao'] . '&lt;td&gt;' . $linha ['usua_nome'] . '&lt;/td&gt;&lt;/td&gt;&lt;/tr&gt;';
			$totalCarregado += $linha ['tran_valor'];
		}
		echo '&lt;tr&gt;&lt;th&gt;Total Recarregado: &lt;/th&gt;&lt;th&gt;R$' . number_format ( $totalCarregado, 2, ',', '.' ) . '&lt;/th&gt;&lt;th&gt;-&lt;/th&gt;&lt;th&gt;-&lt;/th&gt;&lt;/tr&gt;';
		echo '&lt;/tbody&gt;';
		echo '&lt;/table&gt;';
	}
	
	/**
	 * Gera a tela com informa&ccedil;&otilde;es relativas ao consumo do Usu&aacute;rio.
	 * &eacute; verificado seus vinculos e a informa&ccedil;&atilde;o de cada um.
	 *
	 * @param Usuario $usuario        	
	 */
	public function telaDeCreditos(Usuario $usuario) {
		$vinculoDao = new VinculoDAO ( $this-&gt;dao-&gt;getConexao () );
		
		$vinculos = $vinculoDao-&gt;retornaVinculosValidosDeUsuario ( $usuario );
		
		if (count ( $vinculos ) &lt; 1) {
			echo &quot;&lt;p&gt;Nenhum cartao ativo&lt;/p&gt;&quot;;
		} else if (count ( $vinculos ) == 1) {
			echo '&lt;p&gt;V&iacute;nculo ativo:&lt;/p&gt;';
			$this-&gt;exibirVinculos ( $vinculos );
		} else if (count ( $vinculos ) &gt; 1) {
			echo '&lt;p&gt;V&iacute;nculos ativos&lt;/p&gt;';
			$this-&gt;exibirVinculos ( $vinculos );
		}
		
		$vinculos = array ();
		$vinculos = $vinculoDao-&gt;retornaVinculosVencidos ( $usuario );
		if (count ( $vinculos ) &lt; 1) {
			echo &quot;&lt;p&gt;Nenhum cartao Inativo&lt;/p&gt;&quot;;
		} else if (count ( $vinculos ) == 1 &amp;&amp; $vinculos [0]-&gt;isActive ()) {
			echo '&lt;p&gt;V&iacute;nculo Inativo:&lt;/p&gt;';
			
			$this-&gt;exibirVinculos ( $vinculos );
		}
	}
	
	/**
	 * Exibi todos os vinvulos do Usu&aacute;rio.
	 *
	 * @param Vinculo[] $vinculos        	
	 */
	public function exibirVinculos($vinculos) {
		foreach ( $vinculos as $vinculo ) {
			$this-&gt;exibirVinculo ( $vinculo );
		}
	}
	
	/**
	 * Exibe as informa&ccedil;&otilde;es do Vinculo.
	 *
	 * nesta tela ser&aacute; exibida as informa&ccedil;&otilde;es do Usu&aacute;rio e seus registro realizados no RU.
	 *	 
	 * @param Vinculo $vinculo        	
	 */
	public function exibirVinculo(Vinculo $vinculo) {
		if ($vinculo-&gt;isAvulso () &amp;&amp; ! $vinculo-&gt;isActive ()) {
			return;
		}
		echo '&lt;div class=&quot;borda&quot;&gt;';
		echo '&lt;p&gt;Usu&aacute;rio: ' . $vinculo-&gt;getResponsavel ()-&gt;getNome () . '&lt;/p&gt;';
		
		echo '&lt;p&gt;Cr&eacute;ditos: R$ ' . number_format ( $vinculo-&gt;getCartao ()-&gt;getCreditos (), 2, ',', '.' ) . '&lt;/p&gt;';
		echo '&lt;p&gt;N&uacute;mero do Cart&atilde;o:' . $vinculo-&gt;getCartao ()-&gt;getNumero () . '&lt;/p&gt;';
		$time = strtotime ( $vinculo-&gt;getInicioValidade () );
		echo '&lt;p&gt;In&iacute;cio da Validade: ' . date ( 'd/m/Y H:i:s', $time ) . '&lt;/p&gt;';
		
		if ($vinculo-&gt;isAvulso ()) {
			echo '&lt;p&gt;Cart&atilde;o Avulso&lt;/p&gt;';
		} else {
			echo '&lt;p&gt;Cart&atilde;o Pessoal&lt;/p&gt;';
		}
		
		if (isset ( $_GET ['id_refeicoes'] )) {
			$idTransacao = intval ( $_GET ['id_refeicoes'] );
			if ($vinculo-&gt;getId () == $idTransacao) {
				$sql = &quot;SELECT * FROM registro 
					INNER JOIN catraca ON registro.catr_id = catraca.catr_id
					INNER JOIN catraca_unidade ON catraca_unidade.catr_id = catraca.catr_id 
					INNER JOIN unidade ON catraca_unidade.unid_id = unidade.unid_id 
					WHERE vinc_id = $idTransacao 
					AND regi_data &gt; '2016-10-17 01:01:01' 
					ORDER BY regi_data DESC LIMIT 200&quot;;
				$result = $this-&gt;dao-&gt;getConexao ()-&gt;query ( $sql );
				echo '&lt;div class=&quot;borda&quot;&gt;';
				echo '&lt;p&gt;&amp;Uacute;ltimas 200 Refei&ccedil;&otilde;es com o Cart&atilde;o: &lt;/p&gt;
				&lt;p&gt;OBS: mostraremos as refei&amp;ccedil;&amp;otilde;es a partir de 17 de outubro de 2016 porque foi quando come&amp;ccedil;ou a funcionar o m&amp;oacute;dulo financeiro.&lt;/p&gt;
				';
				echo '&lt;table  class=&quot;tabela borda-vertical zebrada texto-preto&quot;&gt;';
				$total = 0;
				foreach ( $result as $linha ) {
					$time = strtotime ( $linha ['regi_data'] );
					
					echo '&lt;tr&gt;&lt;td&gt;' . date ( 'd/m/Y H:i:s', $time ) . '&lt;/td&gt;&lt;td&gt;R$' . number_format ( $linha ['regi_valor_pago'], 2, ',', '.' ) . '&lt;/td&gt;&lt;td&gt;' . $linha ['unid_nome'] . '&lt;/td&gt;&lt;/tr&gt;';
					$total += $linha ['regi_valor_pago'];
				}
				echo '&lt;tr&gt;&lt;th&gt;TOTAL Consumido: &lt;/th&gt;&lt;th&gt;R$' . number_format ( $total, 2, ',', '.' ) . '&lt;/th&gt;&lt;th&gt;-&lt;/th&gt;&lt;/tr&gt;';
				echo '&lt;/table&gt;';
				echo '&lt;/div&gt;';
			}
		}
		if (isset ( $_GET ['numero_cartao'] )) {
			echo '&lt;p&gt;&lt;a href=&quot;?pagina=pessoal&amp;id_refeicoes=' . $vinculo-&gt;getId () . '&amp;numero_cartao=' . $_GET ['numero_cartao'] . '&quot;&gt;Refeicoes&lt;/a&gt;&lt;/p&gt;';
		} else {
			echo '&lt;p&gt;&lt;a href=&quot;?pagina=pessoal&amp;id_refeicoes=' . $vinculo-&gt;getId () . '&quot;&gt;Refeicoes&lt;/a&gt;&lt;/p&gt;';
		}
		
		echo '&lt;/div&gt;';
	}
}

?&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>