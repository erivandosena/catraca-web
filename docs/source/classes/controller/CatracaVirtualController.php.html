<html>
    <head>
        <script
            type="text/javascript"
            src="../../../js/jquery-1.4.2.min.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shCore.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushJScript.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushPhp.js">
        </script>
        <script
            type="text/javascript"
            src="../../../syntax_highlighter/scripts/shBrushXml.js">
        </script>
        <link
            href="../../../syntax_highlighter/styles/shCore.css" rel="stylesheet"
            type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shCoreEclipse.css"
            rel="stylesheet" type="text/css"
        />
        <link
            href="../../../syntax_highlighter/styles/shThemeWordpress.css"
            rel="stylesheet" type="text/css"
        />
    </head>
    <body>
        <pre class="brush: php">&lt;?php
/**
 * Classe utilizada para centralizar as demais Classes(DAO, Model, View, Util).
 * Esta classe ser&aacute; instaciada no index.php.
 * 
 * @author Jefferson Uchoa Ponte
 * @version 1.0
 * @copyright UNILAB - Universidade da Integracao Internacional da Lusofonia Afro-Brasileira.
 * @package Controle
 */
/**
 * Nesta Classe est&atilde;o contidos os C&oacute;digos HTML
 * respons&aacute;veis por gerar os elementos e as telas da p&aacute;gina de Catraca Virtual.
 */
class CatracaVirtualController {
	
	/**
	 * Recebe o Objeto DAO.
	 *
	 * @var DAO
	 */
	private $dao;
	
	/**
	 * Recebe o Objeto CatracaVirutialController.
	 *
	 * @var CatracaVirtualController
	 */
	private $view;
	
	/**
	 * Recebe o valor do id da catraca selecionada.
	 * 
	 * @var int
	 */
	private $catracaSelecionada;
	
	/**
	 * Fun&ccedil;&atilde;o Construtora da classe,
	 * nela &eacute; instanciada um Objeto CatracaVirtualView.
	 */
	public function CatracaVirtualController() {
		$this-&gt;view = new CatracaVirtualView ();
	}
	
	/**
	 * Metodo principal utilizada para controlar o acesso a classe atrav&eacute;s do n&iacute;vel de acesso do usuario.
	 *
	 * @param Sessao $nivel
	 *        	Recebe uma Sess&atilde;o que cont&eacute;m o n&iacute;vel de acesso do usuario,
	 *        	esta Sess&atilde;o &eacute; iniciada na p&aacute;gina principal, durante o login do usuario.
	 */
	public static function main($nivel) {
		switch ($nivel) {
			case Sessao::NIVEL_SUPER :
				$gerador = new CatracaVirtualController ();
				$gerador-&gt;verificarSelecaoRU ();
				break;
			case Sessao::NIVEL_ADMIN :
				$gerador = new CatracaVirtualController ();
				$gerador-&gt;verificarSelecaoRU ();
				break;
			case Sessao::NIVEL_POLIVALENTE :
				$gerador = new CatracaVirtualController ();
				$gerador-&gt;verificarSelecaoRU ();
				break;
			case Sessao::NIVEL_CATRACA_VIRTUAL :
				$gerador = new CatracaVirtualController ();
				$gerador-&gt;verificarSelecaoRU ();
				break;
			default :
				UsuarioController::main ( $nivel );
				break;
		}
	}
	
	/**
	 * Esta fun&ccedil;&atilde;o chama o formul&aacute;rio para sele&ccedil;&atilde;o do RU,
	 * com o id da catraca fornecido pelo formul&aacute;rio &eacute; criada
	 * uma vari&aacute;vel de sess&atilde;o com o mesmo nome utilizada para identificar
	 * a catraca, onde posteriormente ser&atilde;o atribu&iacute;das os registros a ela.
	 */
	public function verificarSelecaoRU() {
		$this-&gt;dao = new DAO ();
		
		if (isset ( $_SESSION ['catraca_id'] )) {
			$this-&gt;paginaRegistroManual ();
		} else {
			if (isset ( $_POST ['catraca_id'] )) {
				$_SESSION ['catraca_id'] = intval ( $_POST ['catraca_id'] );
				echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;0; url=?pagina=gerador&quot;&gt;';
			}
			$this-&gt;selecionarRU ();
		}
	}
	
	/**
	 * Gera um formul&aacute;rio com as catracas virtuais cadastradas,
	 * retornadas do banco atrav&eacute;s de consulta.
	 */
	public function selecionarRU() {
		$unidadeDao = new UnidadeDAO ( $this-&gt;dao-&gt;getConexao () );
		$listaDeCatracas = $unidadeDao-&gt;retornaCatracasPorUnidade ();
		$this-&gt;view-&gt;formSelecionarRu ( $listaDeCatracas );
	}
	
	/**
	 * P&aacute;gin&aacute; tulizada para realizar a consulta ao usu&aacute;rio atrav&eacute;s do
	 * n&uacute;mero do cart&atilde;o, e verificar se est&aacute; apto a consumir no RU.
	 *
	 * Ela identifica o tipo de usu&aacute;rio, o vinculo e realiza o d&eacute;bito do
	 * cr&eacute;dito refetente ao consumo do usu&aacute;rio.
	 */
	public function paginaRegistroManual() {
		$tipoDao = new TipoDAO ( $this-&gt;dao-&gt;getConexao () );
		$catracaVirtualDao = new CatracaVirtualDAO ( $this-&gt;dao-&gt;getConexao () );
		$listaDeTipos = $tipoDao-&gt;retornaLista ();
		$tipoIsento = new Tipo ();
		
		// Consulta a catraca atrav&eacute;s do id fornecido pela $_SESSION['catraca_id'].
		$unidadeDao = new UnidadeDAO ( $this-&gt;dao-&gt;getConexao () );
		$catraca = new Catraca ();
		$catraca-&gt;setId ( $_SESSION ['catraca_id'] );
		$unidadeDao-&gt;preencheCatracaPorId ( $catraca );
		
		echo '&lt;div class=&quot;navegacao&quot;&gt; 
				&lt;div class = &quot;simpleTabs&quot;&gt;
			        &lt;ul class = &quot;simpleTabsNavigation&quot;&gt;					
						&lt;li&gt;&lt;a href=&quot;#&quot;&gt;Catraca Virtual&lt;/a&gt;&lt;/li&gt;	
			        &lt;/ul&gt;
				
			        &lt;div class = &quot;simpleTabsContent&quot;&gt;
				
						&lt;div id=&quot;catraca-virtual&quot; class=&quot;doze colunas borda&quot;&gt;';
		$turnoAtivo = false;
		$data = date ( &quot;Y-m-d G:i:s&quot; );
		$selectTurno = &quot;Select * FROM turno WHERE '$data' BETWEEN turno.turn_hora_inicio AND turno.turn_hora_fim&quot;;
		$result = $this-&gt;dao-&gt;getConexao ()-&gt;query ( $selectTurno );
		$descricao = &quot;N&atilde;o&quot;;
		foreach ( $result as $linha ) {
			$turnoAtivo = true;
			$descricao = $linha ['turn_descricao'];
			break;
		}
		
		echo '	&lt;div class=&quot;doze colunas conteudo centralizado titulo-com-borda&quot; &gt;
					&lt;div class=&quot;quatro colunas&quot;&gt;
					&lt;p id=&quot;hora&quot;&gt;' . date ( 'd/m/Y H:i:s' ) . '&lt;/p&gt;
					&lt;/div&gt;';
		
		if ($catraca-&gt;financeiroAtivo ()) {
			echo '		&lt;div class=&quot;quatro colunas fundo-verde1 texto-branco negrito&quot; &gt;
				 	&lt;p&gt;M&oacute;dulo Financeiro Habilitado&lt;/p&gt;
					&lt;/div&gt;';
		} else {
			echo '	&lt;div class=&quot;quatro colunas fundo-vermelho1 texto-branco negrito&quot; &gt;
				 	&lt;p&gt;M&oacute;dulo Financeiro Desabilitado&lt;/p&gt;
					&lt;/div&gt;';
		}
		
		echo '		&lt;div class=&quot;quatro colunas&quot;&gt;
					&lt;p&gt;Turno ' . $descricao . ' iniciado&lt;/p&gt;
					&lt;/div&gt;
				&lt;/div&gt;';
		
		$somatorio = 0;
		foreach ( $listaDeTipos as $tipo ) {
			$quantidades [] = $unidadeDao-&gt;totalGiroTurnoAtualNaoIsento ( $catraca, $tipo );
		}
		$isento = new Tipo ();
		$isento-&gt;setNome ( &quot;Isento&quot; );
		$listaDeTipos [] = $isento;
		$quantidades [] = $unidadeDao-&gt;totalGiroTurnoAtualIsento ( $catraca, $isento );
		
		$this-&gt;view-&gt;exibirQuantidadesDeCadaTipo ( $listaDeTipos, $quantidades, $catraca );
		
		$this-&gt;view-&gt;formBuscaCartao ();
		$idCatraca = $_SESSION ['catraca_id'];
		$custo = 0;
		$custo = $catracaVirtualDao-&gt;custoDaRefeicao ( $catraca );
		
		echo '
				
						&lt;/div&gt;';
		
		if (isset ( $_GET ['numero_cartao'] )) {
			if ($_GET ['numero_cartao'] == NULL || $_GET ['numero_cartao'] == &quot;&quot;)
				return;
			
			if (! ($turnoAtual = $catracaVirtualDao-&gt;retornaTurnoAtual ())) {
				$this-&gt;mensagemErro ( &quot;Fora do hor&amp;aacute;rio de refei&amp;ccedil;&amp;atilde;o&quot; );
				echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;2; url=?pagina=gerador&quot;&gt;';
				return;
			}
			
			$cartao = new Cartao ();
			$cartao-&gt;setNumero ( $_GET ['numero_cartao'] );
			$vinculo = new Vinculo ();
			$vinculo-&gt;setCartao ( $cartao );
			
			if (! $catracaVirtualDao-&gt;verificaVinculo ( $vinculo )) {
				// Aqui a gente tenta renovar se tiver vinculo proprio nesse cartao.
				$numeroCartao = $vinculo-&gt;getCartao ()-&gt;getNumero ();
				$sqlVerificaNumero = &quot;SELECT * FROM usuario
				INNER JOIN vinculo
				ON vinculo.usua_id = usuario.usua_id
				LEFT JOIN cartao ON cartao.cart_id = vinculo.cart_id
				LEFT JOIN tipo ON cartao.tipo_id = tipo.tipo_id
				WHERE cartao.cart_numero = '$numeroCartao'&quot;;
				$result = $this-&gt;dao-&gt;getConexao ()-&gt;query ( $sqlVerificaNumero );
				$idCartao = 0;
				$usuario = new Usuario ();
				$tipo = new Tipo ();
				
				$vinculo = new Vinculo ();
				$i = 0;
				foreach ( $result as $linha ) {
					$i ++;
					$idDoVinculo = $linha ['vinc_id'];
					$tipo-&gt;setNome ( $linha ['tipo_nome'] );
					$tipo-&gt;setValorCobrado ( $linha ['tipo_valor'] );
					$usuario-&gt;setNome ( $linha ['usua_nome'] );
					$usuario-&gt;setIdBaseExterna ( $linha ['id_base_externa'] );
					$idCartao = $linha ['cart_id'];
					
					$cartao-&gt;setId ( $idCartao );
					$cartao-&gt;setTipo ( $tipo );
					
					$vinculo-&gt;setAvulso ( $linha ['vinc_avulso'] );
					$avulso = $linha ['vinc_avulso'];
					if ($avulso) {
						$usuario-&gt;setNome ( &quot;Avulso&quot; );
					}
					$vinculo-&gt;setCartao ( $cartao );
					$vinculo-&gt;setId ( $idDoVinculo );
					$vinculo-&gt;setResponsavel ( $usuario );
					$usuarioDao = new UsuarioDAO ();
					$usuarioDao-&gt;retornaPorIdBaseExterna ( $vinculo-&gt;getResponsavel () );
					break;
				}
				
				$vinculoDao = new VinculoDAO ( $this-&gt;dao-&gt;getConexao () );
				if (($i != 0) &amp;&amp; ! $vinculoDao-&gt;usuarioJaTemVinculo ( $usuario ) &amp;&amp; ! $vinculo-&gt;isAvulso () &amp;&amp; $vinculo-&gt;getResponsavel ()-&gt;verificaSeAtivo ()) {
					
					$daqui3Meses = date ( 'Y-m-d', strtotime ( &quot;+90 days&quot; ) ) . 'T' . date ( 'G:00:01' );
					$vinculo-&gt;setFinalValidade ( $daqui3Meses );
					
					$vinculoDao-&gt;atualizaValidade ( $vinculo );
				} else {
					
					$this-&gt;mensagemErro ( &quot;Verifique o vinculo deste cart&atilde;o!&quot; );
					echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;3; url=?pagina=gerador&quot;&gt;';
					return;
				}
			}
			
			if (! $catracaVirtualDao-&gt;podeContinuarComendo ( $vinculo, $turnoAtual )) {
				$this-&gt;mensagemErro ( &quot;Usu&aacute;rio j&aacute; passou neste turno!&quot; );
				echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;3; url=?pagina=gerador&quot;&gt;';
				return;
			}
			
			if ($catracaVirtualDao-&gt;vinculoEhIsento ( $vinculo )) {
				$valorPago = 0;
			} else {
				$valorPago = $vinculo-&gt;getCartao ()-&gt;getTipo ()-&gt;getValorCobrado ();
				if (($vinculo-&gt;getCartao ()-&gt;getCreditos () &lt; $valorPago) &amp;&amp; $catraca-&gt;financeiroAtivo ()) {
					
					$this-&gt;mensagemErro ( &quot;Usu&aacute;rio cr&eacute;ditos insuficiente. &quot; );
					echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;4; url=?pagina=gerador&quot;&gt;';
					return;
				}
			}
			
			$idCartao = $cartao-&gt;getId ();
			$strNome = $vinculo-&gt;getResponsavel ()-&gt;getNome ();
			
			if (isset ( $_GET ['confirmado'] )) {
				
				$idVinculo = $vinculo-&gt;getId ();
				
				if ($catraca-&gt;financeiroAtivo ()) {
					
					$this-&gt;dao-&gt;getConexao ()-&gt;beginTransaction ();
					$novoValor = floatval ( $vinculo-&gt;getCartao ()-&gt;getCreditos () ) - floatval ( $valorPago );
					$sql0 = &quot;UPDATE cartao set cart_creditos = $novoValor WHERE cart_id = $idCartao&quot;;
					
					if (! $this-&gt;dao-&gt;getConexao ()-&gt;exec ( $sql0 )) {
						$this-&gt;dao-&gt;getConexao ()-&gt;rollBack ();
						$this-&gt;mensagemErro ();
						
						echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;2; url=?pagina=gerador&quot;&gt;';
						return;
					}
					
					$sql = &quot;INSERT into registro(regi_data, regi_valor_pago, regi_valor_custo, catr_id, cart_id, vinc_id)
					VALUES('$data', $valorPago, $custo, $idCatraca, $idCartao, $idVinculo)&quot;;
					// echo $sql;
					
					if (! $this-&gt;dao-&gt;getConexao ()-&gt;exec ( $sql )) {
						$this-&gt;dao-&gt;getConexao ()-&gt;rollBack ();
						
						$this-&gt;mensagemErro ();
						
						echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;2; url=?pagina=gerador&quot;&gt;';
						return;
					} else {
						$this-&gt;dao-&gt;getConexao ()-&gt;commit ();
						$this-&gt;mensagemSucesso ();
						$_SESSION ['confirmado'] = &quot;confirmado&quot;;
						unset ( $_SESSION ['id_base_externa'] );
						unset ( $_SESSION ['numero_cartao'] );
						unset ( $_SESSION ['nome_usuario'] );
						unset ( $_SESSION ['tipo_usuario'] );
						unset ( $_SESSION ['refeicoes_restante'] );
						echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;2; url=?pagina=gerador&quot;&gt;';
					}
				} else {
					
					$sql = &quot;INSERT into registro(regi_data, regi_valor_pago, regi_valor_custo, catr_id, cart_id, vinc_id)
					VALUES('$data', $valorPago, $custo, $idCatraca, $idCartao, $idVinculo)&quot;;
					// echo $sql;
					if ($this-&gt;dao-&gt;getConexao ()-&gt;exec ( $sql )) {
						$this-&gt;mensagemSucesso ();
					} else {
						$this-&gt;mensagemErro ();
					}
					$_SESSION ['confirmado'] = &quot;confirmado&quot;;
					unset ( $_SESSION ['id_base_externa'] );
					unset ( $_SESSION ['numero_cartao'] );
					unset ( $_SESSION ['nome_usuario'] );
					unset ( $_SESSION ['tipo_usuario'] );
					unset ( $_SESSION ['refeicoes_restante'] );
					
					echo '&lt;meta http-equiv=&quot;refresh&quot; content=&quot;2; url=?pagina=gerador&quot;&gt;';
				}
			} 

			else {
				
				$strNome = $vinculo-&gt;getResponsavel ()-&gt;getNome ();
				$imagem = $vinculo-&gt;getResponsavel ()-&gt;getIdBaseExterna ();
				
				/*
				 * =======================================================
				 * Vari�vei de sess�o para a p�gina identidicador_cliente
				 * ======================================================
				 */
				$_SESSION ['id_base_externa'] = $imagem;
				$_SESSION ['numero_cartao'] = $_GET ['numero_cartao'];
				$_SESSION ['nome_usuario'] = $strNome;
				$_SESSION ['tipo_usuario'] = $cartao-&gt;getTipo ()-&gt;getNome ();
				$_SESSION ['confirmado'] = &quot;aguarde&quot;;
				$_SESSION ['refeicoes_restante'] = &quot;&quot;;
				/* ======================================================= */
				
				echo '	&lt;div class=&quot;borda doze colunas&quot;&gt;
										
						&lt;div class=&quot;doze colunas dados-usuario&quot;&gt;							
							&lt;div class=&quot;nove colunas&quot;&gt;
								&lt;div id=&quot;informacao&quot; class=&quot;fundo-cinza1&quot;&gt;
										&lt;div id=&quot;dados&quot; class=&quot;dados&quot;&gt;';
				if ($vinculo-&gt;isAvulso ()) {
					echo '&lt;p&gt;Cart&atilde;o Avulso: &lt;strong&gt;' . $_SESSION ['nome_usuario'] = $vinculo-&gt;getDescricao () . '&lt;/strong&gt;&lt;/p&gt;';
					echo '&lt;p&gt;Refei&ccedil;&otilde;es Restantes:&lt;strong&gt;' . $_SESSION ['refeicoes_restante'] = $vinculo-&gt;getRefeicoesRestantes () . ' &lt;/strong&gt;&lt;/p&gt;';
				} else {
					echo '&lt;p&gt;Usu&aacute;rio: &lt;strong&gt;' . $strNome . '&lt;/strong&gt; - ' . $cartao-&gt;getTipo ()-&gt;getNome () . '&lt;/p&gt;';
					echo '&lt;p&gt;Refei&ccedil;&otilde;es Restantes:&lt;strong&gt; ' . $_SESSION ['refeicoes_restante'] = $vinculo-&gt;getRefeicoesRestantes () . ' &lt;/strong&gt;&lt;/p&gt;';
				}
				
				if ($catraca-&gt;financeiroAtivo ())
					echo '&lt;p&gt;Cr&eacute;ditos restante: &lt;strong&gt;R$ ' . number_format ( $vinculo-&gt;getCartao ()-&gt;getCreditos (), 2, ',', '.' ) . '&lt;/strong&gt;&lt;/p&gt;';
				if ($vinculo-&gt;getIsencao ()-&gt;isActive ()) {
					echo '&lt;p&gt;Usu&aacute;rio Isento&lt;/p&gt;';
					$_SESSION ['tipo_usuario'] = &quot;Usuario Isento&quot;;
				} else {
					echo '&lt;p&gt;Valor Cobrado: &lt;strong&gt;R$' . number_format ( $valorPago, 2, ',', '.' ) . '&lt;/strong&gt;&lt;/p&gt;';
				}
				echo '					&lt;/div&gt;
								
						&lt;a href=&quot;?pagina=gerador&amp;numero_cartao=' . $_GET ['numero_cartao'] . '&amp;confirmado=1&quot; class=&quot;botao b-sucesso no-centro&quot;&gt;Confimar&lt;/a&gt;
								&lt;/div&gt;
						
								
						
							&lt;/div&gt;
							&lt;div class=&quot;tres colunas zoom&quot;&gt;
								&lt;img id=&quot;imagem&quot; src=&quot;fotos/' . $imagem . '.png&quot; alt=&quot;&quot;&gt;
							&lt;/div&gt;
						&lt;/div&gt;
					&lt;/div&gt;';
			}
		}
		echo '&lt;/div&gt;
				&lt;/div&gt;';
	}
	
	/**
	 * Exibi uma mesnagem de sucesso.
	 */
	public function mensagemSucesso() {
		echo '&lt;div class=&quot;doze colunas borda centralizado&quot;&gt;
		
										&lt;div class=&quot;alerta-sucesso&quot;&gt;
										    &lt;div class=&quot;icone icone-download ix24&quot;&gt;&lt;/div&gt;
										    &lt;div class=&quot;titulo-alerta&quot;&gt;Ok&lt;/div&gt;
										    &lt;div class=&quot;subtitulo-alerta&quot;&gt;Dados enviados com sucesso!&lt;/div&gt;
										&lt;/div&gt;
		
									&lt;/div&gt;';
	}
	
	/**
	 * Exibi uma messagem de erro.
	 *
	 * @param string $strMensagem
	 *        	Mensagem exibida ao Usuario.
	 */
	public function mensagemErro($strMensagem = null) {
		if ($strMensagem == null)
			$strMensagem = &quot;Erro na tentativa de inserir os dados!&quot;;
		echo '&lt;div class=&quot;doze colunas borda centralizado&quot;&gt;
	
										&lt;div class=&quot;alerta-erro&quot;&gt;
										    &lt;div class=&quot;icone icone-fire ix24&quot;&gt;&lt;/div&gt;
										    &lt;div class=&quot;titulo-alerta&quot;&gt;' . $strMensagem . '&lt;/div&gt;
										    &lt;div class=&quot;subtitulo-alerta&quot;&gt;Erro!&lt;/div&gt;
										&lt;/div&gt;
	
									&lt;/div&gt;';
	}
}

?&gt;</pre>
        <script type="text/javascript">
             SyntaxHighlighter.all();
             jQuery('.gutter div').each(function(key, data){
                jQuery(data).prepend('<a name="L'+jQuery(data).text()+'"/>');
             });
        </script>
    </body>
</html>